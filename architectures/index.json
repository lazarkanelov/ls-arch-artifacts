{
  "version": 1,
  "architectures": {
    "simple_s3_test": {
      "hash": "simple_s3_test",
      "source_url": "local://simple_s3_test",
      "source_type": "custom",
      "discovered_at": "2026-01-10T17:33:22.095168",
      "services": [
        "s3"
      ],
      "resource_count": 2,
      "name": "Simple S3 Test",
      "description": "Simple standalone S3 bucket for local validation testing",
      "version": "1.0.0",
      "skipped": false,
      "skip_reason": null,
      "original_format": "terraform",
      "terraform_files": {},
      "has_app": true
    },
    "5f63fc2a95796608": {
      "hash": "5f63fc2a95796608",
      "source_url": "https://registry.terraform.io/modules/ViktorUJ/vpc/aws/1.1.0",
      "source_type": "terraform_registry",
      "discovered_at": "2026-01-10T20:16:17.211786",
      "services": [
        "ec2"
      ],
      "resource_count": 28,
      "name": "ViktorUJ/vpc",
      "description": "Terraform Module that defines a VPC with public/private subnets across multiple AZs with Internet Gateways",
      "version": "1.1.0",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "data.tf": "data \"aws_availability_zones\" \"available\" {}\n",
        "examples/custom/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name                  = \"test-vpc\"\n    cidr                  = \"10.10.0.0/16\"\n    secondary_cidr_blocks = [\"10.2.0.0/16\", \"10.3.0.0/16\"]\n    tags                  = { \"cost_center\" = \"444\" }\n    dhcp_options = {\n      ipv6_address_preferred_lease_time = \"2147483647\"\n    }\n    nacl_default = {\n      test = {\n        egress      = \"true\"\n        rule_number = \"99\"\n        rule_action = \"allow\"\n        protocol    = \"tcp\"\n        cidr_block  = \"0.0.0.0/0\"\n\n\n      }\n      test2 = {\n        egress      = \"false\"\n        rule_number = \"99\"\n        rule_action = \"allow\"\n        protocol    = \"tcp\"\n        cidr_block  = \"0.0.0.0/0\"\n\n\n      }\n    }\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name                                = \"public-subnet-1\"\n        cidr                                = \"10.10.1.0/24\"\n        az                                  = \"eun1-az1\"\n        type                                = \"qa-test\"\n        tags                                = { \"cost_center\" = \"5555\" }\n        private_dns_hostname_type_on_launch = \"resource-name\"\n        nacl = {\n          test = {\n            egress      = \"true\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          test2 = {\n            egress      = \"false\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          allow_all_inbound = {\n            egress      = \"false\"\n            rule_number = \"9999\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          allow_all_outbound = {\n            egress      = \"true\"\n            rule_number = \"8888\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n\n\n        }\n      }\n      \"pub2\" = {\n        name        = \"public-subnet-2\"\n        cidr        = \"10.10.2.0/24\"\n        az          = \"eun1-az3\"\n        type        = \"Devops\"\n        nat_gateway = \"DEFAULT\"\n        tags        = { \"cost_center\" = \"1234\" }\n\n      }\n\n    }\n    private = {\n      \"private_no_nat\" = {\n        name                                = \"private-subnet-1\"\n        cidr                                = \"10.10.33.0/24\"\n        az                                  = \"eun1-az1\"\n        type                                = \"qa-test\"\n        tags                                = { \"cost_center\" = \"5555\" }\n        private_dns_hostname_type_on_launch = \"resource-name\"\n        nat_gateway                         = \"NONE\"\n        nacl = {\n          test = {\n            egress      = \"true\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          test2 = {\n            egress      = \"false\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n      }\n\n      \"private1\" = {\n        name                                = \"private-subnet-1\"\n        cidr                                = \"10.10.11.0/24\"\n        az                                  = \"eun1-az1\"\n        type                                = \"qa-test\"\n        tags                                = { \"cost_center\" = \"5555\" }\n        private_dns_hostname_type_on_launch = \"resource-name\"\n        nat_gateway                         = \"SINGLE\"\n        nacl = {\n          test = {\n            egress      = \"true\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          test2 = {\n            egress      = \"false\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n\n\n      }\n      \"private2\" = {\n        name        = \"private-subnet-2\"\n        cidr        = \"10.10.12.0/24\"\n        az          = \"eun1-az3\"\n        type        = \"Devops\"\n        tags        = { \"cost_center\" = \"1234\" }\n        nat_gateway = \"SINGLE\"\n\n      }\n      \"private3\" = {\n        name        = \"private-subnet-3\"\n        cidr        = \"10.10.13.0/24\"\n        az          = \"eu-north-1a\"\n        type        = \"Devops\"\n        tags        = { \"cost_center\" = \"1234\" }\n        nat_gateway = \"SINGLE\"\n\n      }\n      \"private4\" = {\n        name        = \"private-subnet-4\"\n        cidr        = \"10.10.14.0/24\"\n        az          = \"eun1-az3\"\n        type        = \"Devops\"\n        tags        = { \"cost_center\" = \"1234\" }\n        nat_gateway = \"SINGLE\"\n\n      }\n\n      \"k8s1\" = {\n        name        = \"private-k8s-1\"\n        cidr        = \"10.10.15.0/24\"\n        az          = \"eun1-az3\"\n        type        = \"k8s\"\n        tags        = { \"cost_center\" = \"1234\" }\n        nat_gateway = \"SINGLE\"\n\n      }\n      \"k8s2\" = {\n        name        = \"private-k8s-2\"\n        cidr        = \"10.10.16.0/24\"\n        az          = \"eun1-az3\"\n        type        = \"k8s\"\n        tags        = { \"cost_center\" = \"1234\" }\n        nat_gateway = \"SINGLE\"\n\n\n      }\n\n    }\n\n\n  }\n\n}\n",
        "examples/custom/output.tf": "# inputs\noutput \"tags_default\" {\n  description = \"Default tags\"\n  value       = module.vpc.tags_default\n}\n\noutput \"subnets_var\" {\n  description = \"for test\"\n  value       = module.vpc.subnets_var\n}\noutput \"vpc_var\" {\n  value = module.vpc.vpc_var\n}\n\n# vpc\noutput \"vpc_raw\" {\n  value = module.vpc.vpc_raw\n}\n\n\n\n# debug\noutput \"az_mapping\" {\n  value = module.vpc.az_mapping\n}\n\n\n#subnets public\n\noutput \"normalized_public_subnets_all\" {\n  value = module.vpc.normalized_public_subnets_all\n}\n\noutput \"subnets_public_raw\" {\n  value = module.vpc.subnets_public_raw\n}\noutput \"public_subnets_by_type\" {\n  value = module.vpc.public_subnets_by_type\n}\n\noutput \"public_subnets_by_az\" {\n  value = module.vpc.public_subnets_by_az\n}\n\noutput \"public_subnets_by_az_id\" {\n  value = module.vpc.public_subnets_by_az_id\n}\n#subnets private\noutput \"normalized_private_subnets_all\" {\n  value = module.vpc.normalized_private_subnets_all\n}\n\noutput \"subnets_private_raw\" {\n  value = module.vpc.subnets_private_raw\n}\n\noutput \"private_subnets_by_type\" {\n  value = module.vpc.private_subnets_by_type\n}\n\noutput \"private_subnets_by_az\" {\n  value = module.vpc.private_subnets_by_az\n}\n\noutput \"private_subnets_by_az_id\" {\n  value = module.vpc.private_subnets_by_az_id\n}\n\n# NACL\noutput \"public_nacl_raw\" {\n  value = module.vpc.public_nacl_raw\n\n}\noutput \"public_nacl_rules_raw\" {\n  value = module.vpc.public_nacl_rules_raw\n}\n\noutput \"private_nacl_raw\" {\n  value = module.vpc.private_nacl_raw\n}\noutput \"private_nacl_rules_raw\" {\n  value = module.vpc.private_nacl_rules_raw\n}\n\n# NAT Gateway\n\noutput \"nat_gateway_single_raw\" {\n  value = module.vpc.nat_gateway_single_raw\n}\n\noutput \"nat_gateway_subnet_raw\" {\n  value = module.vpc.nat_gateway_subnet_raw\n}\n\noutput \"nat_gateway_az_raw\" {\n  value = module.vpc.nat_gateway_az_raw\n}\n\n# Route Table\noutput \"route_table_private_raw\" {\n  value = module.vpc.route_table_private_raw\n}\n\noutput \"route_table_public_raw\" {\n  value = module.vpc.route_table_public_raw\n}\n\n\n# EXAMPLES\n\noutput \"vpc_id\" {\n  value = module.vpc.vpc_raw.id\n}\n\noutput \"vpc_cidr_block\" {\n  value = module.vpc.vpc_raw.cidr_block\n}\n\noutput \"k8s_private_subnets\" {\n  description = \"K8s private subnets\"\n  value       = module.vpc.private_subnets_by_type.k8s.ids\n}\n\noutput \"private_subnets_az_id\" {\n  description = \"privare subnets in AZ iD eun1-az3\"\n  value       = module.vpc.private_subnets_by_az_id.eun1-az3\n}\n\noutput \"private_subnets_az\" {\n  description = \"privare subnets in AZ eu-north-1a\"\n  value       = module.vpc.private_subnets_by_az.eu-north-1a\n}\n",
        "examples/nacl_default/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n    nacl_default = {\n      test = {\n        egress      = \"true\"\n        rule_number = \"99\"\n        rule_action = \"allow\"\n        protocol    = \"tcp\"\n        cidr_block  = \"0.0.0.0/0\"\n\n\n      }\n      test2 = {\n        egress      = \"false\"\n        rule_number = \"99\"\n        rule_action = \"allow\"\n        protocol    = \"tcp\"\n        cidr_block  = \"0.0.0.0/0\"\n\n\n      }\n    }\n  }\n\n  subnets = {\n    public  = {}\n    private = {}\n\n  }\n}\n",
        "examples/nacl_default/output.tf": "output \"vpc_raw\" {\n  value = module.vpc.vpc_raw\n}\n\noutput \"nacl_default_rules_raw\" {\n  value = module.vpc.nacl_default_rules_raw\n}\n",
        "examples/nacl_subnet/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name = \"public-subnet-1\"\n        cidr = \"10.10.1.0/24\"\n        az   = \"eu-north-1a\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1a\"\n      }\n\n    }\n    private = {\n\n      \"private1\" = {\n        name = \"private-subnet-1\"\n        cidr = \"10.10.11.0/24\"\n        az   = \"eu-north-1a\"\n        nacl = {\n          test = {\n            egress      = \"true\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          test2 = {\n            egress      = \"false\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          allow_all_inbound = {\n            egress      = \"false\"\n            rule_number = \"9999\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          allow_all_outbound = {\n            egress      = \"true\"\n            rule_number = \"8888\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n\n\n        }\n\n      }\n      \"private2\" = {\n        name = \"private-subnet-2\"\n        cidr = \"10.10.12.0/24\"\n        az   = \"eu-north-1a\"\n        nacl = {\n          test = {\n            egress      = \"true\"\n            rule_number = \"99\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          ssh = {\n            egress      = \"false\"\n            rule_number = \"88\"\n            rule_action = \"allow\"\n            protocol    = \"tcp\"\n            from_port   = \"22\"\n            to_port     = \"22\"\n            cidr_block  = \"0.0.0.0/0\"\n\n          }\n          allow_all_inbound = {\n            egress      = \"false\"\n            rule_number = \"9999\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          allow_all_outbound = {\n            egress      = \"true\"\n            rule_number = \"8888\"\n            rule_action = \"allow\"\n            from_port   = \"0\"\n            to_port     = \"0\"\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n\n\n        }\n      }\n    }\n  }\n}\n",
        "examples/nacl_subnet/output.tf": "output \"private_nacl_raw\" {\n  value = module.vpc.private_nacl_raw\n}\n\noutput \"private_nacl_rules_raw\" {\n  value = module.vpc.private_nacl_rules_raw\n}\n",
        "examples/nat_gateway_az/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name = \"public-subnet-1\"\n        cidr = \"10.10.1.0/24\"\n        az   = \"eu-north-1a\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1b\"\n      }\n\n    }\n    private = {\n\n      \"private1\" = {\n        name        = \"private-subnet-1\"\n        cidr        = \"10.10.11.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"AZ\" # it is default . you can remove it\n\n      }\n      \"private2\" = {\n        name = \"private-subnet-2\"\n        cidr = \"10.10.12.0/24\"\n        az   = \"eu-north-1a\"\n        #       nat_gateway                         = \"AZ\"  # it is default . you can remove it\n      }\n      \"private3\" = {\n        name = \"private-subnet-3\"\n        cidr = \"10.10.13.0/24\"\n        az   = \"eu-north-1b\"\n        #       nat_gateway                         = \"AZ\"  # it is default . you can remove it\n      }\n      \"private4\" = {\n        name = \"private-subnet-4\"\n        cidr = \"10.10.14.0/24\"\n        az   = \"eu-north-1b\"\n        #       nat_gateway                         = \"AZ\"  # it is default . you can remove it\n      }\n\n\n    }\n  }\n}\n",
        "examples/nat_gateway_az/output.tf": "output \"nat_gateway_az_raw\" {\n  value = module.vpc.nat_gateway_az_raw\n}\n",
        "examples/nat_gateway_az_existing_eip/main.tf": "provider \"aws\" {\n  region = \"us-west-1\"\n}\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  # Using existing EIP IDs here\n  existing_eip_ids_az = {\n    \"us-west-1a\" = \"vpc-0a1b2c3d4e5f6g7h8\"\n    \"us-east-1b\" = \"vpc-0a1b2c3d4e5f6g7h8\"\n  }\n  vpc = {\n    name                  = \"main\"\n    cidr                  = \"10.2.0.0/16\"\n    secondary_cidr_blocks = [\"100.64.0.0/16\"]\n    instance_tenancy      = \"default\"\n    enable_dns_support    = true\n    enable_dns_hostnames  = false\n    tags_default = {\n      \"Environment\" = \"Dev\"\n      \"Name\"        = \"EKS-VPC\"\n      \"Owner\"       = \"DevOps\"\n    }\n    dhcp_options = {\n      domain_name          = \"\"\n      domain_name_servers  = []\n      ntp_servers          = []\n      netbios_name_servers = []\n      netbios_node_type    = \"\"\n    }\n  }\n\n  subnets = {\n    public = {\n      public1 = {\n        name                                           = \"public-1\"\n        cidr                                           = \"10.2.2.0/24\"\n        az                                             = \"us-west-1a\"\n        tags                                           = { \"Name\" = \"public-1\" }\n        type                                           = \"public\"\n        assign_ipv6_address_on_creation                = false\n        customer_owned_ipv4_pool                       = \"\"\n        enable_dns64                                   = false\n        enable_resource_name_dns_aaaa_record_on_launch = false\n        enable_resource_name_dns_a_record_on_launch    = false\n        ipv6_native                                    = false\n        map_customer_owned_ip_on_launch                = false\n        map_public_ip_on_launch                        = true\n        outpost_arn                                    = \"\"\n        private_dns_hostname_type_on_launch            = \"ip-name\"\n        nacl = {\n          default_ingress = {\n            egress      = false\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          default_egress = {\n            egress      = true\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n      }\n      public2 = {\n        name                                           = \"public-2\"\n        cidr                                           = \"10.2.3.0/24\"\n        az                                             = \"us-west-1b\"\n        tags                                           = { \"Name\" = \"public-2\" }\n        type                                           = \"public\"\n        assign_ipv6_address_on_creation                = false\n        customer_owned_ipv4_pool                       = \"\"\n        enable_dns64                                   = false\n        enable_resource_name_dns_aaaa_record_on_launch = false\n        enable_resource_name_dns_a_record_on_launch    = false\n        ipv6_native                                    = false\n        map_customer_owned_ip_on_launch                = false\n        map_public_ip_on_launch                        = true\n        outpost_arn                                    = \"\"\n        private_dns_hostname_type_on_launch            = \"ip-name\"\n        nacl = {\n          default_ingress = {\n            egress      = false\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          default_egress = {\n            egress      = true\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n      }\n    }\n    private = {\n      eks1 = {\n        name                                           = \"eks-control-plane-1\"\n        cidr                                           = \"10.2.0.0/24\"\n        az                                             = \"us-west-1a\"\n        tags                                           = {}\n        type                                           = \"private\"\n        assign_ipv6_address_on_creation                = false\n        customer_owned_ipv4_pool                       = \"\"\n        enable_dns64                                   = false\n        enable_resource_name_dns_aaaa_record_on_launch = false\n        enable_resource_name_dns_a_record_on_launch    = false\n        ipv6_native                                    = false\n        map_customer_owned_ip_on_launch                = false\n        map_public_ip_on_launch                        = false\n        outpost_arn                                    = \"\"\n        private_dns_hostname_type_on_launch            = \"ip-name\"\n        nacl = {\n          eks_default_ingress = {\n            egress      = false\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          eks_default_egress = {\n            egress      = true\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n      }\n      eks2 = {\n        name                                           = \"elk-control-plane-2\"\n        cidr                                           = \"10.2.1.0/24\"\n        az                                             = \"us-west-1b\"\n        tags                                           = {}\n        type                                           = \"private\"\n        assign_ipv6_address_on_creation                = false\n        customer_owned_ipv4_pool                       = \"\"\n        enable_dns64                                   = false\n        enable_resource_name_dns_aaaa_record_on_launch = false\n        enable_resource_name_dns_a_record_on_launch    = false\n        ipv6_native                                    = false\n        map_customer_owned_ip_on_launch                = false\n        map_public_ip_on_launch                        = false\n        outpost_arn                                    = \"\"\n        private_dns_hostname_type_on_launch            = \"ip-name\"\n        nacl = {\n          eks_default_ingress = {\n            egress      = false\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n          eks_default_egress = {\n            egress      = true\n            rule_number = 100\n            rule_action = \"allow\"\n            from_port   = 0\n            to_port     = 0\n            protocol    = \"-1\"\n            cidr_block  = \"0.0.0.0/0\"\n          }\n        }\n      }\n    }\n  }\n\n  tags_default = {\n    \"Environment\" = \"Dev\"\n    \"Name\"        = \"EKS-VPC\"\n    \"Owner\"       = \"DevOps\"\n  }\n}\n",
        "examples/nat_gateway_az_existing_eip/output.tf": "output \"nat_gateway_az_raw\" {\n  value = module.vpc.nat_gateway_az_raw\n}\n",
        "examples/nat_gateway_single/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name        = \"public-subnet-1\"\n        cidr        = \"10.10.1.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"DEFAULT\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1a\"\n      }\n\n    }\n    private = {\n\n      \"private1\" = {\n        name        = \"private-subnet-1\"\n        cidr        = \"10.10.11.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"SINGLE\"\n\n      }\n      \"private2\" = {\n        name        = \"private-subnet-2\"\n        cidr        = \"10.10.12.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"SINGLE\"\n      }\n      \"private3\" = {\n        name        = \"private-subnet-3\"\n        cidr        = \"10.10.13.0/24\"\n        az          = \"eu-north-1b\"\n        nat_gateway = \"SINGLE\"\n      }\n      \"private4\" = {\n        name        = \"private-subnet-4\"\n        cidr        = \"10.10.14.0/24\"\n        az          = \"eu-north-1b\"\n        nat_gateway = \"SINGLE\"\n      }\n\n\n    }\n  }\n}\n",
        "examples/nat_gateway_single/output.tf": "output \"nat_gateway_single_raw\" {\n  value = module.vpc.nat_gateway_single_raw\n}\n",
        "examples/nat_gateway_subnet/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name = \"public-subnet-1\"\n        cidr = \"10.10.1.0/24\"\n        az   = \"eu-north-1a\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1b\"\n      }\n\n    }\n    private = {\n\n      \"private1\" = {\n        name        = \"private-subnet-1\"\n        cidr        = \"10.10.11.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"SUBNET\"\n\n      }\n      \"private2\" = {\n        name        = \"private-subnet-2\"\n        cidr        = \"10.10.12.0/24\"\n        az          = \"eu-north-1a\"\n        nat_gateway = \"SUBNET\"\n      }\n      \"private3\" = {\n        name        = \"private-subnet-3\"\n        cidr        = \"10.10.13.0/24\"\n        az          = \"eu-north-1b\"\n        nat_gateway = \"SUBNET\"\n      }\n      \"private4\" = {\n        name        = \"private-subnet-4\"\n        cidr        = \"10.10.14.0/24\"\n        az          = \"eu-north-1b\"\n        nat_gateway = \"NONE\" # this subnet will not have NAT Gateway\n      }\n\n\n    }\n  }\n}\n",
        "examples/nat_gateway_subnet/output.tf": "output \"nat_gateway_subnet_raw\" {\n  value = module.vpc.nat_gateway_subnet_raw\n}\n",
        "examples/output_private_subnet_by_type/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name = \"public-subnet-1\"\n        cidr = \"10.10.1.0/24\"\n        az   = \"eu-north-1a\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1a\"\n      }\n\n    }\n    private = {\n\n      \"rds1\" = {\n        name = \"rds-subnet-1\"\n        cidr = \"10.10.11.0/24\"\n        az   = \"eu-north-1b\"\n        type = \"rds\"\n\n      }\n      \"rds2\" = {\n        name = \"rds-subnet-2\"\n        cidr = \"10.10.12.0/24\"\n        az   = \"eu-north-1a\"\n        type = \"rds\"\n      }\n      \"k8s1\" = {\n        name = \"rds-subnet-1\"\n        cidr = \"10.10.13.0/24\"\n        az   = \"eu-north-1a\"\n        type = \"k8s\"\n      }\n\n      \"k8s2\" = {\n        name = \"rds-subnet-2\"\n        cidr = \"10.10.14.0/24\"\n        az   = \"eu-north-1a\"\n        type = \"k8s\"\n      }\n      \"app1\" = {\n        name = \"app-subnet-1\"\n        cidr = \"10.10.16.0/24\"\n        az   = \"eu-north-1a\"\n        type = \"app\"\n      }\n      \"app2\" = {\n        name = \"app-subnet-2\"\n        cidr = \"10.10.15.0/24\"\n        az   = \"eu-north-1a\"\n        type = \"app\"\n      }\n\n\n    }\n  }\n}\n",
        "examples/output_private_subnet_by_type/output.tf": "output \"private_subnets_by_type\" {\n  value = module.vpc.private_subnets_by_type\n}\n\noutput \"k8s_subnets_id\" {\n  value = module.vpc.private_subnets_by_type.k8s.ids\n}\n\noutput \"rds_subnets_id\" {\n  value = module.vpc.private_subnets_by_type.rds.ids\n}\n\noutput \"app_subnets_id\" {\n  value = module.vpc.private_subnets_by_type.app.ids\n}\n",
        "examples/simple/main.tf": "provider \"aws\" {\n  region = \"eu-north-1\"\n}\n\n\nmodule \"vpc\" {\n  source = \"ViktorUJ/vpc/aws\"\n  tags_default = {\n    \"Owner\"       = \"DevOps Team\"\n    \"Terraform\"   = \"true\"\n    \"cost_center\" = \"1111\"\n  }\n  vpc = {\n    name = \"test-vpc\"\n    cidr = \"10.10.0.0/16\"\n  }\n\n  subnets = {\n    public = {\n      \"pub1\" = {\n        name = \"public-subnet-1\"\n        cidr = \"10.10.1.0/24\"\n        az   = \"eu-north-1a\"\n      }\n      \"pub2\" = {\n        name = \"public-subnet-2\"\n        cidr = \"10.10.2.0/24\"\n        az   = \"eu-north-1a\"\n      }\n\n    }\n    private = {\n\n      \"private1\" = {\n        name = \"private-subnet-1\"\n        cidr = \"10.10.11.0/24\"\n        az   = \"eu-north-1a\"\n\n      }\n      \"private2\" = {\n        name = \"private-subnet-2\"\n        cidr = \"10.10.12.0/24\"\n        az   = \"eu-north-1a\"\n      }\n    }\n  }\n}\n",
        "examples/simple/output.tf": "output \"vpc_id\" {\n  value = module.vpc.vpc_raw.id\n}\n\noutput \"vpc_cidr_block\" {\n  value = module.vpc.vpc_raw.cidr_block\n}\n\n\noutput \"private_subnets_by_type\" {\n  value = module.vpc.private_subnets_by_type\n}\noutput \"public_subnets_by_type\" {\n  value = module.vpc.public_subnets_by_type\n}\n",
        "locals.tf": "locals {\n  az_mapping = {\n    for idx, az in data.aws_availability_zones.available.names : az =>\n    data.aws_availability_zones.available.zone_ids[idx]\n  }\n\n  az_id_to_az = { for az, az_id in local.az_mapping : az_id => az }\n\n  normalized_public_subnets_all = {\n    for k, v in var.subnets.public : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # modify AZ ID to AZ\n    })\n  }\n\n  normalized_private_subnets_all = {\n    for k, v in var.subnets.private : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # modify AZ ID to AZ\n    })\n  }\n\n  # group by type and create a list of identifiers\n  private_subnets_by_type = {\n    for type in distinct([for k, v in local.normalized_private_subnets_all : v.type]) : type => {\n      ids  = [for k, v in local.normalized_private_subnets_all : aws_subnet.private[k].id if v.type == type]\n      keys = [for k, v in local.normalized_private_subnets_all : k if v.type == type]\n    }\n  }\n\n  public_subnets_by_type = {\n    for type in distinct([for k, v in var.subnets.public : v.type]) : type => {\n      ids  = [for k, v in local.normalized_public_subnets_all : aws_subnet.public[k].id if v.type == type]\n      keys = [for k, v in local.normalized_public_subnets_all : k if v.type == type]\n    }\n  }\n\n  private_subnets_by_az_output = {\n    for az in distinct([for subnet in local.normalized_private_subnets_all : subnet.az]) : az => [\n      for subnet_key, subnet in local.normalized_private_subnets_all : aws_subnet.private[subnet_key].id\n      if subnet.az == az\n    ]\n  }\n\n  public_subnets_by_az_output = {\n    for az in distinct([for subnet in local.normalized_public_subnets_all : subnet.az]) : az => [\n      for subnet_key, subnet in local.normalized_public_subnets_all : aws_subnet.public[subnet_key].id\n      if subnet.az == az\n    ]\n  }\n\n\n  private_subnets_by_az_id = {\n    for az_id in distinct([for subnet in local.normalized_private_subnets_all : lookup(local.az_mapping, subnet.az)]) : az_id => [\n      for subnet_key, subnet in local.normalized_private_subnets_all : aws_subnet.private[subnet_key].id\n      if lookup(local.az_mapping, subnet.az) == az_id\n    ]\n  }\n\n  public_subnets_by_az_id = {\n    for az_id in distinct([for subnet in local.normalized_public_subnets_all : lookup(local.az_mapping, subnet.az)]) : az_id => [\n      for subnet_key, subnet in local.normalized_public_subnets_all : aws_subnet.public[subnet_key].id\n      if lookup(local.az_mapping, subnet.az) == az_id\n    ]\n  }\n}\n",
        "main.tf": "",
        "outputs.tf": "# inputs\noutput \"tags_default\" {\n  description = \"Default tags\"\n  value       = var.tags_default\n}\n\noutput \"subnets_var\" {\n  description = \"for test\"\n  value       = var.subnets\n}\noutput \"vpc_var\" {\n  value = var.vpc\n}\n\n# vpc\noutput \"vpc_raw\" {\n  value = try(aws_vpc.default, null)\n}\n\n\n# debug\noutput \"az_mapping\" {\n  value = local.az_mapping\n}\n\n\n#subnets public\n\noutput \"normalized_public_subnets_all\" {\n  value = local.normalized_public_subnets_all\n}\n\noutput \"subnets_public_raw\" {\n  value = try(aws_subnet.public, null)\n}\noutput \"public_subnets_by_type\" {\n  value = local.public_subnets_by_type\n}\n\noutput \"public_subnets_by_az\" {\n  value = local.public_subnets_by_az_output\n}\n\noutput \"public_subnets_by_az_id\" {\n  value = local.public_subnets_by_az_id\n}\n#subnets private\noutput \"normalized_private_subnets_all\" {\n  value = local.normalized_private_subnets_all\n}\n\noutput \"subnets_private_raw\" {\n  value = try(aws_subnet.private, null)\n}\n\noutput \"private_subnets_by_type\" {\n  value = local.private_subnets_by_type\n}\n\noutput \"private_subnets_by_az\" {\n  value = local.private_subnets_by_az_output\n}\n\noutput \"private_subnets_by_az_id\" {\n  value = local.private_subnets_by_az_id\n}\n\n# NACL\noutput \"nacl_default_rules_raw\" {\n  value = aws_network_acl_rule.default\n}\noutput \"public_nacl_raw\" {\n  value = try(aws_network_acl.public, null)\n\n}\noutput \"public_nacl_rules_raw\" {\n  value = aws_network_acl_rule.public_rules\n}\n\n\noutput \"private_nacl_raw\" {\n  value = try(aws_network_acl.private, null)\n}\noutput \"private_nacl_rules_raw\" {\n  value = aws_network_acl_rule.private_rules\n}\n\n# NAT Gateway\n\noutput \"nat_gateway_single_raw\" {\n  value = try(aws_nat_gateway.SINGLE_nat_gateway, null)\n}\n\noutput \"nat_gateway_subnet_raw\" {\n  value = try(aws_nat_gateway.SUBNET_nat_gateway, null)\n}\n\noutput \"nat_gateway_az_raw\" {\n  value = try(aws_nat_gateway.az_nat_gateway, null)\n}\n\n# Route Table\noutput \"route_table_private_raw\" {\n  value = try(aws_route_table.private, null)\n}\n\noutput \"route_table_public_raw\" {\n  value = try(aws_route_table.public, null)\n}\n",
        "subnets_private.tf": "resource \"aws_subnet\" \"private\" {\n  vpc_id                  = aws_vpc.default.id\n  for_each                = local.normalized_private_subnets_all\n  map_public_ip_on_launch = \"false\"\n  cidr_block              = each.value.cidr\n\n  assign_ipv6_address_on_creation                = each.value.assign_ipv6_address_on_creation\n  customer_owned_ipv4_pool                       = each.value.customer_owned_ipv4_pool != \"\" ? each.value.customer_owned_ipv4_pool : null\n  enable_dns64                                   = each.value.enable_dns64\n  enable_resource_name_dns_aaaa_record_on_launch = each.value.enable_resource_name_dns_aaaa_record_on_launch\n  enable_resource_name_dns_a_record_on_launch    = each.value.enable_resource_name_dns_a_record_on_launch\n  ipv6_cidr_block                                = each.value.ipv6_cidr_block != \"\" ? each.value.ipv6_cidr_block : null\n  ipv6_native                                    = each.value.ipv6_native\n  map_customer_owned_ip_on_launch                = each.value.map_customer_owned_ip_on_launch ? each.value.map_customer_owned_ip_on_launch : null\n  outpost_arn                                    = each.value.outpost_arn != \"\" ? each.value.outpost_arn : null\n  private_dns_hostname_type_on_launch            = each.value.private_dns_hostname_type_on_launch != \"\" ? each.value.private_dns_hostname_type_on_launch : null\n\n\n\n  availability_zone = each.value.az\n\n  tags = merge(var.tags_default, { \"Name\" = each.value.name }, { \"type\" = each.value.type }, { \"subnet_key\" = each.key }, { \"access_type\" = \"private\" }, each.value.tags)\n}\n\n\n\n\nresource \"aws_route_table\" \"private\" {\n  for_each = local.normalized_private_subnets_all\n  vpc_id   = aws_vpc.default.id\n  tags     = merge(var.tags_default, { \"Name\" = each.value.name }, { \"type\" = each.value.type }, { \"subnet_key\" = each.key }, { \"access_type\" = \"private\" }, each.value.tags)\n}\n\nresource \"aws_route_table_association\" \"private\" {\n  for_each       = local.normalized_private_subnets_all\n  route_table_id = aws_route_table.private[\"${each.key}\"].id\n  subnet_id      = aws_subnet.private[\"${each.key}\"].id\n}\n\n# < Az NAT Gateway\nlocals {\n  normalized_private_subnets_AZ = {\n    for k, v in var.subnets.private : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # \u041f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u0443\u0435\u043c AZ ID \u0432 AZ, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e\n    })\n    if v.nat_gateway == \"AZ\" # \u0424\u0438\u043b\u044c\u0442\u0440\u0443\u0435\u043c \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435 \u043f\u043e\u0434\u0441\u0435\u0442\u0438, \u0433\u0434\u0435 nat_gateway = \"AZ\"\n  }\n\n\n\n  private_subnets_by_az = {\n    for az in distinct([for s in local.normalized_private_subnets_AZ : s.az]) :\n    az => {\n      ids  = [for k, s in local.normalized_private_subnets_AZ : aws_subnet.private[k].id if s.az == az]\n      keys = [for k, s in local.normalized_private_subnets_AZ : k if s.az == az]\n    }\n  }\n}\n\nresource \"aws_nat_gateway\" \"az_nat_gateway\" {\n  for_each = local.private_subnets_by_az\n\n  allocation_id = length(keys(var.existing_eip_ids_az)) == 0 ? aws_eip.az_nat_gateway_eip[each.key].id : var.existing_eip_ids_az[each.key]\n  subnet_id     = local.public_subnets_by_az_output[each.key][0]\n  tags          = merge(var.tags_default, { \"Name\" = \"az_nat_gateway-${each.key}\" })\n}\n\nresource \"aws_eip\" \"az_nat_gateway_eip\" {\n  for_each = length(keys(var.existing_eip_ids_az)) == 0 ? {\n    for az, data in local.private_subnets_by_az : az => az\n  } : {}\n  domain = \"vpc\"\n  tags   = merge(var.tags_default, { \"Name\" = \"az_nat_gateway-${each.key}\" })\n}\n\nlocals {\n  flat_private_subnet_keys = flatten([\n    for az, data in local.private_subnets_by_az : [\n      for key in data.keys : {\n        key = key\n        az  = az\n        id  = \"${az}-${key}\"\n      }\n    ]\n  ])\n\n  routes_map_private_subnet_az = {\n    for entry in local.flat_private_subnet_keys : entry.id => {\n      key = entry.key\n      az  = entry.az\n    }\n  }\n}\n\nresource \"aws_route\" \"private_route_az\" {\n\n  for_each = local.routes_map_private_subnet_az\n\n  route_table_id         = aws_route_table.private[each.value.key].id\n  destination_cidr_block = \"0.0.0.0/0\"\n  nat_gateway_id         = aws_nat_gateway.az_nat_gateway[each.value.az].id\n}\n\n\n\n\n# Az NAT Gateway >\n\n\n\n# < SUBNET NAT Gateway\n\nlocals {\n  normalized_private_subnets_SUBNET = {\n    for k, v in var.subnets.private : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # \u041f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u0443\u0435\u043c AZ ID \u0432 AZ, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e\n    })\n    if v.nat_gateway == \"SUBNET\" # \u0424\u0438\u043b\u044c\u0442\u0440\u0443\u0435\u043c \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435 \u043f\u043e\u0434\u0441\u0435\u0442\u0438, \u0433\u0434\u0435 nat_gateway = \"SUBNET\"\n  }\n\n\n}\n\n\nresource \"aws_eip\" \"SUBNET_nat_gateway_eip\" {\n  for_each = local.normalized_private_subnets_SUBNET\n  tags     = merge(var.tags_default, { \"Name\" = \"SUBNET_nat_gateway-${each.key}\" })\n  domain   = \"vpc\"\n}\n\nresource \"aws_nat_gateway\" \"SUBNET_nat_gateway\" {\n  for_each = local.normalized_private_subnets_SUBNET\n\n  allocation_id = aws_eip.SUBNET_nat_gateway_eip[each.key].id\n  subnet_id     = local.public_subnets_by_az_output[each.value.az][0]\n  tags          = merge(var.tags_default, { \"Name\" = \"SUBNET_nat_gateway-${each.key}\" })\n}\n\n\nresource \"aws_route\" \"private_route_SUBNET\" {\n\n  for_each               = local.normalized_private_subnets_SUBNET\n  route_table_id         = aws_route_table.private[each.key].id\n  destination_cidr_block = \"0.0.0.0/0\"\n  nat_gateway_id         = aws_nat_gateway.SUBNET_nat_gateway[each.key].id\n}\n\n\n# SUBNET NAT Gateway >\n\n\n# < SINGLE NAT Gateway\n\nlocals {\n  normalized_private_subnets_SINGLE = {\n    for k, v in var.subnets.private : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # \u041f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u0443\u0435\u043c AZ ID \u0432 AZ, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e\n    })\n    if v.nat_gateway == \"SINGLE\" # \u0424\u0438\u043b\u044c\u0442\u0440\u0443\u0435\u043c \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435 \u043f\u043e\u0434\u0441\u0435\u0442\u0438, \u0433\u0434\u0435 nat_gateway = \"SUBNET\"\n  }\n\n  normalized_public_subnets_DEFAULT = {\n    for k, v in var.subnets.public : k => merge(v, {\n      az = lookup(local.az_id_to_az, v.az, v.az) # \u041f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u0443\u0435\u043c AZ ID \u0432 AZ, \u0435\u0441\u043b\u0438 \u044d\u0442\u043e \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e\n    })\n    if v.nat_gateway == \"DEFAULT\" # \u0424\u0438\u043b\u044c\u0442\u0440\u0443\u0435\u043c \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435 \u043f\u043e\u0434\u0441\u0435\u0442\u0438, \u0433\u0434\u0435 nat_gateway = \"DEFAULT\"\n  }\n  normalized_public_subnets_DEFAULT_keys             = keys(local.normalized_public_subnets_DEFAULT)\n  normalized_public_subnets_DEFAULT_first_subnet_key = length(local.normalized_public_subnets_DEFAULT_keys) > 0 ? local.normalized_public_subnets_DEFAULT_keys[0] : null\n\n  normalized_public_subnets_DEFAULT_selected = {\n    for k, v in local.normalized_public_subnets_DEFAULT :\n    k => v if k == local.normalized_public_subnets_DEFAULT_first_subnet_key\n  }\n}\n\n\nresource \"aws_eip\" \"SINGLE_nat_gateway_eip\" {\n  for_each = local.normalized_public_subnets_DEFAULT_selected\n  tags     = merge(var.tags_default, { \"Name\" = \"SINGLE_nat_gateway-${each.key}\" })\n  domain   = \"vpc\"\n}\n\n\n\nresource \"aws_nat_gateway\" \"SINGLE_nat_gateway\" {\n  for_each = local.normalized_public_subnets_DEFAULT_selected\n\n  allocation_id = aws_eip.SINGLE_nat_gateway_eip[each.key].id\n  subnet_id     = aws_subnet.public[each.key].id\n  tags          = merge(var.tags_default, { \"Name\" = \"SINGLE_nat_gateway-${each.key}\" })\n}\n\n\nresource \"aws_route\" \"private_route_SINGLE\" {\n\n  for_each               = local.normalized_private_subnets_SINGLE\n  route_table_id         = aws_route_table.private[each.key].id\n  destination_cidr_block = \"0.0.0.0/0\"\n  nat_gateway_id         = aws_nat_gateway.SINGLE_nat_gateway[\"${local.normalized_public_subnets_DEFAULT_first_subnet_key}\"].id\n}\n\n#  SINGLE NAT Gateway  >\n\n\n# NACL\n\n# Local variable to flatten all NACL rules for private subnets\nlocals {\n  private_nacl_rules = flatten([\n    for subnet_key, subnet in var.subnets.private : [\n      for rule_key, rule in subnet.nacl : {\n        subnet_key = subnet_key\n        rule_key   = rule_key\n        rule       = rule\n      }\n    ]\n  ])\n}\n\n# Create a Network ACL for each private subnet if nacl is defined\nresource \"aws_network_acl\" \"private\" {\n  for_each = {\n    for subnet_key, subnet in var.subnets.private :\n    subnet_key => subnet\n    if length(subnet.nacl) > 0\n  }\n\n  vpc_id = aws_vpc.default.id\n\n  tags = merge(var.tags_default, {\n    \"Name\" = \"${each.value.name}-nacl\"\n  })\n}\n\n# Create Network ACL rules for each private subnet's NACL\nresource \"aws_network_acl_rule\" \"private_rules\" {\n  for_each = {\n    for rule in local.private_nacl_rules :\n    \"${rule.subnet_key}-${rule.rule_key}-${rule.rule.rule_number}\" => rule\n    if length(var.subnets.private[rule.subnet_key].nacl) > 0\n  }\n\n  network_acl_id  = aws_network_acl.private[each.value.subnet_key].id\n  rule_number     = each.value.rule.rule_number\n  egress          = each.value.rule.egress == \"true\" ? true : false\n  protocol        = each.value.rule.protocol\n  rule_action     = each.value.rule.rule_action\n  cidr_block      = each.value.rule.cidr_block != \"\" ? each.value.rule.cidr_block : null\n  from_port       = each.value.rule.from_port != \"\" ? tonumber(each.value.rule.from_port) : null\n  to_port         = each.value.rule.to_port != \"\" ? tonumber(each.value.rule.to_port) : null\n  icmp_code       = each.value.rule.icmp_code != \"\" ? tonumber(each.value.rule.icmp_code) : null\n  icmp_type       = each.value.rule.icmp_type != \"\" ? tonumber(each.value.rule.icmp_type) : null\n  ipv6_cidr_block = each.value.rule.ipv6_cidr_block != \"\" ? each.value.rule.ipv6_cidr_block : null\n}\n\n# Associate the NACL with each private subnet if NACL is defined\nresource \"aws_network_acl_association\" \"private_association\" {\n  for_each = {\n    for subnet_key, subnet in var.subnets.private :\n    subnet_key => subnet\n    if length(subnet.nacl) > 0\n  }\n\n  subnet_id      = aws_subnet.private[each.key].id\n  network_acl_id = aws_network_acl.private[each.key].id\n}\n",
        "subnets_pub.tf": "resource \"aws_subnet\" \"public\" {\n  vpc_id                  = aws_vpc.default.id\n  for_each                = local.normalized_public_subnets_all\n  map_public_ip_on_launch = each.value.map_public_ip_on_launch\n  cidr_block              = each.value.cidr\n\n  assign_ipv6_address_on_creation                = each.value.assign_ipv6_address_on_creation\n  customer_owned_ipv4_pool                       = each.value.customer_owned_ipv4_pool != \"\" ? each.value.customer_owned_ipv4_pool : null\n  enable_dns64                                   = each.value.enable_dns64\n  enable_resource_name_dns_aaaa_record_on_launch = each.value.enable_resource_name_dns_aaaa_record_on_launch\n  enable_resource_name_dns_a_record_on_launch    = each.value.enable_resource_name_dns_a_record_on_launch\n  ipv6_cidr_block                                = each.value.ipv6_cidr_block != \"\" ? each.value.ipv6_cidr_block : null\n  ipv6_native                                    = each.value.ipv6_native\n  map_customer_owned_ip_on_launch                = each.value.map_customer_owned_ip_on_launch ? each.value.map_customer_owned_ip_on_launch : null\n  outpost_arn                                    = each.value.outpost_arn != \"\" ? each.value.outpost_arn : null\n  private_dns_hostname_type_on_launch            = each.value.private_dns_hostname_type_on_launch != \"\" ? each.value.private_dns_hostname_type_on_launch : null\n\n\n  availability_zone_id = length(regexall(\"^[a-z]{2}-\", each.value.az)) == 0 ? each.value.az : null\n  availability_zone    = length(regexall(\"^[a-z]{2}-\", each.value.az)) > 0 ? each.value.az : null\n\n  tags = merge(var.tags_default, { \"Name\" = each.value.name }, { \"type\" = each.value.type }, { \"subnet_key\" = each.key }, { \"access_type\" = \"public\" }, each.value.tags)\n}\n\nresource \"aws_route_table\" \"public\" {\n  vpc_id = aws_vpc.default.id\n  tags   = merge(var.tags_default, { \"access_type\" = \"public\" })\n}\n\nresource \"aws_route\" \"public\" {\n  route_table_id         = aws_route_table.public.id\n  destination_cidr_block = \"0.0.0.0/0\"\n  gateway_id             = aws_internet_gateway.default.id\n\n  timeouts {\n    create = \"5m\"\n  }\n}\n\n\nresource \"aws_route_table_association\" \"pub\" {\n  for_each       = var.subnets.public\n  route_table_id = aws_route_table.public.id\n  subnet_id      = aws_subnet.public[\"${each.key}\"].id\n}\n\n\n\n# Local variable to flatten all NACL rules for public subnets\nlocals {\n  public_nacl_rules = flatten([\n    for subnet_key, subnet in local.normalized_public_subnets_all : [\n      for rule_key, rule in subnet.nacl : {\n        subnet_key = subnet_key\n        rule_key   = rule_key\n        rule       = rule\n      }\n      if length(subnet.nacl) > 0\n    ]\n  ])\n}\n\n# Create a Network ACL for each public subnet if nacl is defined and contains rules\nresource \"aws_network_acl\" \"public\" {\n  for_each = {\n    for subnet_key, subnet in local.normalized_public_subnets_all :\n    subnet_key => subnet\n    if length(subnet.nacl) > 0\n  }\n\n  vpc_id = aws_vpc.default.id\n\n  tags = merge(var.tags_default, {\n    \"Name\" = \"${each.value.name}-nacl\"\n  })\n}\n\n# Create Network ACL rules for each public subnet's NACL\nresource \"aws_network_acl_rule\" \"public_rules\" {\n  for_each = {\n    for rule in local.public_nacl_rules :\n    \"${rule.subnet_key}-${rule.rule_key}-${rule.rule.rule_number}\" => rule\n    if length(var.subnets.public[rule.subnet_key].nacl) > 0\n  }\n\n  network_acl_id  = aws_network_acl.public[each.value.subnet_key].id\n  rule_number     = each.value.rule.rule_number\n  egress          = each.value.rule.egress == \"true\" ? true : false\n  protocol        = each.value.rule.protocol\n  rule_action     = each.value.rule.rule_action\n  cidr_block      = each.value.rule.cidr_block != \"\" ? each.value.rule.cidr_block : null\n  from_port       = each.value.rule.from_port != \"\" ? tonumber(each.value.rule.from_port) : null\n  to_port         = each.value.rule.to_port != \"\" ? tonumber(each.value.rule.to_port) : null\n  icmp_code       = each.value.rule.icmp_code != \"\" ? tonumber(each.value.rule.icmp_code) : null\n  icmp_type       = each.value.rule.icmp_type != \"\" ? tonumber(each.value.rule.icmp_type) : null\n  ipv6_cidr_block = each.value.rule.ipv6_cidr_block != \"\" ? each.value.rule.ipv6_cidr_block : null\n}\n\n# Associate the NACL with each public subnet if NACL is defined and contains rules\nresource \"aws_network_acl_association\" \"public_association\" {\n  for_each = {\n    for subnet_key, subnet in local.normalized_public_subnets_all :\n    subnet_key => subnet\n    if length(subnet.nacl) > 0\n  }\n\n  subnet_id      = aws_subnet.public[each.key].id\n  network_acl_id = aws_network_acl.public[each.key].id\n}\n",
        "variables.tf": "variable \"vpc\" {\n  type = object({\n    name                  = string\n    cidr                  = string\n    secondary_cidr_blocks = optional(list(string), [])\n    tags                  = optional(map(string), {})\n    instance_tenancy      = optional(string, \"default\") # default, dedicated\n    enable_dns_support    = optional(bool, true)        # true, false\n    enable_dns_hostnames  = optional(bool, true)        # true, false\n    nacl_default = optional(map(object({\n      egress      = string # true, false\n      rule_number = string # ACL entries are processed in ascending order by rule number\n      rule_action = string # allow | deny\n      from_port   = optional(string, \"\")\n      to_port     = optional(string, \"\")\n      icmp_code   = optional(string, \"\")\n      # (Optional) ICMP protocol: The ICMP type. Required if specifying ICMP for the protocolE.g., -1\n      icmp_type = optional(string, \"\")\n      # (Optional) ICMP protocol: The ICMP code. Required if specifying ICMP for the protocolE.g., -1\n      protocol   = string # A value of -1 means all protocols , tcp  - 6 ,\n      cidr_block = optional(string, \"\")\n      # The network range to allow or deny, in CIDR notation (for example 172.16.0.0/24 ).\n      ipv6_cidr_block = optional(string, \"\")\n\n    })), {})\n    dhcp_options = optional(object({\n      domain_name                       = optional(string, \"\")\n      domain_name_servers               = optional(list(string), [])\n      ntp_servers                       = optional(list(string), [])\n      netbios_name_servers              = optional(list(string), [])\n      netbios_node_type                 = optional(string, \"\")    # 1, 2, 4, 8  . default 2 . http://www.ietf.org/rfc/rfc2132.txt\n      ipv6_address_preferred_lease_time = optional(string, \"140\") # 140 .. 2147483647 seconds . default 140\n      tags                              = optional(map(string), {})\n    }), {})\n  })\n\n  # Validation for CIDR format\n  validation {\n    condition     = can(cidrsubnet(var.vpc.cidr, 0, 0))\n    error_message = \"Invalid CIDR block format for VPC. CIDR block must be a valid subnet, e.g., 10.0.0.0/16.\"\n  }\n\n  # Validation for netbios_node_type field\n  validation {\n    condition = var.vpc.dhcp_options.netbios_node_type == \"\" || contains([\n      \"1\", \"2\", \"4\", \"8\"\n    ], var.vpc.dhcp_options.netbios_node_type)\n    error_message = \"Invalid value for netbios_node_type. Must be one of: 1, 2, 4, 8.\"\n  }\n\n  # Validation for ipv6_address_preferred_lease_time\n  validation {\n    condition = (\n      var.vpc.dhcp_options.ipv6_address_preferred_lease_time == \"\" ||\n      (\n        length(var.vpc.dhcp_options.ipv6_address_preferred_lease_time) > 0 &&\n        can(tonumber(var.vpc.dhcp_options.ipv6_address_preferred_lease_time)) &&\n        tonumber(var.vpc.dhcp_options.ipv6_address_preferred_lease_time) >= 140 &&\n        tonumber(var.vpc.dhcp_options.ipv6_address_preferred_lease_time) <= 2147483647\n      )\n    )\n    error_message = \"Invalid value for ipv6_address_preferred_lease_time. Must be a number between 140 and 2147483647 seconds.\"\n  }\n}\n\nvariable \"tags_default\" {\n  type    = map(string)\n  default = {}\n}\n\n\nvariable \"subnets\" {\n  type = object({\n    public = optional(map(object({\n      name = string\n      cidr = string\n      az   = string # Availability Zone or Availability Zone ID\n      tags = optional(map(string), {})\n      type = optional(string, \"public\") # any sort key for grouping . example , DB , WEB , APP , etc\n\n      assign_ipv6_address_on_creation                = optional(bool, false)\n      customer_owned_ipv4_pool                       = optional(string, \"\")\n      enable_dns64                                   = optional(bool, false)\n      enable_resource_name_dns_aaaa_record_on_launch = optional(bool, false)\n      enable_resource_name_dns_a_record_on_launch    = optional(bool, true)\n      ipv6_cidr_block                                = optional(string, \"\")\n      ipv6_native                                    = optional(bool, false)\n      map_customer_owned_ip_on_launch                = optional(bool, false)\n      map_public_ip_on_launch                        = optional(bool, true)\n      outpost_arn                                    = optional(string, \"\")\n      private_dns_hostname_type_on_launch            = optional(string, \"ip-name\") #  The type of hostnames to assign to instances in the subnet at launch. For IPv6-only subnets, an instance DNS name must be based on the instance ID. For dual-stack and IPv4-only subnets, you can specify whether DNS names use the instance IPv4 address or the instance ID . Valid values:  ip-name, resource-name.\n      nat_gateway                                    = optional(string, \"\")        #  DEFAULT - default nat gateway for all AZ  with SINGLE value\n      nacl = optional(map(object({\n        egress          = string # true, false\n        rule_number     = string # ACL entries are processed in ascending order by rule number\n        rule_action     = string # allow | deny\n        from_port       = optional(string, \"\")\n        to_port         = optional(string, \"\")\n        icmp_code       = optional(string, \"\") # (Optional) ICMP protocol: The ICMP type. Required if specifying ICMP for the protocolE.g., -1\n        icmp_type       = optional(string, \"\") # (Optional) ICMP protocol: The ICMP code. Required if specifying ICMP for the protocolE.g., -1\n        protocol        = string               # A value of -1 means all protocols , tcp  - 6 ,\n        cidr_block      = optional(string, \"\") # The network range to allow or deny, in CIDR notation (for example 172.16.0.0/24 ).\n        ipv6_cidr_block = optional(string, \"\")\n\n      })), {})\n\n    })))\n    private = optional(map(object({\n      name                                           = string\n      cidr                                           = string\n      az                                             = string # Availability Zone or Availability Zone ID\n      tags                                           = optional(map(string), {})\n      type                                           = optional(string, \"private\") # any sort key for grouping . example , DB , WEB , APP , etc\n      nat_gateway                                    = optional(string, \"AZ\")      # AZ - nat gateway for  each AZ , SINGLE - single nat gateway for all AZ (for this option you need to set nat_gateway=DEFAULT in one of the public networks)  ,SUBNET - dedicate nat gateway for each  subnet with SUBNET  type   ,  NONE - no nat gateway\n      assign_ipv6_address_on_creation                = optional(bool, false)\n      customer_owned_ipv4_pool                       = optional(string, \"\")\n      enable_dns64                                   = optional(bool, false)\n      enable_resource_name_dns_aaaa_record_on_launch = optional(bool, false)\n      enable_resource_name_dns_a_record_on_launch    = optional(bool, false)\n      ipv6_cidr_block                                = optional(string, \"\")\n      ipv6_native                                    = optional(bool, false)\n      map_customer_owned_ip_on_launch                = optional(bool, false)\n      map_public_ip_on_launch                        = optional(bool, true)\n      outpost_arn                                    = optional(string, \"\")\n      private_dns_hostname_type_on_launch            = optional(string, \"ip-name\") #  The type of hostnames to assign to instances in the subnet at launch. For IPv6-only subnets, an instance DNS name must be based on the instance ID. For dual-stack and IPv4-only subnets, you can specify whether DNS names use the instance IPv4 address or the instance ID . Valid values:  ip-name, resource-name.\n      nacl = optional(map(object({\n        egress          = string # true, false\n        rule_number     = string # ACL entries are processed in ascending order by rule number\n        rule_action     = string # allow | deny\n        from_port       = optional(string, \"\")\n        to_port         = optional(string, \"\")\n        icmp_code       = optional(string, \"\") # (Optional) ICMP protocol: The ICMP type. Required if specifying ICMP for the protocolE.g., -1\n        icmp_type       = optional(string, \"\") # (Optional) ICMP protocol: The ICMP code. Required if specifying ICMP for the protocolE.g., -1\n        protocol        = string               # A value of -1 means all protocols , tcp  - 6 ,\n        cidr_block      = optional(string, \"\") # The network range to allow or deny, in CIDR notation (for example 172.16.0.0/24 ).\n        ipv6_cidr_block = optional(string, \"\")\n\n      })), {})\n\n    })))\n  })\n  default = {\n    public  = {}\n    private = {}\n  }\n\n  validation {\n    condition = alltrue([\n      for _, subnet in coalesce(var.subnets.private, {}) : contains([\"AZ\", \"SINGLE\", \"DEFAULT\", \"SUBNET\", \"NONE\"], subnet.nat_gateway)\n    ])\n    error_message = \"nat_gateway must be one of: AZ, SINGLE, DEFAULT, SUBNET, NONE.\"\n  }\n\n  validation {\n    condition = alltrue([\n      for _, subnet in coalesce(var.subnets.private, {}) : can(cidrsubnet(subnet.cidr, 0, 0))\n    ])\n    error_message = \"Invalid CIDR block format. CIDR block must be a valid subnet, e.g., 10.10.16.0/24.\"\n  }\n\n  validation {\n    condition = alltrue([\n      for _, subnet in coalesce(var.subnets.private, {}) : contains([\"ip-name\", \"resource-name\"], subnet.private_dns_hostname_type_on_launch)\n    ])\n    error_message = \"Invalid value for private_dns_hostname_type_on_launch. Must be one of: ip-name, resource-name.\"\n  }\n\n  validation {\n    condition = alltrue([\n      for _, subnet in coalesce(var.subnets.public, {}) : can(cidrsubnet(subnet.cidr, 0, 0))\n    ])\n    error_message = \"Invalid CIDR block format. CIDR block must be a valid subnet, e.g., 10.10.16.0/24.\"\n  }\n\n  validation {\n    condition = alltrue([\n      for _, subnet in coalesce(var.subnets.public, {}) : contains([\"ip-name\", \"resource-name\"], subnet.private_dns_hostname_type_on_launch)\n    ])\n    error_message = \"Invalid value for private_dns_hostname_type_on_launch. Must be one of: ip-name, resource-name.\"\n  }\n}\n\nvariable \"existing_eip_ids_az\" {\n  description = \"A map of existing Elastic IPs IDs to associate with the NAT Gateways where key is the AZ, value is the EIP ID\"\n  type        = map(string)\n  default     = {}\n\n  validation {\n    condition = alltrue([\n      for az, eip in var.existing_eip_ids_az : can(regex(\"^eipalloc-[0-9a-fA-F]{17}$\", eip))\n    ])\n    error_message = \"Each value in existing_eip_ids_az must be a valid Elastic IP ID (eipalloc-xxxxxxxxxxxxxxxxx).\"\n  }\n\n  validation {\n    condition = alltrue([\n      for az, eip in var.existing_eip_ids_az : can(regex(\"^[a-z]{2}-[a-z]+-[0-9]{1}[a-z]$\", az))\n    ])\n    error_message = \"Each key in existing_eip_ids_az must be a valid Availability Zone (e.g., eu-west-1a).\"\n  }\n}\n",
        "versions.tf": "terraform {\n  required_version = \">= 1.0\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 5.46\"\n    }\n  }\n}\n",
        "vpc.tf": "resource \"aws_vpc\" \"default\" {\n  cidr_block           = var.vpc.cidr\n  enable_dns_support   = var.vpc.enable_dns_support\n  enable_dns_hostnames = var.vpc.enable_dns_hostnames\n  tags                 = merge(var.tags_default, { \"Name\" = var.vpc.name }, var.vpc.tags)\n}\n\nresource \"aws_internet_gateway\" \"default\" {\n  vpc_id = aws_vpc.default.id\n  tags   = merge(var.tags_default, { \"Name\" = var.vpc.name }, var.vpc.tags)\n}\n\nresource \"aws_vpc_ipv4_cidr_block_association\" \"default\" {\n  for_each   = toset(var.vpc.secondary_cidr_blocks)\n  vpc_id     = aws_vpc.default.id\n  cidr_block = each.value\n}\n\nresource \"aws_network_acl_rule\" \"default\" {\n  for_each        = var.vpc.nacl_default\n  network_acl_id  = aws_vpc.default.default_network_acl_id\n  rule_number     = each.value.rule_number\n  egress          = each.value.egress\n  protocol        = each.value.protocol\n  rule_action     = each.value.rule_action\n  cidr_block      = each.value.cidr_block != \"\" ? each.value.cidr_block : null\n  from_port       = each.value.from_port != \"\" ? each.value.from_port : null\n  to_port         = each.value.to_port != \"\" ? each.value.to_port : null\n  ipv6_cidr_block = each.value.ipv6_cidr_block != \"\" ? each.value.ipv6_cidr_block : null\n}\n\n\nlocals {\n  # Check if any DHCP option is defined (for strings and lists)\n  dhcp_options_defined = (\n    var.vpc.dhcp_options.domain_name != \"\" ||\n    length(var.vpc.dhcp_options.domain_name_servers) > 0 ||\n    length(var.vpc.dhcp_options.ntp_servers) > 0 ||\n    length(var.vpc.dhcp_options.netbios_name_servers) > 0 ||\n    var.vpc.dhcp_options.netbios_node_type != \"\" ||\n    var.vpc.dhcp_options.ipv6_address_preferred_lease_time != \"140\"\n  )\n}\n\nresource \"aws_vpc_dhcp_options\" \"default\" {\n  for_each                          = local.dhcp_options_defined ? toset([\"enable\"]) : toset([])\n  domain_name                       = var.vpc.dhcp_options.domain_name != \"\" ? var.vpc.dhcp_options.domain_name : null\n  domain_name_servers               = length(var.vpc.dhcp_options.domain_name_servers) > 0 ? var.vpc.dhcp_options.domain_name_servers : null\n  ntp_servers                       = length(var.vpc.dhcp_options.ntp_servers) > 0 ? var.vpc.dhcp_options.ntp_servers : null\n  netbios_name_servers              = length(var.vpc.dhcp_options.netbios_name_servers) > 0 ? var.vpc.dhcp_options.netbios_name_servers : null\n  netbios_node_type                 = var.vpc.dhcp_options.netbios_node_type != \"\" ? var.vpc.dhcp_options.netbios_node_type : null\n  ipv6_address_preferred_lease_time = var.vpc.dhcp_options.ipv6_address_preferred_lease_time != \"140\" ? var.vpc.dhcp_options.ipv6_address_preferred_lease_time : null\n  tags                              = merge(var.tags_default, { \"Name\" = var.vpc.name }, var.vpc.tags)\n}\n\nresource \"aws_vpc_dhcp_options_association\" \"default\" {\n  for_each        = local.dhcp_options_defined ? toset([\"enable\"]) : toset([])\n  vpc_id          = aws_vpc.default.id\n  dhcp_options_id = aws_vpc_dhcp_options.default[each.key].id\n}\n"
      },
      "has_app": true
    },
    "ad03f95fc72b1791": {
      "hash": "ad03f95fc72b1791",
      "source_url": "https://github.com/aws-samples/serverless-patterns/tree/main/apigw-lambda-dynamodb-terraform",
      "source_type": "github_repos",
      "discovered_at": "2026-01-11T08:20:41.719236",
      "services": [
        "dynamodb",
        "cloudwatch",
        "lambda",
        "apigateway",
        "iam",
        "s3"
      ],
      "resource_count": 15,
      "name": "aws-samples/serverless-patterns/apigw-lambda-dynamodb-terraform",
      "description": "Serverless patterns. Learn more at the website: https://serverlessland.com/patterns.",
      "version": "main",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n    random = {\n      source  = \"hashicorp/random\"\n      version = \"~> 3.1.0\"\n    }\n    archive = {\n      source  = \"hashicorp/archive\"\n      version = \"~> 2.2.0\"\n    }\n  }\n\n  required_version = \">= 0.14.9\"\n}\n\nprovider \"aws\" {\n  profile = \"default\"\n  region = var.aws_region\n}\n\nresource \"random_string\" \"random\" {\n  length           = 4\n  special          = false\n}\n\nresource \"aws_dynamodb_table\" \"movie_table\" {\n  name           = var.dynamodb_table\n  billing_mode   = \"PROVISIONED\"\n  read_capacity  = 20\n  write_capacity = 20\n  hash_key       = \"year\"\n  range_key      = \"title\"\n\n  attribute {\n    name = \"year\"\n    type = \"N\"\n  }\n  \n  attribute {\n    name = \"title\"\n    type = \"S\"\n  }\n\n}\n\n#========================================================================\n// lambda setup\n#========================================================================\n\nresource \"aws_s3_bucket\" \"lambda_bucket\" {\n  bucket_prefix = var.s3_bucket_prefix\n  force_destroy = true\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"private_bucket\" {\n  bucket = aws_s3_bucket.lambda_bucket.id\n\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}\n\ndata \"archive_file\" \"lambda_zip\" {\n  type = \"zip\"\n\n  source_dir  = \"${path.module}/src\"\n  output_path = \"${path.module}/src.zip\"\n}\n\nresource \"aws_s3_object\" \"this\" {\n  bucket = aws_s3_bucket.lambda_bucket.id\n\n  key    = \"src.zip\"\n  source = data.archive_file.lambda_zip.output_path\n\n  etag = filemd5(data.archive_file.lambda_zip.output_path)\n}\n\n//Define lambda function\nresource \"aws_lambda_function\" \"apigw_lambda_ddb\" {\n  function_name = \"${var.lambda_name}-${random_string.random.id}\"\n  description = \"serverlessland pattern\"\n\n  s3_bucket = aws_s3_bucket.lambda_bucket.id\n  s3_key    = aws_s3_object.this.key\n\n  runtime = \"python3.14\"\n  handler = \"app.lambda_handler\"\n\n  source_code_hash = data.archive_file.lambda_zip.output_base64sha256\n\n  role = aws_iam_role.lambda_exec.arn\n  \n  environment {\n    variables = {\n      DDB_TABLE = var.dynamodb_table\n    }\n  }\n  depends_on = [aws_cloudwatch_log_group.lambda_logs]\n  \n}\n\nresource \"aws_cloudwatch_log_group\" \"lambda_logs\" {\n  name = \"/aws/lambda/${var.lambda_name}-${random_string.random.id}\"\n\n  retention_in_days = var.lambda_log_retention\n}\n\nresource \"aws_iam_role\" \"lambda_exec\" {\n  name = \"LambdaDdbPost\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Action = \"sts:AssumeRole\"\n      Effect = \"Allow\"\n      Sid    = \"\"\n      Principal = {\n        Service = \"lambda.amazonaws.com\"\n      }\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_policy\" \"lambda_exec_role\" {\n  name = \"lambda-tf-pattern-ddb-post\"\n\n  policy = <<POLICY\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"dynamodb:GetItem\",\n                \"dynamodb:PutItem\",\n                \"dynamodb:UpdateItem\"\n            ],\n            \"Resource\": \"arn:aws:dynamodb:*:*:table/${var.dynamodb_table}\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": \"*\"\n        }\n    ]\n}\nPOLICY\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_policy\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = aws_iam_policy.lambda_exec_role.arn\n}\n\n#========================================================================\n// API Gateway section\n#========================================================================\n\nresource \"aws_apigatewayv2_api\" \"http_lambda\" {\n  name          = \"${var.apigw_name}-${random_string.random.id}\"\n  protocol_type = \"HTTP\"\n}\n\nresource \"aws_apigatewayv2_stage\" \"default\" {\n  api_id = aws_apigatewayv2_api.http_lambda.id\n\n  name        = \"$default\"\n  auto_deploy = true\n\n  access_log_settings {\n    destination_arn = aws_cloudwatch_log_group.api_gw.arn\n\n    format = jsonencode({\n      requestId               = \"$context.requestId\"\n      sourceIp                = \"$context.identity.sourceIp\"\n      requestTime             = \"$context.requestTime\"\n      protocol                = \"$context.protocol\"\n      httpMethod              = \"$context.httpMethod\"\n      resourcePath            = \"$context.resourcePath\"\n      routeKey                = \"$context.routeKey\"\n      status                  = \"$context.status\"\n      responseLength          = \"$context.responseLength\"\n      integrationErrorMessage = \"$context.integrationErrorMessage\"\n      }\n    )\n  }\n  depends_on = [aws_cloudwatch_log_group.api_gw]\n}\n\nresource \"aws_apigatewayv2_integration\" \"apigw_lambda\" {\n  api_id = aws_apigatewayv2_api.http_lambda.id\n\n  integration_uri    = aws_lambda_function.apigw_lambda_ddb.invoke_arn\n  integration_type   = \"AWS_PROXY\"\n  integration_method = \"POST\"\n}\n\nresource \"aws_apigatewayv2_route\" \"post\" {\n  api_id = aws_apigatewayv2_api.http_lambda.id\n\n  route_key = \"POST /movies\"\n  target    = \"integrations/${aws_apigatewayv2_integration.apigw_lambda.id}\"\n}\n\nresource \"aws_cloudwatch_log_group\" \"api_gw\" {\n  name = \"/aws/api_gw/${var.apigw_name}-${random_string.random.id}\"\n\n  retention_in_days = var.apigw_log_retention\n}\n\nresource \"aws_lambda_permission\" \"api_gw\" {\n  statement_id  = \"AllowExecutionFromAPIGateway\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.apigw_lambda_ddb.function_name\n  principal     = \"apigateway.amazonaws.com\"\n\n  source_arn = \"${aws_apigatewayv2_api.http_lambda.execution_arn}/*/*\"\n}\n",
        "outputs.tf": "# Output value definitions\n\noutput \"apigwy_url\" {\n  description = \"URL for API Gateway stage\"\n\n  value = aws_apigatewayv2_stage.default.invoke_url\n}\n\noutput \"lambda_log_group\" {\n  description = \"Name of the CloudWatch logs group for the lambda function\"\n\n  value = aws_cloudwatch_log_group.lambda_logs.id\n}\n\noutput \"apigwy_log_group\" {\n  description = \"Name of the CloudWatch logs group for the lambda function\"\n\n  value = aws_cloudwatch_log_group.api_gw.id\n}",
        "variables.tf": "# Input variable definitions\n\nvariable \"aws_region\" {\n  description = \"AWS region for all resources.\"\n\n  type    = string\n  default = \"us-east-1\"\n}\n\nvariable \"s3_bucket_prefix\" {\n  description = \"S3 bucket prefix\"\n  type = string\n  default = \"apigw-lambda-ddb\"\n  \n}\n\nvariable \"dynamodb_table\" {\n  description = \"name of the ddb table\"\n  type = string\n  default = \"Movies\"\n  \n}\n\nvariable \"lambda_name\" {\n  description = \"name of the lambda function\"\n  type = string\n  default = \"pattern-movies-post\"\n  \n}\n\nvariable \"apigw_name\" {\n  description = \"name of the lambda function\"\n  type = string\n  default = \"apigw-http-lambda\"\n  \n}\n\nvariable \"lambda_log_retention\" {\n  description = \"lambda log retention in days\"\n  type = number\n  default = 7\n}\n\nvariable \"apigw_log_retention\" {\n  description = \"api gwy log retention in days\"\n  type = number\n  default = 7\n}"
      },
      "has_app": true
    },
    "ced9dfcb174c6a53": {
      "hash": "ced9dfcb174c6a53",
      "source_url": "https://github.com/aws-samples/serverless-patterns/tree/main/s3-lambda-terraform",
      "source_type": "github_repos",
      "discovered_at": "2026-01-11T08:20:42.768302",
      "services": [
        "iam",
        "lambda",
        "s3"
      ],
      "resource_count": 5,
      "name": "aws-samples/serverless-patterns/s3-lambda-terraform",
      "description": "Serverless patterns. Learn more at the website: https://serverlessland.com/patterns.",
      "version": "main",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 3.27\"\n    }\n    random = {\n      source  = \"hashicorp/random\"\n      version = \"3.1.0\"\n    }\n  }\n\n  required_version = \">= 0.14.9\"\n}\n\nprovider \"aws\" {\n  profile = \"default\"\n  region  = \"us-east-1\"\n}\n\nresource \"random_string\" \"random\" {\n  length  = 8\n  special = false\n  lower   = true\n  number  = true\n  upper   = false\n}\n\nresource \"aws_lambda_function\" \"lambda_s3_handler\" {\n  function_name    = \"process-s3-new-objects\"\n  filename         = data.archive_file.lambda_zip_file.output_path\n  source_code_hash = data.archive_file.lambda_zip_file.output_base64sha256\n  handler          = \"index.handler\"\n  role             = aws_iam_role.iam_for_lambda.arn\n  runtime          = \"nodejs16.x\"\n}\n\ndata \"archive_file\" \"lambda_zip_file\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/src/index.js\"\n  output_path = \"${path.module}/lambda.zip\"\n}\n\nresource \"aws_iam_role\" \"iam_for_lambda\" {\n  name = \"iam_for_lambda\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n  inline_policy {\n    name   = \"lambda_logs_policy\"\n    policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n        \"Sid\": \"AllowLambdaFunctionToCreateLogs\",\n        \"Action\": [ \n            \"logs:*\" \n        ],\n        \"Effect\": \"Allow\",\n        \"Resource\": [ \n            \"arn:aws:logs:*:*:*\" \n        ]\n    }\n  ]\n}\nEOF\n  }\n}\n\nresource \"aws_lambda_permission\" \"allow_bucket_invoke_lambda\" {\n  statement_id  = \"AllowExecutionFromS3Bucket\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.lambda_s3_handler.arn\n  principal     = \"s3.amazonaws.com\"\n  source_arn    = aws_s3_bucket.my_bucket.arn\n}\n\nresource \"aws_s3_bucket\" \"my_bucket\" {\n  bucket = \"my-bucket-${random_string.random.result}\"\n}\n\nresource \"aws_s3_bucket_notification\" \"bucket_notification\" {\n  bucket = aws_s3_bucket.my_bucket.id\n\n  lambda_function {\n    lambda_function_arn = aws_lambda_function.lambda_s3_handler.arn\n    events              = [\"s3:ObjectCreated:*\"]\n  }\n\n  depends_on = [aws_lambda_permission.allow_bucket_invoke_lambda]\n}\n\noutput \"name_of_bucket\" {\n  value       = aws_s3_bucket.my_bucket.bucket\n  description = \"The name of the bucket\"\n}\n"
      },
      "has_app": true
    },
    "d02637494b9688ec": {
      "hash": "d02637494b9688ec",
      "source_url": "https://github.com/aws-samples/serverless-patterns/tree/main/eventbridge-lambda-terraform",
      "source_type": "github_repos",
      "discovered_at": "2026-01-11T08:20:43.824327",
      "services": [
        "iam",
        "lambda",
        "cloudwatch"
      ],
      "resource_count": 6,
      "name": "aws-samples/serverless-patterns/eventbridge-lambda-terraform",
      "description": "Serverless patterns. Learn more at the website: https://serverlessland.com/patterns.",
      "version": "main",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "terraform {\n  required_providers {\n\taws = {\n\t  source  = \"hashicorp/aws\"\n\t  version = \"~> 5.0\"\n\t}\n  }\n\n  required_version = \">= 0.14.9\"\n}\n\nprovider \"aws\" {\n  profile = \"default\"\n  region  = \"us-east-1\"\n}\n\nresource \"aws_lambda_function\" \"lambda_function\" {\n  function_name    = \"ConsumerFunction\"\n  filename         = data.archive_file.lambda_zip_file.output_path\n  source_code_hash = data.archive_file.lambda_zip_file.output_base64sha256\n  handler          = \"app.handler\"\n  role             = aws_iam_role.lambda_iam_role.arn\n  runtime          = \"nodejs24.x\"\n}\n\ndata \"archive_file\" \"lambda_zip_file\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/src/app.js\"\n  output_path = \"${path.module}/lambda.zip\"\n}\n\ndata \"aws_iam_policy\" \"lambda_basic_execution_role_policy\" {\n  name = \"AWSLambdaBasicExecutionRole\"\n}\n\nresource \"aws_iam_role\" \"lambda_iam_role\" {\n  name_prefix         = \"EventBridgeLambdaRole-\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n\t{\n\t  \"Action\": \"sts:AssumeRole\",\n\t  \"Principal\": {\n\t\t\"Service\": \"lambda.amazonaws.com\"\n\t  },\n\t  \"Effect\": \"Allow\",\n\t  \"Sid\": \"\"\n\t}\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_basic_execution\" {\n  role       = aws_iam_role.lambda_iam_role.name\n  policy_arn = data.aws_iam_policy.lambda_basic_execution_role_policy.arn\n}\n\nresource \"aws_cloudwatch_event_rule\" \"event_rule\" {\n\tname_prefix = \"eventbridge-lambda-\"\n  event_pattern = <<EOF\n{\n  \"detail-type\": [\"transaction\"],\n  \"source\": [\"custom.myApp\"],\n  \"detail\": {\n\t\"location\": [{\n\t  \"prefix\": \"EUR-\"\n\t}]\n  }\n}\nEOF\n}\n\nresource \"aws_cloudwatch_event_target\" \"target_lambda_function\" {\n  rule = aws_cloudwatch_event_rule.event_rule.name\n  arn  = aws_lambda_function.lambda_function.arn\n}\n\nresource \"aws_lambda_permission\" \"allow_cloudwatch\" {\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.lambda_function.function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.event_rule.arn\n}\n\noutput \"ConsumerFunction\" {\n  value       = aws_lambda_function.lambda_function.arn\n  description = \"ConsumerFunction function name\"\n}\n"
      },
      "has_app": true
    },
    "331b83bdbfe63d75": {
      "hash": "331b83bdbfe63d75",
      "source_url": "https://github.com/aws-samples/serverless-patterns/tree/main/apigw-http-api-lambda-terraform",
      "source_type": "github_repos",
      "discovered_at": "2026-01-11T08:20:46.397004",
      "services": [
        "cloudwatch",
        "lambda",
        "apigateway",
        "iam",
        "s3"
      ],
      "resource_count": 13,
      "name": "aws-samples/serverless-patterns/apigw-http-api-lambda-terraform",
      "description": "Serverless patterns. Learn more at the website: https://serverlessland.com/patterns.",
      "version": "main",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 4.0.0\"\n    }\n    random = {\n      source  = \"hashicorp/random\"\n      version = \"~> 3.1.0\"\n    }\n    archive = {\n      source  = \"hashicorp/archive\"\n      version = \"~> 2.2.0\"\n    }\n  }\n\n  required_version = \"~> 1.0\"\n}\n\nprovider \"aws\" {\n  profile = \"default\"\n  region = var.aws_region\n}\n\n\nresource \"aws_s3_bucket\" \"lambda_bucket\" {\n  bucket_prefix = var.s3_bucket_prefix\n  force_destroy = true\n}\n\nresource \"aws_s3_bucket_acl\" \"private_bucket\" {\n  bucket = aws_s3_bucket.lambda_bucket.id\n  acl    = \"private\"\n}\n\ndata \"archive_file\" \"lambda_zip\" {\n  type = \"zip\"\n\n  source_dir  = \"${path.module}/src\"\n  output_path = \"${path.module}/src.zip\"\n}\n\nresource \"aws_s3_object\" \"lambda_app\" {\n  bucket = aws_s3_bucket.lambda_bucket.id\n\n  key    = \"source.zip\"\n  source = data.archive_file.lambda_zip.output_path\n\n  etag = filemd5(data.archive_file.lambda_zip.output_path)\n}\n\n//Define lambda function\nresource \"aws_lambda_function\" \"app\" {\n  function_name = var.lambda_name\n  description = \"apigwy-http-api serverlessland pattern\"\n\n  s3_bucket = aws_s3_bucket.lambda_bucket.id\n  s3_key    = aws_s3_object.lambda_app.key\n\n  runtime = \"python3.14\"\n  handler = \"app.lambda_handler\"\n\n  source_code_hash = data.archive_file.lambda_zip.output_base64sha256\n\n  role = aws_iam_role.lambda_exec.arn\n  depends_on = [aws_cloudwatch_log_group.lambda_log]\n}\n\nresource \"aws_cloudwatch_log_group\" \"lambda_log\" {\n  name = \"/aws/lambda/${var.lambda_name}\"\n\n  retention_in_days = var.lambda_log_retention\n}\n\nresource \"aws_iam_role\" \"lambda_exec\" {\n  name = \"serverless_lambda\"\n\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Action = \"sts:AssumeRole\"\n      Effect = \"Allow\"\n      Sid    = \"\"\n      Principal = {\n        Service = \"lambda.amazonaws.com\"\n      }\n      }\n    ]\n  })\n}\n\nresource \"aws_iam_role_policy_attachment\" \"lambda_policy\" {\n  role       = aws_iam_role.lambda_exec.name\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"\n}\n\n// API Gateway stuff\n\nresource \"aws_apigatewayv2_api\" \"lambda\" {\n  name          = \"apigw-http-lambda\"\n  protocol_type = \"HTTP\"\n  description   = \"Serverlessland API Gwy HTTP API and AWS Lambda function\"\n\n  cors_configuration {\n      allow_credentials = false\n      allow_headers     = []\n      allow_methods     = [\n          \"GET\",\n          \"HEAD\",\n          \"OPTIONS\",\n          \"POST\",\n      ]\n      allow_origins     = [\n          \"*\",\n      ]\n      expose_headers    = []\n      max_age           = 0\n  }\n}\n\n\nresource \"aws_apigatewayv2_stage\" \"default\" {\n  api_id = aws_apigatewayv2_api.lambda.id\n\n  name        = \"$default\"\n  auto_deploy = true\n\n  access_log_settings {\n    destination_arn = aws_cloudwatch_log_group.api_gw.arn\n\n    format = jsonencode({\n      requestId               = \"$context.requestId\"\n      sourceIp                = \"$context.identity.sourceIp\"\n      requestTime             = \"$context.requestTime\"\n      protocol                = \"$context.protocol\"\n      httpMethod              = \"$context.httpMethod\"\n      resourcePath            = \"$context.resourcePath\"\n      routeKey                = \"$context.routeKey\"\n      status                  = \"$context.status\"\n      responseLength          = \"$context.responseLength\"\n      integrationErrorMessage = \"$context.integrationErrorMessage\"\n      }\n    )\n  }\n  depends_on = [aws_cloudwatch_log_group.api_gw]\n}\n\nresource \"aws_apigatewayv2_integration\" \"app\" {\n  api_id = aws_apigatewayv2_api.lambda.id\n\n  integration_uri    = aws_lambda_function.app.invoke_arn\n  integration_type   = \"AWS_PROXY\"\n}\n\nresource \"aws_apigatewayv2_route\" \"any\" {\n  api_id = aws_apigatewayv2_api.lambda.id\n  route_key = \"$default\"\n  target    = \"integrations/${aws_apigatewayv2_integration.app.id}\"\n}\n\nresource \"aws_cloudwatch_log_group\" \"api_gw\" {\n  name = \"/aws/api_gw/${aws_apigatewayv2_api.lambda.name}\"\n\n  retention_in_days = var.apigw_log_retention\n}\n\nresource \"aws_lambda_permission\" \"api_gw\" {\n  statement_id  = \"AllowExecutionFromAPIGateway\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.app.function_name\n  principal     = \"apigateway.amazonaws.com\"\n\n  source_arn = \"${aws_apigatewayv2_api.lambda.execution_arn}/*/*\"\n}",
        "outputs.tf": "# Output value definitions\n\noutput \"apigwy_url\" {\n  description = \"URL for API Gateway stage\"\n\n  value = aws_apigatewayv2_api.lambda.api_endpoint\n}\n",
        "variables.tf": "# Input variable definitions\n\nvariable \"aws_region\" {\n  description = \"AWS region for all resources.\"\n  type    = string\n  default = \"us-east-1\"\n}\n\nvariable \"s3_bucket_prefix\" {\n  description = \"S3 bucket prefix for lambda code\"\n  type = string\n  default = \"apigw-http-api-lambda\"\n  \n}\n\nvariable \"lambda_name\" {\n  description = \"name of lambda function\"\n  type = string\n  default = \"test_apigw_integration\"\n}\n\nvariable \"lambda_log_retention\" {\n  description = \"lambda log retention in days\"\n  type = number\n  default = 7\n}\n\nvariable \"apigw_log_retention\" {\n  description = \"api gwy log retention in days\"\n  type = number\n  default = 7\n}\n"
      },
      "has_app": true
    },
    "62707d3237ff9c70": {
      "hash": "62707d3237ff9c70",
      "source_url": "https://github.com/aws-samples/serverless-patterns/tree/main/dynamodb-streams-lambda-terraform",
      "source_type": "github_repos",
      "discovered_at": "2026-01-11T08:20:47.528565",
      "services": [
        "iam",
        "lambda",
        "dynamodb"
      ],
      "resource_count": 5,
      "name": "aws-samples/serverless-patterns/dynamodb-streams-lambda-terraform",
      "description": "Serverless patterns. Learn more at the website: https://serverlessland.com/patterns.",
      "version": "main",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 5.0\"\n    }\n  }\n\n  required_version = \">= 0.14.9\"\n}\n\nprovider \"aws\" {\n  profile = \"default\"\n  region  = \"us-east-1\"\n}\n\nresource \"aws_dynamodb_table\" \"dynamodb_table_users\" {\n  name             = \"UsersIds\"\n  billing_mode     = \"PROVISIONED\"\n  read_capacity    = 5\n  write_capacity   = 5\n  stream_enabled   = true\n  stream_view_type = \"NEW_AND_OLD_IMAGES\"\n  hash_key         = \"UserId\"\n\n  attribute {\n    name = \"UserId\"\n    type = \"S\"\n  }\n\n  tags = {\n    Name        = \"dynamodb-test-table\"\n    Environment = \"dev\"\n  }\n}\n\nresource \"aws_lambda_function\" \"lambda_dynamodb_stream_handler\" {\n  function_name    = \"process-usersids-records\"\n  filename         = data.archive_file.lambda_zip_file.output_path\n  source_code_hash = data.archive_file.lambda_zip_file.output_base64sha256\n  handler          = \"index.handler\"\n  role             = aws_iam_role.iam_for_lambda.arn\n  runtime          = \"nodejs24.x\"\n}\n\ndata \"archive_file\" \"lambda_zip_file\" {\n  type        = \"zip\"\n  source_file = \"${path.module}/src/index.js\"\n  output_path = \"${path.module}/lambda.zip\"\n}\n\nresource \"aws_lambda_event_source_mapping\" \"lambda_dynamodb\" {\n  event_source_arn  = aws_dynamodb_table.dynamodb_table_users.stream_arn\n  function_name     = aws_lambda_function.lambda_dynamodb_stream_handler.arn\n  starting_position = \"LATEST\"\n}\n\nresource \"aws_iam_role\" \"iam_for_lambda\" {\n  name = \"iam_for_lambda\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"dynamodb_lambda_policy\" {\n  name   = \"lambda-dynamodb-policy\"\n  role   = aws_iam_role.iam_for_lambda.id\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n        \"Sid\": \"AllowLambdaFunctionToCreateLogs\",\n        \"Action\": [ \n            \"logs:*\" \n        ],\n        \"Effect\": \"Allow\",\n        \"Resource\": [ \n            \"arn:aws:logs:*:*:*\" \n        ]\n    },\n    {\n        \"Sid\": \"AllowLambdaFunctionInvocation\",\n        \"Effect\": \"Allow\",\n        \"Action\": [\n            \"lambda:InvokeFunction\"\n        ],\n        \"Resource\": [\n            \"${aws_dynamodb_table.dynamodb_table_users.arn}/stream/*\"\n        ]\n    },\n    {\n        \"Sid\": \"APIAccessForDynamoDBStreams\",\n        \"Effect\": \"Allow\",\n        \"Action\": [\n            \"dynamodb:GetRecords\",\n            \"dynamodb:GetShardIterator\",\n            \"dynamodb:DescribeStream\",\n            \"dynamodb:ListStreams\"\n        ],\n        \"Resource\": \"${aws_dynamodb_table.dynamodb_table_users.arn}/stream/*\"\n    }\n  ]\n}\nEOF\n}\n\noutput \"dynamodb_usersIds_arn\" {\n  value = aws_dynamodb_table.dynamodb_table_users.arn\n    description = \"The ARN of the DynamoDB Users Ids table\"\n}\n\noutput \"lambda_processing_arn\" {\n  value = aws_lambda_function.lambda_dynamodb_stream_handler.arn\n    description = \"The ARN of the Lambda function processing the DynamoDB stream\"\n}\n"
      },
      "has_app": true
    },
    "5ce7234a153efd12": {
      "hash": "5ce7234a153efd12",
      "source_url": "https://registry.terraform.io/modules/transcend-io/lambda-at-edge/aws/0.5.0",
      "source_type": "terraform_registry",
      "discovered_at": "2026-01-11T21:32:51.618374",
      "services": [
        "ssm",
        "cloudwatch",
        "s3",
        "iam",
        "lambda"
      ],
      "resource_count": 8,
      "name": "transcend-io/lambda-at-edge",
      "description": "Terraform module for making a Lambda@Edge function in terraform",
      "version": "0.5.0",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "/**\n * Creates a Lambda@Edge function to integrate with CloudFront distributions.\n */\n\n/**\n * Lambdas are uploaded to via zip files, so we create a zip out of a given directory.\n * In the future, we may want to source our code from an s3 bucket instead of a local zip.\n */\ndata \"archive_file\" \"zip_file_for_lambda\" {\n  type        = \"zip\"\n  output_path = \"${var.local_file_dir}/${var.name}.zip\"\n\n  dynamic \"source\" {\n    for_each = distinct(flatten([\n      for blob in var.file_globs :\n      fileset(var.lambda_code_source_dir, blob)\n    ]))\n    content {\n      content = try(\n        file(\"${var.lambda_code_source_dir}/${source.value}\"),\n        filebase64(\"${var.lambda_code_source_dir}/${source.value}\"),\n      )\n      filename = source.value\n    }\n  }\n\n  # Optionally write a `config.json` file if any plaintext params were given\n  dynamic \"source\" {\n    for_each = length(keys(var.plaintext_params)) > 0 ? [\"true\"] : []\n    content {\n      content  = jsonencode(var.plaintext_params)\n      filename = var.config_file_name\n    }\n  }\n}\n\n/**\n * Upload the build artifact zip file to S3.\n *\n * Doing this makes the plans more resiliant, where it won't always\n * appear that the function needs to be updated\n */\nresource \"aws_s3_bucket_object\" \"artifact\" {\n  bucket = var.s3_artifact_bucket\n  key    = \"${var.name}.zip\"\n  source = data.archive_file.zip_file_for_lambda.output_path\n  etag   = data.archive_file.zip_file_for_lambda.output_md5\n  tags   = var.tags\n}\n\n/**\n * Create the Lambda function. Each new apply will publish a new version.\n */\nresource \"aws_lambda_function\" \"lambda\" {\n  function_name = var.name\n  description   = var.description\n\n  # Find the file from S3\n  s3_bucket         = var.s3_artifact_bucket\n  s3_key            = aws_s3_bucket_object.artifact.id\n  s3_object_version = aws_s3_bucket_object.artifact.version_id\n  source_code_hash  = filebase64sha256(data.archive_file.zip_file_for_lambda.output_path)\n\n  publish = true\n  handler = var.handler\n  runtime = var.runtime\n  role    = aws_iam_role.lambda_at_edge.arn\n  tags    = var.tags\n\n  lifecycle {\n    ignore_changes = [\n      last_modified,\n    ]\n  }\n}\n\n/**\n * Policy to allow AWS to access this lambda function.\n */\ndata \"aws_iam_policy_document\" \"assume_role_policy_doc\" {\n  statement {\n    sid    = \"AllowAwsToAssumeRole\"\n    effect = \"Allow\"\n\n    actions = [\"sts:AssumeRole\"]\n\n    principals {\n      type = \"Service\"\n\n      identifiers = [\n        \"edgelambda.amazonaws.com\",\n        \"lambda.amazonaws.com\",\n      ]\n    }\n  }\n}\n\n/**\n * Make a role that AWS services can assume that gives them access to invoke our function.\n * This policy also has permissions to write logs to CloudWatch.\n */\nresource \"aws_iam_role\" \"lambda_at_edge\" {\n  name               = \"${var.name}-role\"\n  assume_role_policy = data.aws_iam_policy_document.assume_role_policy_doc.json\n  tags               = var.tags\n}\n\n/**\n * Allow lambda to write logs.\n */\ndata \"aws_iam_policy_document\" \"lambda_logs_policy_doc\" {\n  statement {\n    effect    = \"Allow\"\n    resources = [\"*\"]\n    actions = [\n      \"logs:CreateLogStream\",\n      \"logs:PutLogEvents\",\n\n      # Lambda@Edge logs are logged into Log Groups in the region of the edge location\n      # that executes the code. Because of this, we need to allow the lambda role to create\n      # Log Groups in other regions\n      \"logs:CreateLogGroup\",\n    ]\n  }\n}\n\n/**\n * Attach the policy giving log write access to the IAM Role\n */\nresource \"aws_iam_role_policy\" \"logs_role_policy\" {\n  name   = \"${var.name}at-edge\"\n  role   = aws_iam_role.lambda_at_edge.id\n  policy = data.aws_iam_policy_document.lambda_logs_policy_doc.json\n}\n\n/**\n * Creates a Cloudwatch log group for this function to log to.\n * With lambda@edge, only test runs will log to this group. All\n * logs in production will be logged to a log group in the region\n * of the CloudFront edge location handling the request.\n */\nresource \"aws_cloudwatch_log_group\" \"log_group\" {\n  name = \"/aws/lambda/${var.name}\"\n  tags = var.tags\n  kms_key_id = var.cloudwatch_log_groups_kms_arn\n}\n\n/**\n * Create the secret SSM parameters that can be fetched and decrypted by the lambda function.\n */\nresource \"aws_ssm_parameter\" \"params\" {\n  for_each = var.ssm_params\n\n  description = \"param ${each.key} for the lambda function ${var.name}\"\n\n  name  = each.key\n  value = each.value\n\n  type = \"SecureString\"\n  tier = length(each.value) > 4096 ? \"Advanced\" : \"Standard\"\n\n  tags = var.tags\n}\n\n/**\n * Create an IAM policy document giving access to read and fetch the SSM params\n */\ndata \"aws_iam_policy_document\" \"secret_access_policy_doc\" {\n  count = length(var.ssm_params) > 0 ? 1 : 0\n\n  statement {\n    sid    = \"AccessParams\"\n    effect = \"Allow\"\n    actions = [\n      \"ssm:GetParameter\",\n      \"secretsmanager:GetSecretValue\",\n    ]\n    resources = [\n      for name, outputs in aws_ssm_parameter.params :\n      outputs.arn\n    ]\n  }\n}\n\n/**\n * Create a policy from the SSM policy document\n */\nresource \"aws_iam_policy\" \"ssm_policy\" {\n  count = length(var.ssm_params) > 0 ? 1 : 0\n\n  name        = \"${var.name}-ssm-policy\"\n  description = \"Gives the lambda ${var.name} access to params from SSM\"\n  policy      = data.aws_iam_policy_document.secret_access_policy_doc[0].json\n}\n\n/**\n * Attach the policy giving SSM param access to the Lambda IAM Role\n */\nresource \"aws_iam_role_policy_attachment\" \"ssm_policy_attachment\" {\n  count = length(var.ssm_params) > 0 ? 1 : 0\n\n  role       = aws_iam_role.lambda_at_edge.id\n  policy_arn = aws_iam_policy.ssm_policy[0].arn\n}\n",
        "outputs.tf": "// ARN of the lambda function with the most recently built version attached.\noutput \"arn\" {\n  value = \"${aws_lambda_function.lambda.arn}:${aws_lambda_function.lambda.version}\"\n}\n\noutput \"function_arn\" {\n  value = aws_lambda_function.lambda.arn\n}\noutput \"function_name\" {\n  value = var.name\n}\n\noutput execution_role_name {\n  value = aws_iam_role.lambda_at_edge.name\n}\n\noutput execution_role_arn {\n  value = aws_iam_role.lambda_at_edge.arn\n}\n",
        "variables.tf": "variable name {\n  description = \"Name of the Lambda@Edge Function\"\n}\n\nvariable description {\n  description = \"Description of what the Lambda@Edge Function does\"\n}\n\nvariable s3_artifact_bucket {\n  description = \"Name of the S3 bucket to upload versioned artifacts to\"\n}\n\nvariable tags {\n  type        = map(string)\n  description = \"Tags to apply to all resources that support them\"\n  default     = {}\n}\n\nvariable lambda_code_source_dir {\n  description = \"An absolute path to the directory containing the code to upload to lambda\"\n}\n\nvariable file_globs {\n  type        = list(string)\n  default     = [\"index.js\", \"node_modules/**\", \"yarn.lock\", \"package.json\"]\n  description = \"list of files or globs that you want included from the lambda_code_source_dir\"\n}\n\nvariable local_file_dir {\n  description = \"A path to the directory to store plan time generated local files\"\n  default     = \".\"\n}\n\nvariable runtime {\n  description = \"The runtime of the lambda function\"\n  default     = \"nodejs14.x\"\n}\n\nvariable handler {\n  description = \"The path to the main method that should handle the incoming requests\"\n  default     = \"index.handler\"\n}\n\nvariable config_file_name {\n  description = \"The name of the file var.plaintext_params will be written to as json\"\n  default     = \"config.json\"\n}\n\nvariable plaintext_params {\n  type        = map(string)\n  default     = {}\n  description = <<EOF\n  Lambda@Edge does not support env vars, so it is a common pattern to exchange Env vars for values read from a config file.\n\n  So instead of using env vars like:\n  `const someEnvValue = process.env.SOME_ENV`\n\n  you would have lookups from a config file:\n  ```\n  const config = JSON.parse(readFileSync('./config.json'))\n  const someConfigValue = config.SomeKey\n  ```\n\n  Compared to var.ssm_params, you should use this variable when you have non-secret things that you want very quick access\n  to during the execution of your lambda function.\n  EOF\n}\n\nvariable ssm_params {\n  type        = map(string)\n  default     = {}\n  description = <<EOF\n  Lambda@Edge does not support env vars, so it is a common pattern to exchange Env vars for SSM params.\n\n  So instead of using env vars like:\n  `const someEnvValue = process.env.SOME_ENV`\n\n  you would have lookups in SSM, like:\n  `const someEnvValue = await ssmClient.getParameter({ Name: 'SOME_SSM_PARAM_NAME', WithDecryption: true })`\n\n  These params should have names that are unique within an AWS account, so it is a good idea to use a common\n  prefix in front of the param names, such as:\n\n  ```\n  params = {\n    COMMON_PREFIX_REGION = \"eu-west-1\"\n    COMMON_PREFIX_NAME   = \"Joeseph Schreibvogel\"\n  }\n  ```\n\n  Compared to var.plaintext_params, you should use this variable when you have secret data that you don't want written in plaintext in a file\n  in your lambda .zip file. These params will need to be fetched via a Promise at runtime, so there may be small performance delays.\n  EOF\n}\n\nvariable cloudwatch_log_groups_kms_arn {\n  type        = string\n  description = \"KMS ARN to encrypt the log group in cloudwatch\"\n  default     = null\n}\n\n",
        "versions.tf": "terraform {\n  required_providers {\n    archive = {\n      source = \"hashicorp/archive\"\n    }\n    aws = {\n      source = \"hashicorp/aws\"\n    }\n  }\n  required_version = \">= 0.13\"\n}\n"
      },
      "has_app": true
    },
    "12a2e723c7476f59": {
      "hash": "12a2e723c7476f59",
      "source_url": "https://registry.terraform.io/modules/justtrackio/sqs/aws/1.9.0",
      "source_type": "terraform_registry",
      "discovered_at": "2026-01-11T21:33:13.738780",
      "services": [
        "sns",
        "cloudwatch"
      ],
      "resource_count": 3,
      "name": "justtrackio/sqs",
      "description": "Terraform module which creates a sqs queue",
      "version": "1.9.0",
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "cloudwatch.tf": "locals {\n  alarm_description     = var.alarm.description != null ? var.alarm.description : \"SQS Queue Metrics: https://${module.this.aws_region}.console.aws.amazon.com/sqs/v2/home?region=${module.this.aws_region}#/queues/https%3A%2F%2Fsqs.${module.this.aws_region}.amazonaws.com%2F${module.this.aws_account_id}%2F${module.sqs.queue_name}\"\n  alarm_topic_arn       = var.alarm_topic_arn != null ? var.alarm_topic_arn : \"arn:aws:sns:${module.this.aws_region}:${module.this.aws_account_id}:${module.this.environment}-alarms\"\n  dlq_alarm_enabled     = var.alarm_enabled && var.dlq_alarm_enabled\n  dlq_alarm_description = var.dlq_alarm.description != null ? var.dlq_alarm.description : (var.dlq_enabled ? \"SQS Queue Metrics: https://${module.this.aws_region}.console.aws.amazon.com/sqs/v2/home?region=${module.this.aws_region}#/queues/https%3A%2F%2Fsqs.${module.this.aws_region}.amazonaws.com%2F${module.this.aws_account_id}%2F${module.sqs.dead_letter_queue_name}\" : \"\")\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"backlog\" {\n  count = module.this.enabled && var.alarm_enabled ? 1 : 0\n\n  alarm_description = jsonencode(merge({\n    Priority    = var.alarm.priority\n    Description = local.alarm_description\n  }, module.this.tags, module.this.additional_tag_map))\n  alarm_name          = \"${module.sqs.queue_name}-backlog\"\n  comparison_operator = \"GreaterThanThreshold\"\n  datapoints_to_alarm = var.alarm.datapoints_to_alarm\n  evaluation_periods  = var.alarm.evaluation_periods\n  threshold           = var.alarm.threshold\n  treat_missing_data  = \"notBreaching\"\n\n  metric_query {\n    id          = \"visible\"\n    return_data = false\n\n    metric {\n      dimensions = {\n        QueueName = module.sqs.queue_name\n      }\n      metric_name = \"ApproximateNumberOfMessagesVisible\"\n      namespace   = \"AWS/SQS\"\n      period      = var.alarm.period\n      stat        = \"Sum\"\n    }\n  }\n\n  metric_query {\n    id          = \"incoming\"\n    return_data = false\n\n    metric {\n      dimensions = {\n        QueueName = module.sqs.queue_name\n      }\n      metric_name = \"NumberOfMessagesSent\"\n      namespace   = \"AWS/SQS\"\n      period      = var.alarm.period\n      stat        = \"Sum\"\n    }\n  }\n\n  metric_query {\n    id          = \"delayed\"\n    return_data = false\n\n    metric {\n      dimensions = {\n        QueueName = module.sqs.queue_name\n      }\n      metric_name = \"ApproximateNumberOfMessagesDelayed\"\n      namespace   = \"AWS/SQS\"\n      period      = var.alarm.period\n      stat        = \"Sum\"\n    }\n  }\n\n  metric_query {\n    id          = \"deleted\"\n    return_data = false\n\n    metric {\n      dimensions = {\n        QueueName = module.sqs.queue_name\n      }\n      metric_name = \"NumberOfMessagesDeleted\"\n      namespace   = \"AWS/SQS\"\n      period      = var.alarm.period\n      stat        = \"Sum\"\n    }\n  }\n\n  metric_query {\n    expression  = \"visible - delayed + incoming - (deleted * ${var.alarm.backlog_minutes})\"\n    id          = \"backlog\"\n    label       = \"visible - delayed + incoming - (deleted * ${var.alarm.backlog_minutes})\"\n    return_data = true\n  }\n\n  alarm_actions = [local.alarm_topic_arn]\n  ok_actions    = [local.alarm_topic_arn]\n\n  tags = module.this.tags\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"dlq_backlog\" {\n  count = module.this.enabled && local.dlq_alarm_enabled ? 1 : 0\n\n  alarm_description = jsonencode(merge({\n    Priority    = var.dlq_alarm.priority\n    Description = local.dlq_alarm_description\n  }, module.this.tags, module.this.additional_tag_map))\n  alarm_name          = \"${module.sqs.dead_letter_queue_name}-backlog\"\n  comparison_operator = \"GreaterThanThreshold\"\n  datapoints_to_alarm = var.dlq_alarm.datapoints_to_alarm\n  evaluation_periods  = var.dlq_alarm.evaluation_periods\n  threshold           = var.dlq_alarm.threshold\n  treat_missing_data  = \"notBreaching\"\n\n  metric_query {\n    id          = \"visible\"\n    return_data = true\n\n    metric {\n      dimensions = {\n        QueueName = module.sqs.dead_letter_queue_name\n      }\n      metric_name = \"ApproximateNumberOfMessagesVisible\"\n      namespace   = \"AWS/SQS\"\n      period      = var.dlq_alarm.period\n      stat        = \"Average\"\n    }\n  }\n\n  alarm_actions = [local.alarm_topic_arn]\n  ok_actions    = [local.alarm_topic_arn]\n\n  tags = module.this.tags\n}\n",
        "context.tf": "#\n# ONLY EDIT THIS FILE IN github.com/justtrackio/terraform-null-label\n# All other instances of this file should be a copy of that one\n#\n#\n# Copy this file from https://github.com/justtrackio/terraform-null-label/blob/main/exports/context.tf\n# and then place it in your Terraform module to automatically get\n# justtrack's standard configuration inputs suitable for passing\n# to justtrack modules.\n#\n# curl -sL https://raw.githubusercontent.com/justtrackio/terraform-null-label/main/exports/context.tf -o context.tf\n#\n# Modules should access the whole context as `module.this.context`\n# to get the input variables with nulls for defaults,\n# for example `context = module.this.context`,\n# and access individual variables as `module.this.<var>`,\n# with final values filled in.\n#\n# For example, when using defaults, `module.this.context.delimiter`\n# will be null, and `module.this.delimiter` will be `-` (hyphen).\n#\n\nmodule \"this\" {\n  source  = \"justtrackio/label/null\"\n  version = \"0.26.0\" # requires Terraform >= 0.13.0\n\n  enabled             = var.enabled\n  namespace           = var.namespace\n  tenant              = var.tenant\n  environment         = var.environment\n  stage               = var.stage\n  name                = var.name\n  delimiter           = var.delimiter\n  attributes          = var.attributes\n  tags                = var.tags\n  additional_tag_map  = var.additional_tag_map\n  label_order         = var.label_order\n  regex_replace_chars = var.regex_replace_chars\n  id_length_limit     = var.id_length_limit\n  label_key_case      = var.label_key_case\n  label_value_case    = var.label_value_case\n  descriptor_formats  = var.descriptor_formats\n  labels_as_tags      = var.labels_as_tags\n  aws_account_id      = var.aws_account_id\n  aws_region          = var.aws_region\n  organizational_unit = var.organizational_unit\n\n  context = var.context\n}\n\n# Copy contents of justtrackio/terraform-null-label/variables.tf here\n\nvariable \"context\" { # tflint-ignore: terraform_standard_module_structure\n  type = any\n  default = {\n    enabled             = true\n    namespace           = null\n    tenant              = null\n    environment         = null\n    stage               = null\n    name                = null\n    delimiter           = null\n    attributes          = []\n    tags                = {}\n    additional_tag_map  = {}\n    regex_replace_chars = null\n    label_order         = []\n    id_length_limit     = null\n    label_key_case      = null\n    label_value_case    = null\n    descriptor_formats  = {}\n    # Note: we have to use [] instead of null for unset lists due to\n    # https://github.com/hashicorp/terraform/issues/28137\n    # which was not fixed until Terraform 1.0.0,\n    # but we want the default to be all the labels in `label_order`\n    # and we want users to be able to prevent all tag generation\n    # by setting `labels_as_tags` to `[]`, so we need\n    # a different sentinel to indicate \"default\"\n    labels_as_tags = [\"unset\"]\n  }\n  description = <<-EOT\n    Single object for setting entire context at once.\n    See description of individual variables for details.\n    Leave string and numeric variables as `null` to use default value.\n    Individual variable settings (non-null) override settings in context object,\n    except for attributes, tags, and additional_tag_map, which are merged.\n  EOT\n\n  validation {\n    condition     = lookup(var.context, \"label_key_case\", null) == null ? true : contains([\"lower\", \"title\", \"upper\"], var.context[\"label_key_case\"])\n    error_message = \"Allowed values: `lower`, `title`, `upper`.\"\n  }\n\n  validation {\n    condition     = lookup(var.context, \"label_value_case\", null) == null ? true : contains([\"lower\", \"title\", \"upper\", \"none\"], var.context[\"label_value_case\"])\n    error_message = \"Allowed values: `lower`, `title`, `upper`, `none`.\"\n  }\n}\n\nvariable \"enabled\" { # tflint-ignore: terraform_standard_module_structure\n  type        = bool\n  default     = null\n  description = \"Set to false to prevent the module from creating any resources\"\n}\n\nvariable \"namespace\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = \"ID element. Usually an abbreviation of your organization name, e.g. 'eg' or 'cp', to help ensure generated IDs are globally unique\"\n}\n\nvariable \"tenant\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = \"ID element _(Rarely used, not included by default)_. A customer identifier, indicating who this instance of a resource is for\"\n}\n\nvariable \"environment\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = \"ID element. Usually used for region e.g. 'uw2', 'us-west-2', OR role 'prod', 'staging', 'dev', 'UAT'\"\n}\n\nvariable \"stage\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = \"ID element. Usually used to indicate role, e.g. 'prod', 'staging', 'source', 'build', 'test', 'deploy', 'release'\"\n}\n\nvariable \"name\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = <<-EOT\n    ID element. Usually the component or solution name, e.g. 'app' or 'jenkins'.\n    This is the only ID element not also included as a `tag`.\n    The \"name\" tag is set to the full `id` string. There is no tag with the value of the `name` input.\n    EOT\n}\n\nvariable \"delimiter\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = <<-EOT\n    Delimiter to be used between ID elements.\n    Defaults to `-` (hyphen). Set to `\"\"` to use no delimiter at all.\n  EOT\n}\n\nvariable \"attributes\" { # tflint-ignore: terraform_standard_module_structure\n  type        = list(string)\n  default     = []\n  description = <<-EOT\n    ID element. Additional attributes (e.g. `workers` or `cluster`) to add to `id`,\n    in the order they appear in the list. New attributes are appended to the\n    end of the list. The elements of the list are joined by the `delimiter`\n    and treated as a single ID element.\n    EOT\n}\n\nvariable \"labels_as_tags\" { # tflint-ignore: terraform_standard_module_structure\n  type        = set(string)\n  default     = [\"default\"]\n  description = <<-EOT\n    Set of labels (ID elements) to include as tags in the `tags` output.\n    Default is to include all labels.\n    Tags with empty values will not be included in the `tags` output.\n    Set to `[]` to suppress all generated tags.\n    **Notes:**\n      The value of the `name` tag, if included, will be the `id`, not the `name`.\n      Unlike other `null-label` inputs, the initial setting of `labels_as_tags` cannot be\n      changed in later chained modules. Attempts to change it will be silently ignored.\n    EOT\n}\n\nvariable \"tags\" { # tflint-ignore: terraform_standard_module_structure\n  type        = map(string)\n  default     = {}\n  description = <<-EOT\n    Additional tags (e.g. `{'BusinessUnit': 'XYZ'}`).\n    Neither the tag keys nor the tag values will be modified by this module.\n    EOT\n}\n\nvariable \"additional_tag_map\" { # tflint-ignore: terraform_standard_module_structure\n  type        = map(string)\n  default     = {}\n  description = <<-EOT\n    Additional key-value pairs to add to each map in `tags_as_list_of_maps`. Not added to `tags` or `id`.\n    This is for some rare cases where resources want additional configuration of tags\n    and therefore take a list of maps with tag key, value, and additional configuration.\n    EOT\n}\n\nvariable \"label_order\" { # tflint-ignore: terraform_standard_module_structure\n  type        = list(string)\n  default     = null\n  description = <<-EOT\n    The order in which the labels (ID elements) appear in the `id`.\n    Defaults to [\"namespace\", \"environment\", \"stage\", \"name\", \"attributes\"].\n    You can omit any of the 6 labels (\"tenant\" is the 6th), but at least one must be present.\n    EOT\n}\n\nvariable \"regex_replace_chars\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = <<-EOT\n    Terraform regular expression (regex) string.\n    Characters matching the regex will be removed from the ID elements.\n    If not set, `\"/[^a-zA-Z0-9-]/\"` is used to remove all characters other than hyphens, letters and digits.\n  EOT\n}\n\nvariable \"id_length_limit\" { # tflint-ignore: terraform_standard_module_structure\n  type        = number\n  default     = null\n  description = <<-EOT\n    Limit `id` to this many characters (minimum 6).\n    Set to `0` for unlimited length.\n    Set to `null` for keep the existing setting, which defaults to `0`.\n    Does not affect `id_full`.\n  EOT\n  validation {\n    condition     = var.id_length_limit == null ? true : var.id_length_limit >= 6 || var.id_length_limit == 0\n    error_message = \"The id_length_limit must be >= 6 if supplied (not null), or 0 for unlimited length.\"\n  }\n}\n\nvariable \"label_key_case\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = <<-EOT\n    Controls the letter case of the `tags` keys (label names) for tags generated by this module.\n    Does not affect keys of tags passed in via the `tags` input.\n    Possible values: `lower`, `title`, `upper`.\n    Default value: `title`.\n  EOT\n\n  validation {\n    condition     = var.label_key_case == null ? true : contains([\"lower\", \"title\", \"upper\"], var.label_key_case)\n    error_message = \"Allowed values: `lower`, `title`, `upper`.\"\n  }\n}\n\nvariable \"label_value_case\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  default     = null\n  description = <<-EOT\n    Controls the letter case of ID elements (labels) as included in `id`,\n    set as tag values, and output by this module individually.\n    Does not affect values of tags passed in via the `tags` input.\n    Possible values: `lower`, `title`, `upper` and `none` (no transformation).\n    Set this to `title` and set `delimiter` to `\"\"` to yield Pascal Case IDs.\n    Default value: `lower`.\n  EOT\n\n  validation {\n    condition     = var.label_value_case == null ? true : contains([\"lower\", \"title\", \"upper\", \"none\"], var.label_value_case)\n    error_message = \"Allowed values: `lower`, `title`, `upper`, `none`.\"\n  }\n}\n\nvariable \"descriptor_formats\" { # tflint-ignore: terraform_standard_module_structure\n  type        = any\n  default     = {}\n  description = <<-EOT\n    Describe additional descriptors to be output in the `descriptors` output map.\n    Map of maps. Keys are names of descriptors. Values are maps of the form\n    `{\n       format = string\n       labels = list(string)\n    }`\n    (Type is `any` so the map values can later be enhanced to provide additional options.)\n    `format` is a Terraform format string to be passed to the `format()` function.\n    `labels` is a list of labels, in order, to pass to `format()` function.\n    Label values will be normalized before being passed to `format()` so they will be\n    identical to how they appear in `id`.\n    Default is `{}` (`descriptors` output will be empty).\n    EOT\n}\n\nvariable \"aws_account_id\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  description = \"AWS account id\"\n  default     = null\n}\n\nvariable \"aws_region\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  description = \"AWS region\"\n  default     = null\n}\n\nvariable \"organizational_unit\" { # tflint-ignore: terraform_standard_module_structure\n  type        = string\n  description = \"Usually used to indicate the AWS organizational unit, e.g. 'prod', 'sdlc'\"\n  default     = null\n}\n\n#### End of copy of justtrackio/terraform-null-label/variables.tf\n",
        "main.tf": "data \"aws_iam_policy_document\" \"subscription\" {\n  count = length(var.subscription) >= 1 ? 1 : 0\n\n  statement {\n    actions = [\n      \"sqs:SendMessage\",\n      \"sqs:ReceiveMessage\",\n    ]\n\n    resources = [module.sqs.queue_arn]\n\n    principals {\n      type        = \"AWS\"\n      identifiers = [\"*\"]\n    }\n\n    dynamic \"condition\" {\n      for_each = var.subscription\n      content {\n        test     = \"ArnEquals\"\n        values   = [for key in keys(aws_sns_topic_subscription.default) : aws_sns_topic_subscription.default[key].topic_arn]\n        variable = \"aws:SourceArn\"\n      }\n    }\n  }\n}\n\nmodule \"sqs\" {\n  source  = \"terraform-aws-modules/sqs/aws\"\n  version = \"4.2.0\"\n\n  create_dlq                = var.dlq_enabled\n  create_queue_policy       = length(var.subscription) >= 1\n  delay_seconds             = var.delay_seconds\n  dlq_name                  = var.dlq_name\n  fifo_queue                = var.fifo_queue\n  message_retention_seconds = var.message_retention_seconds\n  name                      = module.this.id\n  redrive_policy = var.dlq_enabled ? {\n    maxReceiveCount = var.dlq_max_receive_count\n  } : {}\n  source_queue_policy_documents = try([data.aws_iam_policy_document.subscription[0].json], [])\n  tags                          = module.this.tags\n  visibility_timeout_seconds    = var.visibility_timeout_seconds\n}\n\nresource \"aws_sns_topic_subscription\" \"default\" {\n  for_each                        = var.subscription\n  topic_arn                       = \"arn:aws:sns:${module.this.aws_region}:${each.value.aws_account_id != null ? each.value.aws_account_id : module.this.aws_account_id}:${each.value.topic_name}\"\n  confirmation_timeout_in_minutes = \"1\"\n  endpoint_auto_confirms          = \"false\"\n  protocol                        = \"sqs\"\n  endpoint                        = module.sqs.queue_arn\n  filter_policy                   = each.value.filter_policy\n}\n",
        "outputs.tf": "output \"sqs_queue_url\" {\n  value       = module.sqs.queue_url\n  description = \"queue url of the main sqs queue\"\n}\noutput \"sqs_queue_arn\" {\n  value       = module.sqs.queue_arn\n  description = \"queue arn of the main sqs queue\"\n}\n\noutput \"sqs_queue_name\" {\n  value       = module.sqs.queue_name\n  description = \"queue name of the main sqs queue\"\n}\n\noutput \"dlq_queue_url\" {\n  value       = module.sqs.dead_letter_queue_url\n  description = \"queue url of the dead letter sqs queue\"\n}\n\noutput \"dlq_queue_arn\" {\n  value       = module.sqs.dead_letter_queue_arn\n  description = \"queue arn of the dead letter sqs queue\"\n}\n\noutput \"dlq_queue_name\" {\n  value       = module.sqs.dead_letter_queue_name\n  description = \"queue name of the dead letter sqs queue\"\n}\n",
        "variables.tf": "variable \"alarm\" {\n  type = object({\n    backlog_minutes     = optional(number, 5)\n    datapoints_to_alarm = optional(number, 3)\n    description         = optional(string, null)\n    evaluation_periods  = optional(number, 3)\n    period              = optional(number, 60)\n    threshold           = optional(number, 0)\n    priority            = optional(string, \"warning\")\n  })\n  description = \"The details of the alarm such as datapoints to alarm, evaluation periods, backlog minutes, period, and threshold.\"\n  default     = {}\n}\n\nvariable \"alarm_enabled\" {\n  type        = bool\n  description = \"Defines if the alarm should be created.\"\n  default     = false\n}\n\nvariable \"alarm_topic_arn\" {\n  type        = string\n  description = \"The ARN of the SNS Topic used for notifying about alarm/ok messages.\"\n  default     = null\n}\n\nvariable \"delay_seconds\" {\n  description = \"The time in seconds that the delivery of all messages in the queue will be delayed. An integer from 0 to 900 (15 minutes)\"\n  type        = number\n  default     = null\n}\n\nvariable \"dlq_alarm\" {\n  type = object({\n    backlog_minutes     = optional(number, 5)\n    datapoints_to_alarm = optional(number, 3)\n    description         = optional(string, null)\n    evaluation_periods  = optional(number, 3)\n    period              = optional(number, 60)\n    threshold           = optional(number, 10)\n    priority            = optional(string, \"warning\")\n  })\n  description = \"The details of the DLQ alarm such as datapoints to alarm, evaluation periods, backlog minutes, period, and threshold.\"\n  default     = {}\n}\n\nvariable \"dlq_alarm_enabled\" {\n  type        = bool\n  description = \"Defines if the DLQ alarm should be created.\"\n  default     = true\n}\n\nvariable \"dlq_enabled\" {\n  type        = bool\n  description = \"Defines if Dead Letter Queue (DLQ) is enabled.\"\n  default     = true\n}\n\nvariable \"dlq_max_receive_count\" {\n  type        = number\n  description = \"The maximum number of times a message can be received from the DLQ before it's discarded.\"\n  default     = 5\n}\n\nvariable \"dlq_name\" {\n  type        = string\n  description = \"Sets a custom name for the to be created dlq.\"\n  default     = null\n}\n\nvariable \"fifo_queue\" {\n  type        = bool\n  description = \"Boolean designating a FIFO queue\"\n  default     = false\n}\n\nvariable \"message_retention_seconds\" {\n  description = \"The number of seconds Amazon SQS retains a message. Integer representing seconds, from 60 (1 minute) to 1209600 (14 days)\"\n  type        = number\n  default     = null\n}\n\nvariable \"subscription\" {\n  type = map(object({\n    aws_account_id = optional(string)\n    topic_name     = string\n    filter_policy  = optional(string)\n  }))\n  description = \"The subscription details such as topic name and filter policy.\"\n  default     = {}\n}\n\nvariable \"visibility_timeout_seconds\" {\n  description = \"The visibility timeout for the queue. An integer from 0 to 43200 (12 hours)\"\n  type        = number\n  default     = null\n}\n",
        "versions.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 4.67\"\n    }\n  }\n  required_version = \">= 1.3.0\"\n}\n"
      },
      "has_app": true
    },
    "d35dcd19a22c571c": {
      "hash": "d35dcd19a22c571c",
      "source_url": "https://github.com/aws-samples/aws-waf-automation-terraform-samples",
      "source_type": "github",
      "discovered_at": "2026-01-11T21:33:36.028035",
      "services": [
        "sns",
        "apigateway",
        "cloudwatch",
        "dynamodb",
        "cloudformation",
        "firehose",
        "lambda",
        "kms",
        "s3",
        "iam"
      ],
      "resource_count": 156,
      "name": "aws-waf-automation-terraform-samples",
      "description": "",
      "version": null,
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "main.tf": "data \"aws_partition\" \"current\" {}\n\ndata \"aws_region\" \"current\" {}\n\ndata \"aws_caller_identity\" \"current\" {}\n\nresource \"random_uuid\" \"test\" {\n}\n\nresource \"random_id\" \"server\" {\n  byte_length = 8\n}\n\nlocals {\n  AppLogBucket = \"${var.AppAccessLogBucket}-${random_id.server.hex}\"\n}\n\n\nresource \"aws_kms_key\" \"wafkey\" {\n  description         = \"KMS key 1\"\n  enable_key_rotation = true\n  policy              = <<EOF\n{\n  \"Version\" : \"2012-10-17\",\n  \"Id\" : \"key-default-1\",\n  \"Statement\" : [ {\n      \"Sid\" : \"Enable IAM User Permissions\",\n      \"Effect\" : \"Allow\",\n      \"Principal\" : {\n        \"AWS\" : \"arn:aws:iam::${data.aws_caller_identity.current.account_id}:root\"\n      },\n        \"Action\": [ \n          \"kms:Create*\",\n          \"kms:Describe*\",\n          \"kms:Enable*\",\n          \"kms:List*\",\n          \"kms:Put*\",\n          \"kms:Update*\",\n          \"kms:Revoke*\",\n          \"kms:Disable*\",\n          \"kms:GenerateDataKey*\",\n          \"kms:Get*\",\n          \"kms:Delete*\",\n          \"kms:ScheduleKeyDeletion\",\n          \"kms:ListAliases\",\n          \"kms:CreateGrant\",\n          \"kms:Encrypt*\",\n          \"kms:Decrypt*\",\n          \"kms:ReEncrypt*\",\n          \"kms:CancelKeyDeletion\"\n      ],\n      \"Resource\" : \"*\"\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": { \"Service\": \"logs.${data.aws_region.current.name}.amazonaws.com\" },\n      \"Action\": [ \n        \"kms:Encrypt*\",\n        \"kms:Decrypt*\",\n        \"kms:ReEncrypt*\",\n        \"kms:GenerateDataKey*\",\n        \"kms:Describe*\"\n      ],\n      \"Resource\": \"*\"\n    }  \n  ]\n}\nEOF\n}\n\nresource \"aws_sns_topic\" \"user_updates\" {\n  count             = local.SNSEmail == \"yes\" ? 1 : 0\n  name              = join(\"-\", [\"AWS-WAF-Security-Automations-IP-Expiration-Notification\", \"${aws_cloudformation_stack.trigger_codebuild_stack.outputs.UUID}\"])\n  kms_master_key_id = \"alias/aws/sns\"\n}\n\nresource \"aws_sns_topic_subscription\" \"user_updates_sqs_target\" {\n  count     = local.SNSEmail == \"yes\" ? 1 : 0\n  topic_arn = aws_sns_topic.user_updates[0].arn\n  protocol  = \"email\"\n  endpoint  = var.SNSEmailParam\n  depends_on = [\n    aws_sns_topic.user_updates\n  ]\n}\n\nresource \"aws_sns_topic_policy\" \"default\" {\n  count  = local.SNSEmail == \"yes\" ? 1 : 0\n  arn    = aws_sns_topic.user_updates[0].arn\n  policy = data.aws_iam_policy_document.sns_topic_policy[0].json\n  depends_on = [\n    aws_sns_topic.user_updates\n  ]\n}\n\ndata \"aws_iam_policy_document\" \"sns_topic_policy\" {\n  count     = local.SNSEmail == \"yes\" ? 1 : 0\n  policy_id = \"__default_policy_ID\"\n\n  statement {\n    actions = [\n      \"SNS:Subscribe\",\n      \"SNS:SetTopicAttributes\",\n      \"SNS:RemovePermission\",\n      \"SNS:Receive\",\n      \"SNS:Publish\",\n      \"SNS:ListSubscriptionsByTopic\",\n      \"SNS:GetTopicAttributes\",\n      \"SNS:DeleteTopic\",\n      \"SNS:AddPermission\",\n    ]\n\n    condition {\n      test     = \"StringEquals\"\n      variable = \"AWS:SourceOwner\"\n\n      values = [\n        data.aws_caller_identity.current.account_id,\n      ]\n    }\n\n    effect = \"Allow\"\n\n    principals {\n      type        = \"AWS\"\n      identifiers = [\"*\"]\n    }\n\n    resources = [\n      aws_sns_topic.user_updates[0].arn,\n    ]\n\n    sid = \"__default_statement_ID\"\n  }\n}\n\n\n\n### S3 bucket Creation\n\nresource \"aws_s3_bucket\" \"WafLogBucket\" {\n  count         = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  bucket        = \"${random_id.server.hex}-waflogbucket\"\n  acl           = \"private\"\n  force_destroy = true\n  versioning {\n    enabled = true\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm = var.sse_algorithm\n      }\n    }\n  }\n  logging {\n    target_bucket = aws_s3_bucket.accesslogbucket[0].bucket\n    target_prefix = \"WAF_Logs/\"\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"WafLogBucket\" {\n  count                   = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  bucket                  = aws_s3_bucket.WafLogBucket[0].id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n  depends_on = [\n    aws_s3_bucket.WafLogBucket\n  ]\n}\n\nresource \"aws_s3_bucket_policy\" \"wafbucketpolicy\" {\n  count         = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  bucket = aws_s3_bucket.WafLogBucket[0].id\n\n  policy = <<POLICY\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": [\n                \"arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:role/${aws_iam_role.s3bucketaccessrole.name}\"\n                ]\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"${aws_s3_bucket.WafLogBucket[0].arn}\",\n                \"${aws_s3_bucket.WafLogBucket[0].arn}/*\"\n            ]\n        },\n        {\n            \"Sid\": \"HttpsOnly\",\n            \"Effect\": \"Deny\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"${aws_s3_bucket.WafLogBucket[0].arn}\",\n                \"${aws_s3_bucket.WafLogBucket[0].arn}/*\"\n            ],\n            \"Condition\": {\n                \"Bool\": {\n                    \"aws:SecureTransport\": \"false\"\n                }\n            }\n        }\n    ]\n}\nPOLICY\n  depends_on = [\n    aws_s3_bucket.WafLogBucket\n  ]\n}\n\n\ndata \"aws_iam_policy\" \"s3Access\" {\n  arn = \"arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess\"\n}\n\nresource \"aws_iam_role\" \"s3bucketaccessrole\" {\n  name  = \"s3-bucket-role-${random_id.server.hex}\"\n\n  assume_role_policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"s3.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nPOLICY\n}\n\nresource \"aws_iam_role_policy_attachment\" \"s3bucketaccessrole-policy-attach\" {\n  role       = \"${aws_iam_role.s3bucketaccessrole.name}\"\n  policy_arn = \"${data.aws_iam_policy.s3Access.arn}\"\n}\n\nresource \"aws_iam_role\" \"replication\" {\n  count = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name  = \"tf-iam-role-${random_id.server.hex}\"\n\n  assume_role_policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"s3.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nPOLICY\n}\n\nresource \"aws_iam_policy\" \"replication\" {\n  count = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name  = \"tf-iam-role-policy-${random_id.server.hex}\"\n\n  policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"s3:GetReplicationConfiguration\",\n        \"s3:ListBucket\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"${aws_s3_bucket.WafLogBucket[0].arn}\"\n      ]\n    },\n    {\n      \"Action\": [\n        \"s3:GetObjectVersionForReplication\",\n        \"s3:GetObjectVersionAcl\",\n         \"s3:GetObjectVersionTagging\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"${aws_s3_bucket.WafLogBucket[0].arn}/*\"\n      ]\n    }\n  ]\n}\nPOLICY\n}\n\nresource \"aws_iam_role_policy_attachment\" \"test-attach\" {\n  count = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  role       = aws_iam_role.replication[0].name\n  policy_arn = aws_iam_policy.replication[0].arn\n}\n\n###AccessLoggingBucket\n\nresource \"aws_s3_bucket\" \"accesslogbucket\" {\n  count         = local.LogParser == \"yes\" ? 1 : 0\n  bucket        = \"${random_id.server.hex}-accesslogging\"\n  acl           = \"log-delivery-write\"\n  force_destroy = true\n  versioning {\n    enabled = true\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm = var.sse_algorithm\n      }\n    }\n  }\n}\n\nresource \"aws_s3_bucket_public_access_block\" \"accesslogbucket\" {\n  count                   = local.LogParser == \"yes\" ? 1 : 0\n  bucket                  = aws_s3_bucket.accesslogbucket[0].id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n  depends_on = [\n    aws_s3_bucket.accesslogbucket\n  ]\n}\n\nresource \"aws_s3_bucket_policy\" \"b\" {\n  count  = local.LogParser == \"yes\" ? 1 : 0\n  bucket = aws_s3_bucket.accesslogbucket[0].id\n\n  policy = <<POLICY\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n            {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": [\n                \"arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:role/${aws_iam_role.s3bucketaccessrole.name}\"\n                ]\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"${aws_s3_bucket.accesslogbucket[0].arn}\",\n                \"${aws_s3_bucket.accesslogbucket[0].arn}/*\"\n            ]\n        },\n        {\n            \"Sid\": \"HttpsOnly\",\n            \"Effect\": \"Deny\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"${aws_s3_bucket.accesslogbucket[0].arn}\",\n                \"${aws_s3_bucket.accesslogbucket[0].arn}/*\"\n            ],\n            \"Condition\": {\n                \"Bool\": {\n                    \"aws:SecureTransport\": \"false\"\n                }\n            }\n        }\n    ]\n}\nPOLICY\n  depends_on = [\n    aws_s3_bucket.accesslogbucket\n  ]\n}\n\nresource \"aws_iam_role\" \"replicationaccesslog\" {\n  count = local.LogParser == \"yes\" ? 1 : 0\n  name  = \"tf-iam-role-replication-${random_id.server.hex}\"\n\n  assume_role_policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"s3.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nPOLICY\n}\n\nresource \"aws_iam_policy\" \"replicationaccesslog\" {\n  count  = local.LogParser == \"yes\" ? 1 : 0\n  name   = \"tf-iam-role-policy-repl-${random_id.server.hex}\"\n  policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"s3:GetReplicationConfiguration\",\n        \"s3:ListBucket\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"${aws_s3_bucket.accesslogbucket[0].arn}\"\n      ]\n    },\n    {\n      \"Action\": [\n        \"s3:GetObjectVersionForReplication\",\n        \"s3:GetObjectVersionAcl\",\n         \"s3:GetObjectVersionTagging\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": [\n        \"${aws_s3_bucket.accesslogbucket[0].arn}/*\"\n      ]\n    }\n  ]\n}\nPOLICY\n}\n\nresource \"aws_iam_role_policy_attachment\" \"test-attach-log\" {\n  count  = local.LogParser == \"yes\" ? 1 : 0\n  role       = aws_iam_role.replicationaccesslog[0].name\n  policy_arn = aws_iam_policy.replicationaccesslog[0].arn\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# IP set Creation for WAF\n# ----------------------------------------------------------------------------------------------------------------------\n\n#IPV4 sets\n\nresource \"aws_wafv2_ip_set\" \"WAFWhitelistSetV4\" {\n  name               = \"WAFWhitelistSetV41\"\n  description        = \"Block Bad Bot IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFBlacklistSetV4\" {\n  name               = \"WAFBlacklistSetV41\"\n  description        = \"Block Bad Bot IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV6\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFBadBotSetV4\" {\n  count              = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFBadBotSetV41\"\n  description        = \"Block Bad Bot IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFReputationListsSetV4\" {\n  count              = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFReputationListsSetV41\"\n  description        = \"Block Reputation List IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n  lifecycle {\n    ignore_changes = [\n      addresses\n    ]\n  }\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFHttpFloodSetV4\" {\n  name               = \"WAFHttpFloodSetV41\"\n  description        = \"Block HTTP Flood IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFScannersProbesSetV4\" {\n  count              = var.ScannersProbesProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFScannersProbesSetV41\"\n  description        = \"Block HTTP Flood IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n}\n\n#IPV6 sets\n\nresource \"aws_wafv2_ip_set\" \"WAFWhitelistSetV6\" {\n  name               = \"WAFWhitelistSetV61\"\n  description        = \"Block Bad Bot IPV4 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFBlacklistSetV6\" {\n  name               = \"WAFBlacklistSetV61\"\n  description        = \"Block Bad Bot IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV6\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFBadBotSetV6\" {\n  count              = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFBadBotSetV61\"\n  description        = \"Block Bad Bot IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV6\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFReputationListsSetV6\" {\n  count              = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFReputationListsSetV61\"\n  description        = \"Block Reputation List IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV4\"\n  addresses          = []\n  lifecycle {\n    ignore_changes = [\n      addresses\n    ]\n  }\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFHttpFloodSetV6\" {\n  name               = \"WAFHttpFloodSetV61\"\n  description        = \"Block HTTP Flood IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV6\"\n  addresses          = []\n}\n\nresource \"aws_wafv2_ip_set\" \"WAFScannersProbesSetV6\" {\n  count              = var.ScannersProbesProtectionActivated == \"yes\" ? 1 : 0\n  name               = \"WAFScannersProbesSetV61\"\n  description        = \"Block HTTP Flood IPV6 addresses\"\n  scope              = local.SCOPE\n  ip_address_version = \"IPV6\"\n  addresses          = []\n}\n\n\n\n# ----------------------------------------------------------------------------------------------------------------------\n#   WAFWebACL:\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_wafv2_web_acl\" \"wafacl\" {\n  name        = \"wafwebacl-rules-${random_id.server.hex}\"\n  description = \"Custom WAFWebACL\"\n  scope       = local.SCOPE\n  default_action {\n    allow {}\n  }\n  visibility_config {\n    cloudwatch_metrics_enabled = true\n    metric_name                = \"WAFWebACL-metric\"\n    sampled_requests_enabled   = true\n  }\n\n  rule {\n    name     = \"AWS-AWSManagedRulesKnownBadInputsRuleSet\"\n    priority = 10\n\n    override_action {\n      none {}\n    }\n\n    statement {\n      managed_rule_group_statement {\n        name        = \"AWSManagedRulesKnownBadInputsRuleSet\"\n        vendor_name = \"AWS\"\n      }\n    }\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"WAFWebACL-metric\"\n      sampled_requests_enabled   = true\n    }\n  }\n  rule {\n    name     = \"aws-AWSManagedRulesCommonRuleSet\"\n    priority = 0\n    override_action {\n      none {}\n    }\n\n    statement {\n      managed_rule_group_statement {\n        vendor_name = \"AWS\"\n        name        = \"AWSManagedRulesCommonRuleSet\"\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForAMRCRS\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"WAFWhitelistRule1\"\n    priority = 1\n    action {\n      allow {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFWhitelistSetV4.arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFWhitelistSetV4.arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForWhitelistRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"WAFBlacklistRule1\"\n    priority = 2\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFBlacklistSetV4.arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFBlacklistSetV4.arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForBlacklistRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"HttpFloodRegularRule\"\n    priority = 3\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = local.WAFHttpFloodSetIPV4arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = local.WAFHttpFloodSetIPV6arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForHttpFloodRegularRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"HttpFloodRateBasedRule\"\n    priority = 4\n    action {\n      block {}\n    }\n\n    statement {\n      rate_based_statement {\n        aggregate_key_type = \"IP\"\n        limit              = var.RequestThreshold\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForHttpFloodRateBasedRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"ScannersAndProbesRule\"\n    priority = 5\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFScannersProbesSetV4[0].arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFScannersProbesSetV6[0].arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForScannersProbesRulee\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"IPReputationListsRule\"\n    priority = 6\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFReputationListsSetV4[0].arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFReputationListsSetV6[0].arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForIPReputationListsRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"BadBotRule\"\n    priority = 7\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFBadBotSetV4[0].arn\n          }\n        }\n        statement {\n          ip_set_reference_statement {\n            arn = aws_wafv2_ip_set.WAFBadBotSetV6[0].arn\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForBadBotRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"SqlInjectionRule\"\n    priority = 20\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          sqli_match_statement {\n            field_to_match {\n              query_string {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          sqli_match_statement {\n            field_to_match {\n              body {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          sqli_match_statement {\n            field_to_match {\n              uri_path {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          sqli_match_statement {\n            field_to_match {\n              single_header {\n                name = \"authorization\"\n              }\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          sqli_match_statement {\n            field_to_match {\n              single_header {\n                name = \"cookie\"\n              }\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForSqlInjectionRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n\n  rule {\n    name     = \"XssRule\"\n    priority = 30\n    action {\n      block {}\n    }\n\n    statement {\n      or_statement {\n        statement {\n          xss_match_statement {\n            field_to_match {\n              query_string {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          xss_match_statement {\n            field_to_match {\n              body {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          xss_match_statement {\n            field_to_match {\n              uri_path {}\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n        statement {\n          xss_match_statement {\n            field_to_match {\n              single_header {\n                name = \"cookie\"\n              }\n            }\n            text_transformation {\n              priority = 1\n              type     = \"URL_DECODE\"\n            }\n\n            text_transformation {\n              priority = 2\n              type     = \"HTML_ENTITY_DECODE\"\n            }\n          }\n        }\n      }\n    }\n\n    visibility_config {\n      cloudwatch_metrics_enabled = true\n      metric_name                = \"MetricForXssRule\"\n      sampled_requests_enabled   = true\n    }\n  }\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# Dynamo DB table -This DynamoDB table constains transactional ip retention data that will be expired by DynamoDB TTL. The data doesn't need to be retained after its lifecycle ends.\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_dynamodb_table\" \"IPRetentionDDBTable\" {\n  count            = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name             = \"IPRetentionDDBTable-${random_id.server.hex}\"\n  billing_mode     = \"PAY_PER_REQUEST\"\n  stream_enabled   = true\n  stream_view_type = \"OLD_IMAGE\"\n  hash_key         = \"IPSetId\"\n  range_key        = \"ExpirationTime\"\n  attribute {\n    name = \"IPSetId\"\n    type = \"S\"\n  }\n\n  attribute {\n    name = \"ExpirationTime\"\n    type = \"N\"\n  }\n\n  server_side_encryption {\n    enabled     = true\n    kms_key_arn = aws_kms_key.wafkey.arn\n  }\n\n  ttl {\n    attribute_name = \"ExpirationTime\"\n    enabled        = true\n  }\n\n  point_in_time_recovery {\n    enabled = true\n  }\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# Role Creation for Lambda functions\n# ----------------------------------------------------------------------------------------------------------------------\n\n#Role 1 - LambdaRoleHelper\n\nresource \"aws_iam_role\" \"LambdaRoleHelper\" {\n  name = \"LambdaRoleHelper1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"S3Accesshelper\" {\n  name   = \"S3Access1\"\n  role   = aws_iam_role.LambdaRoleHelper.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:GetBucketLocation\",\n                \"s3:GetObject\",\n                \"s3:ListBucket\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleHelper\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"ec2helper\" {\n  name   = \"ec2helper\"\n  role   = aws_iam_role.LambdaRoleHelper.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleHelper\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqshelper\" {\n  name   = \"sqshelper\"\n  role   = aws_iam_role.LambdaRoleHelper.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleHelper\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFAccesshelper\" {\n  name   = \"WAFAccess1\"\n  role   = aws_iam_role.LambdaRoleHelper.id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:ListWebACLs\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:wafv2:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:regional/webacl/*\",\n                \"arn:${data.aws_partition.current.partition}:wafv2:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:global/webacl/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleHelper\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LogsAccesshelper\" {\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleHelper.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*Helper*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleHelper\n  ]\n}\n\n#Role 2 - LambdaRoleBadBot\n\nresource \"aws_iam_role\" \"LambdaRoleBadBot\" {\n  count = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleBadBot1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2badbot\" {\n  count  = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"ec2badbot\"\n  role   = aws_iam_role.LambdaRoleBadBot[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleBadBot\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqsbadbot\" {\n  count  = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"sqsbadbot\"\n  role   = aws_iam_role.LambdaRoleBadBot[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleBadBot\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LogsAccessbadbot\" {\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleBadBot[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*BadBotParser*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleBadBot\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CloudWatchAccessbadbot\" {\n  name   = \"CloudWatchAccess1\"\n  role   = aws_iam_role.LambdaRoleBadBot[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": \"cloudwatch:GetMetricStatistics\",\n            \"Resource\": [\n                \"*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleBadBot\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFGetAndUpdateIPSetbadbot\" {\n  name   = \"WAFGetAndUpdateIPSet1\"\n  role   = aws_iam_role.LambdaRoleBadBot[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_ip_set.WAFBadBotSetV4[0].arn}\",\n                \"${aws_wafv2_ip_set.WAFBadBotSetV6[0].arn}\"\n                ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleBadBot\n  ]\n}\n\n#Role 3 - LambdaRolePartitionS3Logs\n\nresource \"aws_iam_role\" \"LambdaRolePartitionS3Logs\" {\n  count              = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name               = \"LambdaRolePartitionS3Logs1-${random_id.server.hex}\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2Partition\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"ec2Partition\"\n  role   = aws_iam_role.LambdaRolePartitionS3Logs[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRolePartitionS3Logs\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqspartition\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"sqspartition\"\n  role   = aws_iam_role.LambdaRolePartitionS3Logs[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRolePartitionS3Logs\n  ]\n}\n\n\nresource \"aws_iam_role_policy\" \"PartitionS3LogsAccess\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"PartitionS3LogsAccess1\"\n  role   = aws_iam_role.LambdaRolePartitionS3Logs[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:GetObject\",\n                \"s3:DeleteObject\",\n                \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRolePartitionS3Logs\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LogsAccesshelperPartitions3\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRolePartitionS3Logs[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*MoveS3LogsForPartition*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRolePartitionS3Logs\n  ]\n}\n\n#Role 4 - LambdaRoleSetIPRetention\n\nresource \"aws_iam_role\" \"LambdaRoleSetIPRetention\" {\n  count = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleSetIPRetention1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2retention\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"ec2retention\"\n  role   = aws_iam_role.LambdaRoleSetIPRetention[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleSetIPRetention\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqsretention\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"sqsretention\"\n  role   = aws_iam_role.LambdaRoleSetIPRetention[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleSetIPRetention\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LogsAccessSetIPRetention\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleSetIPRetention[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*SetIPRetention*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleSetIPRetention\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"DDBAccess\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"DDBAccess1\"\n  role   = aws_iam_role.LambdaRoleSetIPRetention[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"dynamodb:PutItem\"\n            ],\n            \"Resource\": [\n               \"${aws_dynamodb_table.IPRetentionDDBTable[0].arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleSetIPRetention\n  ]\n}\n\n#Role 5 - LambdaRoleRemoveExpiredIP\n\nresource \"aws_iam_role\" \"LambdaRoleRemoveExpiredIP\" {\n  count = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleRemoveExpiredIP1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2expired\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"ec2expired\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"SNSPublishPolicy\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"SNS:Publish\"\n            ],\n            \"Resource\": [\n                \"${aws_sns_topic.user_updates[0].arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LogsAccessLambdaRoleRemoveExpiredIP\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*RemoveExpiredIP*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFAccessLambdaRoleRemoveExpiredIP\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"WAFAccess1\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"dynamodb:GetShardIterator\",\n                \"dynamodb:DescribeStream\",\n                \"dynamodb:GetRecords\",\n                \"dynamodb:ListStreams\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_ip_set.WAFWhitelistSetV4.arn}\",\n                \"${aws_wafv2_ip_set.WAFBlacklistSetV6.arn}\",\n                \"${aws_wafv2_ip_set.WAFWhitelistSetV6.arn}\",\n                \"${aws_wafv2_ip_set.WAFBlacklistSetV6.arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqsexpired\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"sqsexpired\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"DDBStreamAccess\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"DDBStreamAccess\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n               \"${aws_dynamodb_table.IPRetentionDDBTable[0].arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\nresource \"aws_iam_role_policy\" \"InvokeLambda\" {\n  count  = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name   = \"InvokeLambda1\"\n  role   = aws_iam_role.LambdaRoleRemoveExpiredIP[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"lambda:InvokeFunction\"\n            ],\n            \"Resource\": [\n               \"${aws_dynamodb_table.IPRetentionDDBTable[0].arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleRemoveExpiredIP\n  ]\n}\n\n#ROLE6  LambdaRoleReputationListsParser\n\nresource \"aws_iam_role\" \"LambdaRoleReputationListsParser\" {\n  count = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleReputParser1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2reputation\" {\n  count  = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"ec2reputation\"\n  role   = aws_iam_role.LambdaRoleReputationListsParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleReputationListsParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CloudWatchLogsListsParser\" {\n  count  = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"CloudWatchLogs1\"\n  role   = aws_iam_role.LambdaRoleReputationListsParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*ReputationListsParser*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleReputationListsParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqsreputation\" {\n  count  = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"sqsreputation\"\n  role   = aws_iam_role.LambdaRoleReputationListsParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleReputationListsParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CloudWatchAccessListsParser\" {\n  count  = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"CloudWatchAccess1\"\n  role   = aws_iam_role.LambdaRoleReputationListsParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": \"cloudwatch:GetMetricStatistics\",\n            \"Resource\": [\n                \"*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleReputationListsParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFGetAndUpdateIPListsParser\" {\n  name   = \"WAFGetAndUpdateIPSet1\"\n  role   = aws_iam_role.LambdaRoleReputationListsParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_ip_set.WAFReputationListsSetV4[0].arn}\",\n                \"${aws_wafv2_ip_set.WAFReputationListsSetV6[0].arn}\"\n                ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleReputationListsParser\n  ]\n}\n\n#Role 7 - LambdaRoleCustomResource\n\nresource \"aws_iam_role\" \"LambdaRoleCustomResource\" {\n  name = \"LambdaRoleCustomResource1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2customresource\" {\n  name   = \"ec2customresource\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqscustomresource\" {\n  name   = \"sqscustomresource\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"S3AccessGeneralAppAccessLog\" {\n  name   = \"S3AccessGeneralAppAccessLog1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:CreateBucket\",\n                \"s3:GetBucketNotification\",\n                \"s3:PutBucketNotification\",\n                \"s3:PutEncryptionConfiguration\",\n                \"s3:PutBucketPublicAccessBlock\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"S3AccessGeneralWafLog\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"S3AccessGeneralWafLog1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:CreateBucket\",\n                \"s3:GetBucketNotification\",\n                \"s3:PutBucketNotification\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"S3Access\" {\n  name   = \"S3Access1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:GetBucketLocation\",\n                \"s3:GetObject\",\n                \"s3:ListBucket\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"S3AppAccessPut\" {\n  count  = local.ScannersProbesLambdaLogParser == \"yes\" ? 1 : 0\n  name   = \"S3AppAccessPut1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*app_log_conf.json\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"S3WafAccessPut\" {\n  count  = local.HttpFloodLambdaLogParser == \"yes\" ? 1 : 0\n  name   = \"S3WafAccessPut1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*waf_log_conf.json\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CustomResourceLambdaAccess\" {\n  count  = local.CustomResourceLambdaAccess == \"yes\" ? 1 : 0\n  name   = \"LambdaAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"lambda:InvokeFunction\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:function:*AddAthenaPartitions*\",\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:function:*ReputationListsParser*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFAccess\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"WAFAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:GetWebACL\",\n                \"wafv2:UpdateWebACL\",\n                \"wafv2:DeleteLoggingConfiguration\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_web_acl.wafacl.arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"IPSetAccess\" {\n  name   = \"IPSetAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:wafv2:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:regional/ipset/*\",\n                \"arn:${data.aws_partition.current.partition}:wafv2:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:global/ipset/*\"\n                ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"WAFLogsAccess\" {\n  name   = \"WAFLogsAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"wafv2:PutLoggingConfiguration\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_web_acl.wafacl.arn}\"\n                ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": \"iam:CreateServiceLinkedRole\",\n            \"Resource\": \"arn:${data.aws_partition.current.partition}:iam::*:role/aws-service-role/wafv2.amazonaws.com/AWSServiceRoleForWAFV2Logging\",\n            \"Condition\": {\n                \"ForAnyValue:StringLike\": {\n                    \"iam:AWSServiceName\": \"wafv2.amazonaws.com\"\n                }\n            }\n        }        \n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CustomResourceLogsAccess\" {\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*CustomResource*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CustomResourceS3BucketLoggingAccess\" {\n  count  = var.ScannersProbesProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"S3BucketLoggingAccess1\"\n  role   = aws_iam_role.LambdaRoleCustomResource.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:GetBucketLogging\",\n                \"s3:PutBucketLogging\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomResource\n  ]\n}\n\n#Role 8 - LambdaRoleLogParser\n\nresource \"aws_iam_role\" \"LambdaRoleLogParser\" {\n  count = local.LogParser == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleLogParser1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2logparser\" {\n  name   = \"ec2logparser\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqslogparser\" {\n  count  = local.LogParser == \"yes\" ? 1 : 0\n  name   = \"sqslogparser\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\nresource \"aws_iam_role_policy\" \"S3LogParser\" {\n  count  = var.ScannersProbesProtectionActivated == \"yes\" ? 1 : 0\n  name   = \"ScannersProbesProtectionActivatedAccess\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": \"s3:GetObject\",\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": \"s3:PutObject\",\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*app_log_out.json\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*app_log_conf.json\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_ip_set.WAFScannersProbesSetV4[0].arn}\",\n                \"${aws_wafv2_ip_set.WAFScannersProbesSetV6[0].arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"ScannersProbesAthenaLogParser\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"ScannersProbesAthenaLogParserAccess1\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"athena:GetNamedQuery\",\n            \"athena:StartQueryExecution\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:athena:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:workgroup/WAF*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n            \"s3:GetBucketLocation\",\n            \"s3:GetObject\",\n            \"s3:ListBucket\",\n            \"s3:ListBucketMultipartUploads\",\n            \"s3:ListMultipartUploadParts\",\n            \"s3:AbortMultipartUpload\",\n            \"s3:CreateBucket\",\n            \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/athena_results/*\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"glue:GetTable\",\n                \"glue:GetPartitions\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:catalog\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/*\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:table/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"HttpFloodProtectionLogParser\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"HttpFloodProtectionLogParserActivatedAccess1\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"s3:GetObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n            \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/*log_out.json\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/*log_conf.json\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"wafv2:GetIPSet\",\n                \"wafv2:UpdateIPSet\"\n            ],\n            \"Resource\": [\n                \"${aws_wafv2_ip_set.WAFHttpFloodSetV4.arn}\",\n                \"${aws_wafv2_ip_set.WAFHttpFloodSetV6.arn}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"HttpFloodAthenaLogParser\" {\n  count  = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"HttpFloodAthenaLogParserAccess1\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"athena:GetNamedQuery\",\n            \"athena:StartQueryExecution\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:athena:::${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:workgroup/WAF*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n            \"s3:GetBucketLocation\",\n            \"s3:GetObject\",\n            \"s3:ListBucket\",\n            \"s3:ListBucketMultipartUploads\",\n            \"s3:ListMultipartUploadParts\",\n            \"s3:AbortMultipartUpload\",\n            \"s3:CreateBucket\",\n            \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/athena_results/*\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"glue:GetTable\",\n                \"glue:GetPartitions\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:catalog\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/*\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:table/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LambdaRoleLogsAccess1\" {\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*LogParser*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"LambdaRoleCloudWatchAccess\" {\n  name   = \"CloudWatchAccess1\"\n  role   = aws_iam_role.LambdaRoleLogParser[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"cloudwatch:GetMetricStatistics\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleLogParser[0]\n  ]\n}\n\n#Role 9 - LambdaRoleAddAthenaPartitions\n\nresource \"aws_iam_role\" \"LambdaRoleAddAthenaPartitions\" {\n  count = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name  = \"LambdaRoleAddAthenaPartitions1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"AddAthenaPartitionsForAppAccessLog\" {\n  count  = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"AddAthenaPartitionsForAppAccessLog1\"\n  role   = aws_iam_role.LambdaRoleAddAthenaPartitions[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"athena:StartQueryExecution\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:athena:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:workgroup/WAF*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n            \"s3:GetBucketLocation\",\n            \"s3:GetObject\",\n            \"s3:ListBucket\",\n            \"s3:ListBucketMultipartUploads\",\n            \"s3:ListMultipartUploadParts\",\n            \"s3:AbortMultipartUpload\",\n            \"s3:CreateBucket\",\n            \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/athena_results/*\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${local.AppLogBucket}/*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"glue:GetTable\",\n                \"glue:GetDatabase\",\n                \"glue:UpdateDatabase\",\n                \"glue:CreateDatabase\",\n                \"glue:BatchCreatePartition\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:catalog\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/default\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/*\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:table/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleAddAthenaPartitions\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"AddAthenaPartitionsForWAFLog\" {\n  count  = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"AddAthenaPartitionsForWAFLog1\"\n  role   = aws_iam_role.LambdaRoleAddAthenaPartitions[0].id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"athena:StartQueryExecution\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:athena:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:workgroup/WAF*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n            \"s3:GetBucketLocation\",\n            \"s3:GetObject\",\n            \"s3:ListBucket\",\n            \"s3:ListBucketMultipartUploads\",\n            \"s3:ListMultipartUploadParts\",\n            \"s3:AbortMultipartUpload\",\n            \"s3:CreateBucket\",\n            \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/athena_results/*\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/*\"\n            ],\n            \"Effect\": \"Allow\"\n        },\n        {\n            \"Action\": [\n                \"glue:GetTable\",\n                \"glue:GetDatabase\",\n                \"glue:UpdateDatabase\",\n                \"glue:CreateDatabase\",\n                \"glue:BatchCreatePartition\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:catalog\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/default\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:database/*\",\n                \"arn:${data.aws_partition.current.partition}:glue:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:table/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleAddAthenaPartitions\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"ec2athena\" {\n  count  = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"ec2athena\"\n  role   = aws_iam_role.LambdaRoleAddAthenaPartitions[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleAddAthenaPartitions\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"sqsathena\" {\n  count  = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"sqsathena\"\n  role   = aws_iam_role.LambdaRoleAddAthenaPartitions[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleAddAthenaPartitions\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"HttpFloodAthenaLogParserLogsAccess\" {\n  count  = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name   = \"LogsAccess1\"\n  role   = aws_iam_role.LambdaRoleAddAthenaPartitions[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*AddAthenaPartitions*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleAddAthenaPartitions\n  ]\n}\n\n\n\n#Role 10 - CustomTimerrole\n\nresource \"aws_iam_role\" \"LambdaRoleCustomTimer\" {\n  name = \"LambdaRoleCustomTimer-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ec2customtimer\" {\n  name   = \"ec2customtimer\"\n  role   = aws_iam_role.LambdaRoleCustomTimer.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:CreateNetworkInterface\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:lambda:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomTimer\n  ]\n}\n\n\nresource \"aws_iam_role_policy\" \"sqscustomtimer\" {\n  name   = \"sqscustomtimer\"\n  role   = aws_iam_role.LambdaRoleCustomTimer.id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"sqs:SendMessage\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:sqs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomTimer\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CloudWatchLogstimer\" {\n  name   = \"CloudWatchLogstimerpolicy\"\n  role   = aws_iam_role.LambdaRoleCustomTimer.id\n  policy = <<EOT\n{\n    \"Statement\": [\n        {\n            \"Action\": [\n            \"logs:CreateLogGroup\",\n            \"logs:CreateLogGroup\",\n            \"logs:CreateLogStream\",\n            \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:athena:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/lambda/*CustomTimer*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\n\nEOT\n  depends_on = [\n    aws_iam_role.LambdaRoleCustomTimer\n  ]\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# CREATE A LAMBDA FUNCTIONS\n# ----------------------------------------------------------------------------------------------------------------------\n\n\nresource \"aws_lambda_function\" \"helper\" {\n  function_name = \"Helper-Lambda-${random_id.server.hex}\"\n  description                    = \"This lambda function verifies the main project's dependencies, requirements and implement auxiliary functions\"\n  role                           = aws_iam_role.LambdaRoleHelper.arn\n  handler                        = \"helper.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/helper.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 128\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL        = var.LOG_LEVEL\n      SCOPE            = local.SCOPE\n      USER_AGENT_EXTRA = var.USER_AGENT_EXTRA\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"BadBotParser\" {\n  count = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  function_name                  = \"BadBotParser-Lambda-${random_id.server.hex}\"\n  description                    = \"This lambda function verifies the main project's dependencies, requirements and implement auxiliary functions\"\n  role                           = aws_iam_role.LambdaRoleBadBot[0].arn\n  handler                        = \"BadBotParser.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/access_handler.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 128\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL                 = var.LOG_LEVEL\n      SCOPE                     = local.SCOPE\n      USER_AGENT_EXTRA          = var.USER_AGENT_EXTRA\n      IP_SET_ID_BAD_BOTV4       = aws_wafv2_ip_set.WAFBadBotSetV4[0].arn\n      IP_SET_ID_BAD_BOTV6       = aws_wafv2_ip_set.WAFBadBotSetV4[0].arn\n      IP_SET_NAME_BAD_BOTV4     = aws_wafv2_ip_set.WAFBadBotSetV4[0].name\n      IP_SET_NAME_BAD_BOTV6     = aws_wafv2_ip_set.WAFBadBotSetV4[0].name\n      SEND_ANONYMOUS_USAGE_DATA = var.SEND_ANONYMOUS_USAGE_DATA\n      REGION                    = data.aws_region.current.name\n      LOG_TYPE                  = local.LOG_TYPE\n      SOLUTION_ID               = var.SolutionID\n      METRICS_URL               = var.MetricsURL\n      STACK_NAME                = \"custom-resources-stack-${random_id.server.hex}\"\n      METRIC_NAME_PREFIX        = \"customresourcesstack\"\n      UUID                      = aws_cloudformation_stack.trigger_codebuild_stack.outputs.UUID\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"MoveS3LogsForPartition\" {\n  count = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  function_name                  = \"MoveS3LogsForPartition-Lambda-${random_id.server.hex}\"\n  description                    = \"This function is triggered by S3 event to move log files(upon their arrival in s3) from their original location to a partitioned folder structure created per timestamps in file names, hence allowing the usage of partitioning within AWS Athena.\"\n  role                           = aws_iam_role.LambdaRolePartitionS3Logs[0].arn\n  handler                        = \"partition_s3_logs.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/log_parser.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 512\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL          = var.LOG_LEVEL\n      ENDPOINT           = var.ENDPOINT\n      USER_AGENT_EXTRA   = var.USER_AGENT_EXTRA\n      KEEP_ORIGINAL_DATA = var.KEEP_ORIGINAL_DATA\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"SetIPRetention\" {\n  count         = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  function_name = \"SetIPRetention-Lambda-${random_id.server.hex}\"\n  description                    = \"This lambda function processes CW events for WAF UpdateIPSet API calls. It writes relevant ip retention data into a DynamoDB table.\"\n  role                           = aws_iam_role.LambdaRoleSetIPRetention[0].arn\n  handler                        = \"set_ip_retention.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/ip_retention_handler.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 128\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL                          = var.LOG_LEVEL\n      USER_AGENT_EXTRA                   = var.USER_AGENT_EXTRA\n      TABLE_NAME                         = aws_dynamodb_table.IPRetentionDDBTable[0].name\n      IP_RETENTION_PEROID_ALLOWED_MINUTE = var.IPRetentionPeriodAllowedParam\n      IP_RETENTION_PEROID_DENIED_MINUTE  = var.IPRetentionPeriodDeniedParam\n      REMOVE_EXPIRED_IP_LAMBDA_ROLE_NAME = aws_iam_role.LambdaRoleRemoveExpiredIP[0].name\n      STACK_NAME                         = \"custom-resources-stack-${random_id.server.hex}\"\n      METRIC_NAME_PREFIX                 = \"customresourcesstack\"\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"ReputationListsParser\" {\n  count = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  function_name                  = \"ReputationListsParser-Lambda-${random_id.server.hex}\"\n  description                    = \"This lambda function checks third-party IP reputation lists hourly for new IP ranges to block. These lists include the Spamhaus Dont Route Or Peer (DROP) and Extended Drop (EDROP) lists, the Proofpoint Emerging Threats IP list, and the Tor exit node list.\"\n  role                           = aws_iam_role.LambdaRoleReputationListsParser[0].arn\n  handler                        = \"reputation-lists.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/reputation_lists_parser.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 512\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL                   = var.LOG_LEVEL\n      USER_AGENT_EXTRA            = var.USER_AGENT_EXTRA\n      IP_SET_ID_REPUTATIONV4      = aws_wafv2_ip_set.WAFReputationListsSetV4[0].arn\n      IP_SET_ID_REPUTATIONV6      = aws_wafv2_ip_set.WAFReputationListsSetV6[0].arn\n      IP_SET_NAME_REPUTATIONV4    = aws_wafv2_ip_set.WAFReputationListsSetV4[0].name\n      IP_SET_NAME_REPUTATIONV6    = aws_wafv2_ip_set.WAFReputationListsSetV6[0].name\n      SCOPE                       = local.SCOPE\n      LOG_TYPE                    = local.LOG_TYPE\n      SOLUTION_ID                 = var.SolutionID\n      METRICS_URL                 = var.MetricsURL\n      SEND_ANONYMOUS_USAGE_DATA   = var.SEND_ANONYMOUS_USAGE_DATA\n      IPREPUTATIONLIST_METRICNAME = \"MetricForIPReputationListsRule\"\n      STACK_NAME                  = \"custom-resources-stack-${random_id.server.hex}\"\n      METRIC_NAME_PREFIX          = \"customresourcesstack\"\n      URL_LIST                    = <<EOF\n      [\n                  {\"url\":\"https://www.spamhaus.org/drop/drop.txt\"},\n                  {\"url\":\"https://www.spamhaus.org/drop/edrop.txt\"},\n                  {\"url\":\"https://check.torproject.org/exit-addresses\", \"prefix\":\"ExitAddress\"},\n                  {\"url\":\"https://rules.emergingthreats.net/fwrules/emerging-Block-IPs.txt\"}\n                ]\n                EOF\n    }\n  }\n}\n\n\nresource \"aws_lambda_function\" \"CustomResource\" {\n  function_name = \"CustomResource-Lambda-${random_id.server.hex}\"\n  description                    = \"Log permissions are defined in the LambdaRoleCustomResource policies\"\n  role                           = aws_iam_role.LambdaRoleCustomResource.arn\n  handler                        = \"custom-resource.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/custom_resource.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 128\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL        = var.LOG_LEVEL\n      USER_AGENT_EXTRA = var.USER_AGENT_EXTRA\n      SCOPE            = local.SCOPE\n      SOLUTION_ID      = var.SolutionID\n      METRICS_URL      = var.MetricsURL\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"LogParser\" {\n  count         = local.LogParser == \"yes\" ? 1 : 0\n  function_name = \"LogParser-Lambda-${random_id.server.hex}\"\n  description                    = \"This function parses access logs to identify suspicious behavior, such as an abnormal amount of errors.It then blocks those IP addresses for a customer-defined period of time.\"\n  role                           = aws_iam_role.LambdaRoleLogParser[0].arn\n  handler                        = \"log-parser.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/log_parser.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 512\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      APP_ACCESS_LOG_BUCKET                          = local.AppLogBucket\n      WAF_ACCESS_LOG_BUCKET                          = local.WafLogBucket\n      LIMIT_IP_ADDRESS_RANGES_PER_IP_MATCH_CONDITION = 10000\n      MAX_AGE_TO_UPDATE                              = 30\n      LOG_LEVEL                                      = var.LOG_LEVEL\n      SCOPE                                          = local.SCOPE\n      USER_AGENT_EXTRA                               = var.USER_AGENT_EXTRA\n      SEND_ANONYMOUS_USAGE_DATA                      = var.SEND_ANONYMOUS_USAGE_DATA\n      REGION                                         = data.aws_region.current.name\n      LOG_TYPE                                       = local.LOG_TYPE\n      SOLUTION_ID                                    = var.SolutionID\n      METRICS_URL                                    = var.MetricsURL\n      IP_SET_ID_HTTP_FLOODV4                         = local.WAFHttpFloodSetIPV4arn\n      IP_SET_ID_HTTP_FLOODV6                         = local.WAFHttpFloodSetIPV6arn\n      IP_SET_NAME_HTTP_FLOODV4                       = local.WAFHttpFloodSetIPV4Name\n      IP_SET_NAME_HTTP_FLOODV6                       = local.WAFHttpFloodSetIPV6Name\n      IP_SET_ID_SCANNERS_PROBESV4                    = aws_wafv2_ip_set.WAFScannersProbesSetV4[0].arn\n      IP_SET_ID_SCANNERS_PROBESV6                    = aws_wafv2_ip_set.WAFScannersProbesSetV6[0].arn\n      IP_SET_NAME_SCANNERS_PROBESV4                  = aws_wafv2_ip_set.WAFScannersProbesSetV4[0].name\n      IP_SET_NAME_SCANNERS_PROBESV6                  = aws_wafv2_ip_set.WAFScannersProbesSetV6[0].name\n      WAF_BLOCK_PERIOD                               = var.WAFBlockPeriod\n      ERROR_THRESHOLD                                = var.ErrorThreshold\n      REQUEST_THRESHOLD                              = var.RequestThreshold\n      STACK_NAME                                     = \"custom-resources-stack-${random_id.server.hex}\"\n      METRIC_NAME_PREFIX                             = \"customresourcesstack\"\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"AddAthenaPartitions\" {\n  count = local.AthenaLogParser == \"yes\" ? 1 : 0\n  function_name                  = \"AthenaLogParser-Lambda-${random_id.server.hex}\"\n  description                    = \"This function adds a new hourly partition to athena table. It runs every hour, triggered by a CloudWatch event.\"\n  role                           = aws_iam_role.LambdaRoleAddAthenaPartitions[0].arn\n  handler                        = \"add_athena_partitions.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/log_parser.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 512\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL        = var.LOG_LEVEL\n      USER_AGENT_EXTRA = var.USER_AGENT_EXTRA\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"RemoveExpiredIP\" {\n  count = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  function_name                  = \"RemoveExpiredIP-Lambda-${random_id.server.hex}\"\n  description                    = \"This function adds a new hourly partition to athena table. It runs every hour, triggered by a CloudWatch event.\"\n  role                           = aws_iam_role.LambdaRoleRemoveExpiredIP[0].arn\n  handler                        = \"add_athena_partitions.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/ip_retention_handler.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 512\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL                 = var.LOG_LEVEL\n      USER_AGENT_EXTRA          = var.USER_AGENT_EXTRA\n      METRICS_URL               = var.MetricsURL\n      SOLUTION_ID               = var.SolutionID\n      SEND_ANONYMOUS_USAGE_DATA = var.SEND_ANONYMOUS_USAGE_DATA\n      SNS_EMAIL                 = local.SNSEmail\n      SNS_TOPIC_ARN             = aws_sns_topic.user_updates[0].arn\n    }\n  }\n}\n\nresource \"aws_lambda_function\" \"CustomTimer\" {\n  function_name = \"CustomTimer-Lambda-${random_id.server.hex}\"\n  description                    = \"This lambda function counts X seconds and can be used to slow down component creation in CloudFormation\"\n  role                           = aws_iam_role.LambdaRoleCustomTimer.arn\n  handler                        = \"timer.lambda_handler\"\n  s3_bucket                      = \"${var.SourceBucket}-${data.aws_region.current.name}\"\n  s3_key                         = \"${var.KeyPrefix}/timer.zip\"\n  runtime                        = \"python3.8\"\n  timeout                        = 300\n  memory_size                    = 128\n  kms_key_arn                    = aws_kms_key.wafkey.arn\n  reserved_concurrent_executions = 1\n  tracing_config {\n    mode = \"Active\"\n  }\n  environment {\n    variables = {\n      LOG_LEVEL = var.LOG_LEVEL\n      SECONDS   = \"2\"\n    }\n  }\n}\n\nlocals {\n  MoveS3LogsForPartitionarn     = length(aws_lambda_function.MoveS3LogsForPartition) != 0 ? \"${aws_lambda_function.MoveS3LogsForPartition[0].arn}\" : \"0\"\n  WAFHttpFloodSetIPV4           = length(aws_wafv2_ip_set.WAFHttpFloodSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV4.id}\" : \"0\"\n  WAFScannersProbesSetIPV4      = length(aws_wafv2_ip_set.WAFScannersProbesSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFScannersProbesSetV4[0].id}\" : \"0\"\n  WAFReputationListsSetIPV4     = length(aws_wafv2_ip_set.WAFReputationListsSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFReputationListsSetV4[0].id}\" : \"0\"\n  WAFBadBotSetIPV4              = length(aws_wafv2_ip_set.WAFBadBotSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFBadBotSetV4[0].id}\" : \"0\"\n  WAFHttpFloodSetIPV6           = length(aws_wafv2_ip_set.WAFHttpFloodSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV6.id}\" : \"0\"\n  WAFScannersProbesSetIPV6      = length(aws_wafv2_ip_set.WAFScannersProbesSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFScannersProbesSetV6[0].id}\" : \"0\"\n  WAFReputationListsSetIPV6     = length(aws_wafv2_ip_set.WAFReputationListsSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFReputationListsSetV6[0].id}\" : \"0\"\n  WAFBadBotSetIPV6              = length(aws_wafv2_ip_set.WAFBadBotSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFBadBotSetV6[0].id}\" : \"0\"\n  WAFHttpFloodSetIPV4Name       = length(aws_wafv2_ip_set.WAFHttpFloodSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV4.name}\" : \"0\"\n  WAFScannersProbesSetIPV4Name  = length(aws_wafv2_ip_set.WAFScannersProbesSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFScannersProbesSetV4[0].name}\" : \"0\"\n  WAFReputationListsSetIPV4Name = length(aws_wafv2_ip_set.WAFReputationListsSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFReputationListsSetV4[0].name}\" : \"0\"\n  WAFBadBotSetIPV4Name          = length(aws_wafv2_ip_set.WAFBadBotSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFBadBotSetV4[0].name}\" : \"0\"\n  WAFHttpFloodSetIPV6Name       = length(aws_wafv2_ip_set.WAFHttpFloodSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV6.name}\" : \"0\"\n  WAFScannersProbesSetIPV6Name  = length(aws_wafv2_ip_set.WAFScannersProbesSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFScannersProbesSetV6[0].name}\" : \"0\"\n  WAFReputationListsSetIPV6Name = length(aws_wafv2_ip_set.WAFReputationListsSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFReputationListsSetV6[0].name}\" : \"0\"\n  WAFBadBotSetIPV6Name          = length(aws_wafv2_ip_set.WAFBadBotSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFBadBotSetV6[0].name}\" : \"0\"\n  AddAthenaPartitionsLambdaarn  = length(aws_lambda_function.AddAthenaPartitions) != 0 ? \"${aws_lambda_function.AddAthenaPartitions[0].arn}\" : \"0\"\n  LogParserarn                  = length(aws_lambda_function.LogParser) != 0 ? \"${aws_lambda_function.LogParser[0].arn}\" : \"0\"\n  GlueAccessLogsDatabase        = length(aws_glue_catalog_database.mydatabase) != 0 ? \"${aws_glue_catalog_database.mydatabase[0].name}\" : \"0\"\n  GlueWafAccessLogsTable        = length(aws_glue_catalog_table.waf_access_logs_table) != 0 ? \"${aws_glue_catalog_table.waf_access_logs_table[0].name}\" : \"0\"\n  AthenaWorkGroup               = length(aws_athena_workgroup.WAFAddPartitionAthenaQueryWorkGroup) != 0 ? \"${aws_athena_workgroup.WAFAddPartitionAthenaQueryWorkGroup[0].name}\" : \"0\"\n  AppAccessLogsTable            = (local.CloudFrontScannersProbesAthenaLogParser == \"yes\" ? \"${aws_glue_catalog_table.cloudfrontGlueAppAccessLogsTable[0].name}\" : (local.ALBScannersProbesAthenaLogParser == \"yes\" ? \"${aws_glue_catalog_table.ALBGlueAppAccessLogsTable[0].name}\" : \"0\"))\n  WAFHttpFloodSetIPV4arn        = length(aws_wafv2_ip_set.WAFHttpFloodSetV4) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV4.arn}\" : \"0\"\n  WAFHttpFloodSetIPV6arn        = length(aws_wafv2_ip_set.WAFHttpFloodSetV6) != 0 ? \"${aws_wafv2_ip_set.WAFHttpFloodSetV6.arn}\" : \"0\"\n  DeliveryStreamArn             = length(aws_kinesis_firehose_delivery_stream.extended_s3_stream) != 0 ? \"${aws_kinesis_firehose_delivery_stream.extended_s3_stream[0].arn}\" : \"0\"\n  WafLogBucket                  = length(aws_s3_bucket.WafLogBucket) != 0 ? \"${aws_s3_bucket.WafLogBucket[0].bucket}\" : \"0\"\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# Custom Resources\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_cloudformation_stack\" \"trigger_codebuild_stack\" {\n  name = \"custom-resources-stack-${random_id.server.hex}\"\n  parameters = {\n    AthenaLogParser                           = local.AthenaLogParser\n    Helperarn                                 = aws_lambda_function.helper.arn\n    HttpFloodProtectionRateBasedRuleActivated = local.HttpFloodProtectionRateBasedRuleActivated\n    HttpFloodProtectionLogParserActivated     = local.HttpFloodProtectionLogParserActivated\n    ProtectionActivatedScannersProbes         = var.ScannersProbesProtectionActivated\n    AppAccessLogBucket                        = local.AppLogBucket\n    Region                                    = data.aws_region.current.name\n    EndpointType                              = var.ENDPOINT\n    RequestThreshold                          = var.RequestThreshold\n    ReputationListsParserarn                  = aws_lambda_function.ReputationListsParser[0].arn\n    ReputationListsProtectionActivated        = var.ReputationListsProtectionActivated\n    CustomResourcearn                         = aws_lambda_function.CustomResource.arn\n    WAFWebACLArn                              = aws_wafv2_web_acl.wafacl.arn\n    DeliveryStreamArn                         = local.DeliveryStreamArn\n    LogParser                                 = local.LogParserarn\n    ScannersProbesAthenaLogParser             = local.ScannersProbesAthenaLogParser\n    ScannersProbesLambdaLogParser             = local.ScannersProbesLambdaLogParser\n    AccessLoggingBucket                       = aws_s3_bucket.accesslogbucket[0].bucket\n    MoveS3LogsForPartitionarn                 = local.MoveS3LogsForPartitionarn\n    ScannersProbesProtectionActivated         = var.ScannersProbesProtectionActivated\n    BadBotProtectionActivated                 = var.BadBotProtectionActivated\n    HttpFloodAthenaLogParser                  = local.HttpFloodAthenaLogParser\n    HttpFloodLambdaLogParser                  = local.HttpFloodLambdaLogParser\n    ScannersProbesLambdaLogParser             = local.ScannersProbesLambdaLogParser\n    WafLogBucket                              = local.WafLogBucket\n    WAFBlockPeriod                            = var.WAFBlockPeriod\n    ActivateSqlInjectionProtectionParam       = var.ActivateSqlInjectionProtectionParam\n    ActivateCrossSiteScriptingProtectionParam = var.ActivateCrossSiteScriptingProtectionParam\n    ActivateHttpFloodProtectionParam          = var.ActivateHttpFloodProtectionParam\n    ActivateScannersProbesProtectionParam     = var.ActivateScannersProbesProtectionParam\n    ActivateReputationListsProtectionParam    = var.ActivateReputationListsProtectionParam\n    ActivateBadBotProtectionParam             = var.ActivateBadBotProtectionParam\n    ActivateAWSManagedRulesParam              = var.ActivateAWSManagedRulesParam\n    KeepDataInOriginalS3Location              = var.KEEP_ORIGINAL_DATA\n    IPRetentionPeriodAllowedParam             = var.IPRetentionPeriodAllowedParam\n    IPRetentionPeriodDeniedParam              = var.IPRetentionPeriodDeniedParam\n    SendAnonymousUsageData                    = var.SendAnonymousUsageData\n    SNSEmailParam                             = var.SNSEmailParam\n    version                                   = \"v3.2.0\"\n    ErrorThreshold                            = var.ErrorThreshold\n    WAFWhitelistSetIPV4                       = aws_wafv2_ip_set.WAFWhitelistSetV4.id\n    WAFBlacklistSetIPV4                       = aws_wafv2_ip_set.WAFBlacklistSetV4.id\n    WAFHttpFloodSetIPV4                       = local.WAFHttpFloodSetIPV4\n    WAFScannersProbesSetIPV4                  = local.WAFScannersProbesSetIPV4\n    WAFReputationListsSetIPV4                 = local.WAFReputationListsSetIPV4\n    WAFBadBotSetIPV4                          = local.WAFBadBotSetIPV4\n    WAFWhitelistSetIPV6                       = aws_wafv2_ip_set.WAFWhitelistSetV6.id\n    WAFBlacklistSetIPV6                       = aws_wafv2_ip_set.WAFBlacklistSetV6.id\n    WAFHttpFloodSetIPV6                       = local.WAFHttpFloodSetIPV6\n    WAFScannersProbesSetIPV6                  = local.WAFScannersProbesSetIPV6\n    WAFReputationListsSetIPV6                 = local.WAFReputationListsSetIPV6\n    WAFBadBotSetIPV6                          = local.WAFBadBotSetIPV6\n    WAFWhitelistSetIPV4Name                   = aws_wafv2_ip_set.WAFWhitelistSetV4.name\n    WAFBlacklistSetIPV4Name                   = aws_wafv2_ip_set.WAFBlacklistSetV4.name\n    WAFHttpFloodSetIPV4Name                   = local.WAFHttpFloodSetIPV4Name\n    WAFScannersProbesSetIPV4Name              = local.WAFScannersProbesSetIPV4Name\n    WAFReputationListsSetIPV4Name             = local.WAFReputationListsSetIPV4Name\n    WAFBadBotSetIPV4Name                      = local.WAFBadBotSetIPV4Name\n    WAFWhitelistSetIPV6Name                   = aws_wafv2_ip_set.WAFWhitelistSetV6.name\n    WAFBlacklistSetIPV6Name                   = aws_wafv2_ip_set.WAFBlacklistSetV6.name\n    WAFHttpFloodSetIPV6Name                   = local.WAFHttpFloodSetIPV6Name\n    WAFScannersProbesSetIPV6Name              = local.WAFScannersProbesSetIPV6Name\n    WAFReputationListsSetIPV6Name             = local.WAFReputationListsSetIPV6Name\n    WAFBadBotSetIPV6Name                      = local.WAFBadBotSetIPV6Name\n    wafwebacl                                 = aws_wafv2_web_acl.wafacl.name\n    AddAthenaPartitionsLambdaarn              = local.AddAthenaPartitionsLambdaarn\n    ResourceType                              = \"CustomResource\"\n    GlueAccessLogsDatabase                    = local.GlueAccessLogsDatabase\n    GlueAppAccessLogsTable                    = local.AppAccessLogsTable\n    GlueWafAccessLogsTable                    = local.GlueWafAccessLogsTable\n    AthenaWorkGroup                           = local.AthenaWorkGroup\n  }\n\n  template_body = <<STACK\n{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Parameters\" : {\n    \"Helperarn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ErrorThreshold\" : {\n      \"Type\" : \"Number\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"version\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"SNSEmailParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"AthenaWorkGroup\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFWhitelistSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBlacklistSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFHttpFloodSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFScannersProbesSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFReputationListsSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBadBotSetIPV4\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFWhitelistSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBlacklistSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFHttpFloodSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFScannersProbesSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFReputationListsSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"AddAthenaPartitionsLambdaarn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ResourceType\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"GlueAccessLogsDatabase\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"GlueAppAccessLogsTable\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"GlueWafAccessLogsTable\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBadBotSetIPV6\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFWhitelistSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBlacklistSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFHttpFloodSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFScannersProbesSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFReputationListsSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBadBotSetIPV4Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFWhitelistSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBlacklistSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFHttpFloodSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFScannersProbesSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFReputationListsSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFScannersProbesSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"AthenaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Code Build Project Name\"\n    },\n    \"WAFBlockPeriod\" : {\n      \"Type\" : \"Number\",\n      \"Description\" : \"Code Build Project Name\"\n    },\n    \"HttpFloodProtectionRateBasedRuleActivated\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"HttpFloodAthenaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"WafLogBucket\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"HttpFloodLambdaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ScannersProbesLambdaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"HttpFloodProtectionLogParserActivated\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ScannersProbesProtectionActivated\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"BadBotProtectionActivated\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ProtectionActivatedScannersProbes\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"AppAccessLogBucket\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"Region\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"EndpointType\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"RequestThreshold\" : {\n      \"Type\" : \"Number\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ReputationListsParserarn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ReputationListsProtectionActivated\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ScannersProbesLambdaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"LogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"IPRetentionPeriodAllowedParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"IPRetentionPeriodDeniedParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"KeepDataInOriginalS3Location\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateHttpFloodProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateAWSManagedRulesParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"wafwebacl\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateSqlInjectionProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"WAFBadBotSetIPV6Name\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"SendAnonymousUsageData\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateReputationListsProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateBadBotProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateCrossSiteScriptingProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"ActivateScannersProbesProtectionParam\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"IP Set names\"\n    },\n    \"AccessLoggingBucket\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"ScannersProbesAthenaLogParser\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"MoveS3LogsForPartitionarn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"WAFWebACLArn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"DeliveryStreamArn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    },\n    \"CustomResourcearn\" : {\n      \"Type\" : \"String\",\n      \"Description\" : \"Lambda Function ARN\"\n    }\n  },\n  \"Conditions\": {\n        \"HttpFloodProtectionLogParserActivated\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"HttpFloodProtectionLogParserActivated\"\n                },\n                \"yes\"\n            ]\n        },\n          \"HttpFloodLambdaLogParser\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"HttpFloodLambdaLogParser\"\n                },\n                \"yes\"\n            ]\n        },\n          \"ReputationListsProtectionActivated\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"ReputationListsProtectionActivated\"\n                },\n                \"yes\"\n            ]\n        },\n          \"ScannersProbesAthenaLogParser\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"ScannersProbesAthenaLogParser\"\n                },\n                \"yes\"\n            ]\n        },\n          \"ScannersProbesLambdaLogParser\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"ScannersProbesLambdaLogParser\"\n                },\n                \"yes\"\n            ]\n        },\n          \"ScannersProbesProtectionActivated\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"ScannersProbesProtectionActivated\"\n                },\n                \"yes\"\n            ]\n        },\n          \"BadBotProtectionActivated\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"BadBotProtectionActivated\"\n                },\n                \"yes\"\n            ]\n        },\n          \"AthenaLogParser\": {\n            \"Fn::Equals\": [\n                {\n                    \"Ref\": \"AthenaLogParser\"\n                },\n                \"yes\"\n            ]\n        }\n    },\n  \"Resources\" : {\n    \"CheckRequirements\": {\n      \"Type\" : \"Custom::CheckRequirements\",\n      \"Properties\" : {\n        \"AthenaLogParser\" : { \"Ref\" : \"AthenaLogParser\" },\n        \"ServiceToken\" : { \"Ref\" : \"Helperarn\" },\n        \"HttpFloodProtectionRateBasedRuleActivated\" : { \"Ref\" : \"HttpFloodProtectionRateBasedRuleActivated\" },\n        \"HttpFloodProtectionLogParserActivated\" : { \"Ref\" : \"HttpFloodProtectionLogParserActivated\" },\n        \"ProtectionActivatedScannersProbes\" : { \"Ref\" : \"ProtectionActivatedScannersProbes\" },\n        \"AppAccessLogBucket\" : { \"Ref\" : \"AppAccessLogBucket\" },\n        \"Region\" : { \"Ref\" : \"Region\" },\n        \"EndpointType\" : { \"Ref\" : \"EndpointType\" },\n        \"RequestThreshold\" : { \"Ref\" : \"RequestThreshold\" }\n      }\n    },\n      \"CreateUniqueID\": {\n        \"Type\" : \"Custom::CreateUUID\",\n        \"DependsOn\" : \"CheckRequirements\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"Helperarn\" }\n      }\n    },\n      \"CreateDeliveryStreamName\": {\n        \"Type\" : \"Custom::CreateDeliveryStreamName\",\n        \"Condition\" : \"HttpFloodProtectionLogParserActivated\",\n        \"DependsOn\" : \"CheckRequirements\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"Helperarn\" },\n          \"StackName\" : { \"Ref\" : \"AWS::StackName\" }\n      }\n    },\n      \"CreateGlueDatabaseName\": {\n        \"Type\" : \"Custom::CreateGlueDatabaseName\",\n        \"Condition\" : \"AthenaLogParser\",\n        \"DependsOn\" : \"CheckRequirements\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"Helperarn\" },\n          \"StackName\" : { \"Ref\" : \"AWS::StackName\" }\n      }\n    },\n      \"UpdateReputationListsOnLoad\": {\n        \"Type\" : \"Custom::UpdateReputationLists\",\n        \"Condition\" : \"ReputationListsProtectionActivated\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"ReputationListsParserarn\" }\n      }\n    },\n      \"ConfigureAWSWAFLogs\": {\n        \"Type\" : \"Custom::ConfigureAWSWAFLogs\",\n        \"Condition\" : \"HttpFloodProtectionLogParserActivated\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"WAFWebACLArn\" : { \"Ref\" : \"WAFWebACLArn\" },\n          \"DeliveryStreamArn\" : { \"Ref\" : \"DeliveryStreamArn\" }\n      }\n    },\n      \"ConfigureAppAccessLogBucket\": {\n        \"Type\" : \"Custom::ConfigureAppAccessLogBucket\",\n        \"Condition\" : \"ScannersProbesProtectionActivated\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"Region\" : { \"Ref\" : \"Region\" },\n          \"AppAccessLogBucket\" : { \"Ref\" : \"AppAccessLogBucket\" },\n          \"LogParser\" : { \"Ref\" : \"LogParser\" },\n          \"ScannersProbesLambdaLogParser\" : { \"Ref\" : \"ScannersProbesLambdaLogParser\" },\n          \"ScannersProbesAthenaLogParser\" : { \"Ref\" : \"ScannersProbesAthenaLogParser\" },\n          \"MoveS3LogsForPartition\" : { \"Fn::If\" : [\n                                            \"ScannersProbesAthenaLogParser\",\n                                            {\"Ref\" : \"MoveS3LogsForPartitionarn\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"AccessLoggingBucket\" : { \"Fn::If\" : [\n                                            \"ScannersProbesProtectionActivated\",\n                                            {\"Ref\" : \"AccessLoggingBucket\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] }\n      }\n    },\n      \"ConfigureWafLogBucket\": {\n        \"Type\" : \"Custom::ConfigureWafLogBucket\",\n        \"Condition\" : \"HttpFloodProtectionLogParserActivated\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"WafLogBucket\" : { \"Ref\" : \"WafLogBucket\" },\n          \"LogParser\" : { \"Ref\" : \"LogParser\" },\n          \"HttpFloodLambdaLogParser\" : { \"Ref\" : \"HttpFloodLambdaLogParser\" },\n          \"HttpFloodAthenaLogParser\" : { \"Ref\" : \"HttpFloodAthenaLogParser\" }\n      }\n    },\n      \"GenerateAppLogParserConfFile\": {\n        \"Type\" : \"Custom::GenerateAppLogParserConfFile\",\n        \"DependsOn\" : \"ConfigureAppAccessLogBucket\",\n        \"Condition\" : \"ScannersProbesLambdaLogParser\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"AppAccessLogBucket\" : { \"Ref\" : \"AppAccessLogBucket\" },\n          \"StackName\" : { \"Ref\" : \"AWS::StackName\" },\n          \"ErrorThreshold\" : { \"Ref\" : \"ErrorThreshold\" },\n          \"WAFBlockPeriod\" : { \"Ref\" : \"WAFBlockPeriod\" }\n      }\n    },\n      \"GenerateWafLogParserConfFile\": {\n        \"Type\" : \"Custom::GenerateWafLogParserConfFil\",\n        \"Condition\" : \"HttpFloodLambdaLogParser\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"WafAccessLogBucket\" : { \"Ref\" : \"WafLogBucket\" },\n          \"StackName\" : { \"Ref\" : \"AWS::StackName\" },\n          \"RequestThreshold\" : { \"Ref\" : \"RequestThreshold\" },\n          \"WAFBlockPeriod\" : { \"Ref\" : \"WAFBlockPeriod\" }\n      }\n    },\n      \"ConfigureWebAcl\": {\n        \"Type\" : \"Custom::ConfigureWebAcl\",\n        \"Condition\" : \"HttpFloodLambdaLogParser\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"ActivateSqlInjectionProtectionParam\" : { \"Ref\" : \"ActivateSqlInjectionProtectionParam\" },\n          \"ActivateCrossSiteScriptingProtectionParam\" : { \"Ref\" : \"ActivateCrossSiteScriptingProtectionParam\" },\n          \"ActivateHttpFloodProtectionParam\" : { \"Ref\" : \"ActivateHttpFloodProtectionParam\" },\n          \"ActivateScannersProbesProtectionParam\" : { \"Ref\" : \"ActivateScannersProbesProtectionParam\" },\n          \"ActivateReputationListsProtectionParam\" : { \"Ref\" : \"ActivateReputationListsProtectionParam\" },\n          \"ActivateBadBotProtectionParam\" : { \"Ref\" : \"ActivateBadBotProtectionParam\" },\n          \"ActivateAWSManagedRulesParam\" : { \"Ref\" : \"ActivateAWSManagedRulesParam\" },\n          \"KeepDataInOriginalS3Location\" : { \"Ref\" : \"KeepDataInOriginalS3Location\" },\n          \"IPRetentionPeriodAllowedParam\" : { \"Ref\" : \"IPRetentionPeriodAllowedParam\" },\n          \"IPRetentionPeriodDeniedParam\" : { \"Ref\" : \"IPRetentionPeriodDeniedParam\" },\n          \"SNSEmailParam\" : { \"Ref\" : \"SNSEmailParam\" },\n          \"WAFWebACL\" : { \"Ref\" : \"wafwebacl\" },\n          \"WAFWhitelistSetIPV4\" : { \"Ref\" : \"WAFWhitelistSetIPV4\" },\n          \"WAFBlacklistSetIPV4\" : { \"Ref\" : \"WAFBlacklistSetIPV4\" },\n          \"WAFHttpFloodSetIPV4\" : { \"Fn::If\" : [\n                                            \"HttpFloodProtectionLogParserActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV4\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFScannersProbesSetIPV4\" : { \"Fn::If\" : [\n                                            \"ScannersProbesProtectionActivated\",\n                                            {\"Ref\" : \"WAFScannersProbesSetIPV4\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFReputationListsSetIPV4\" : { \"Fn::If\" : [\n                                            \"ReputationListsProtectionActivated\",\n                                            {\"Ref\" : \"WAFReputationListsSetIPV4\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFBadBotSetIPV4\" : { \"Fn::If\" : [\n                                            \"BadBotProtectionActivated\",\n                                            {\"Ref\" : \"WAFBadBotSetIPV4\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFWhitelistSetIPV6\" : { \"Ref\" : \"WAFWhitelistSetIPV6\" },\n          \"WAFBlacklistSetIPV6\" : { \"Ref\" : \"WAFBlacklistSetIPV6\" },\n          \"WAFHttpFloodSetIPV6\" : { \"Fn::If\" : [\n                                            \"HttpFloodProtectionLogParserActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFScannersProbesSetIPV6\" : { \"Fn::If\" : [\n                                            \"ScannersProbesProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFReputationListsSetIPV6\" : { \"Fn::If\" : [\n                                            \"ReputationListsProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFBadBotSetIPV6\" : { \"Fn::If\" : [\n                                            \"BadBotProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFWhitelistSetIPV4Name\" : { \"Ref\" : \"WAFWhitelistSetIPV4Name\" },\n          \"WAFBlacklistSetIPV4Name\" : { \"Ref\" : \"WAFBlacklistSetIPV4Name\" },\n          \"WAFHttpFloodSetIPV4Name\" : { \"Fn::If\" : [\n                                            \"HttpFloodProtectionLogParserActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFScannersProbesSetIPV4Name\" : { \"Fn::If\" : [\n                                            \"ScannersProbesProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFReputationListsSetIPV4Name\" : { \"Fn::If\" : [\n                                            \"ReputationListsProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFBadBotSetIPV4Name\" : { \"Fn::If\" : [\n                                            \"BadBotProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFWhitelistSetIPV6Name\" : { \"Ref\" : \"WAFWhitelistSetIPV6Name\" },\n          \"WAFBlacklistSetIPV6Name\" : { \"Ref\" : \"WAFBlacklistSetIPV6Name\" },\n          \"WAFHttpFloodSetIPV6Name\" : { \"Fn::If\" : [\n                                            \"HttpFloodProtectionLogParserActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFScannersProbesSetIPV6Name\" : { \"Fn::If\" : [\n                                            \"ScannersProbesProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFReputationListsSetIPV6Name\" : { \"Fn::If\" : [\n                                            \"ReputationListsProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"WAFBadBotSetIPV6Name\" : { \"Fn::If\" : [\n                                            \"BadBotProtectionActivated\",\n                                            {\"Ref\" : \"WAFHttpFloodSetIPV6Name\"},\n                                            {\"Ref\" : \"AWS::NoValue\"}\n                                          ] },\n          \"UUID\" : { \"Fn::GetAtt\" : [ \"CreateUniqueID\", \"UUID\" ] },\n          \"Region\" : { \"Ref\" : \"Region\" },\n          \"RequestThreshold\" : { \"Ref\" : \"RequestThreshold\" },\n          \"ErrorThreshold\" : { \"Ref\" : \"ErrorThreshold\" },\n          \"WAFBlockPeriod\" : { \"Ref\" : \"WAFBlockPeriod\" },\n          \"Version\" : { \"Ref\" : \"version\" },\n          \"SendAnonymousUsageData\" : { \"Ref\" : \"SendAnonymousUsageData\" }\n      }\n    },\n      \"CustomAddAthenaPartitions\": {\n        \"Type\" : \"Custom::AddAthenaPartition\",\n        \"Condition\" : \"AthenaLogParser\",\n        \"Properties\" : {\n          \"ServiceToken\" : { \"Ref\" : \"CustomResourcearn\" },\n          \"AddAthenaPartitionsLambda\" : { \"Ref\" : \"AddAthenaPartitionsLambdaarn\" },\n          \"ResourceType\" : { \"Ref\" : \"ResourceType\" },\n          \"GlueAccessLogsDatabase\" : { \"Ref\" : \"GlueAccessLogsDatabase\" },\n          \"AppAccessLogBucket\" : { \"Ref\" : \"AppAccessLogBucket\" },\n          \"GlueAppAccessLogsTable\" : { \"Ref\" : \"GlueAppAccessLogsTable\" },\n          \"GlueWafAccessLogsTable\" : { \"Ref\" : \"GlueWafAccessLogsTable\" },\n          \"WafLogBucket\" : { \"Ref\" : \"WafLogBucket\" },\n          \"AthenaWorkGroup\" : { \"Ref\" : \"AthenaWorkGroup\" }\n      }\n    }\n  },\n  \"Outputs\" : {\n  \n      \"UUID\" : {\n  \n        \"Description\" : \"UUID of the newly created  instance\",\n  \n        \"Value\" : { \"Fn::GetAtt\" : [ \"CreateUniqueID\", \"UUID\" ] }\n  \n    }\n  }\n}\nSTACK\n  depends_on = [\n    aws_iam_role_policy.CloudWatchAccessListsParser,\n    aws_iam_role_policy.WAFGetAndUpdateIPListsParser,\n    aws_iam_role_policy.CloudWatchLogsListsParser,\n    aws_lambda_function.helper,\n    aws_lambda_function.MoveS3LogsForPartition,\n    aws_lambda_function.SetIPRetention,\n    aws_lambda_function.ReputationListsParser,\n    aws_lambda_function.CustomResource,\n    aws_lambda_function.LogParser,\n    aws_lambda_function.AddAthenaPartitions,\n    aws_lambda_function.CustomTimer\n  ]\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# Firehose Athena \n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_iam_role\" \"FirehoseWAFLogsDeliveryStreamRole\" {\n  count = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name  = \"FirehoseWAFLogsDeliveryStreamRole1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"S3AccessFirehoseWAFLogs\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"S3Access1\"\n  role   = aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"s3:GetBucketLocation\",\n                \"s3:GetObject\",\n                \"s3:ListBucket\",\n                \"s3:AbortMultipartUpload\",\n                \"s3:ListBucketMultipartUploads\",\n                \"s3:PutObject\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}\",\n                \"arn:${data.aws_partition.current.partition}:s3:::${aws_s3_bucket.WafLogBucket[0].bucket}/*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0]\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"KinesisAccess\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"KinesisAccess1\"\n  role   = aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"kinesis:DescribeStream\",\n                \"kinesis:GetShardIterator\",\n                \"kinesis:GetRecords\"\n            ],\n            \"Resource\": [\n                  \"arn:${data.aws_partition.current.partition}:kinesis:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:stream/${var.DeliveryStreamName}\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0]\n  ]\n}\n\nresource \"aws_iam_role_policy\" \"CloudWatchAccess\" {\n  count  = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name   = \"CloudWatchAccess1\"\n  role   = aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": [\n                  \"arn:${data.aws_partition.current.partition}:kinesis:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:/aws/kinesisfirehose/${var.DeliveryStreamName}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0]\n  ]\n}\n\n\nresource \"aws_kinesis_firehose_delivery_stream\" \"extended_s3_stream\" {\n  count       = local.HttpFloodProtectionLogParserActivated == \"yes\" ? 1 : 0\n  name        = var.DeliveryStreamName\n  destination = \"extended_s3\"\n  server_side_encryption {\n    key_type = \"CUSTOMER_MANAGED_CMK\"\n    enabled  = \"true\"\n    key_arn  = aws_kms_key.wafkey.arn\n  }\n  extended_s3_configuration {\n    bucket_arn          = aws_s3_bucket.WafLogBucket[0].arn\n    compression_format  = \"GZIP\"\n    error_output_prefix = \"AWSErrorLogs/result=!{firehose:error-output-type}/year=!{timestamp:yyyy}/month=!{timestamp:MM}/day=!{timestamp:dd}/hour=!{timestamp:HH}/\"\n    role_arn            = aws_iam_role.FirehoseWAFLogsDeliveryStreamRole[0].arn\n    buffer_size         = 5\n    buffer_interval     = 300\n  }\n}\n\n\n# ----------------------------------------------------------------------------------------------------------------------\n# Glue Database and tables\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_glue_catalog_database\" \"mydatabase\" {\n  count      = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name       = \"mygluedatabase-${random_id.server.hex}\"\n  catalog_id = data.aws_caller_identity.current.account_id\n}\n\nresource \"aws_glue_catalog_table\" \"waf_access_logs_table\" {\n  count         = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"waf_access_logs-${random_id.server.hex}\"\n  database_name = aws_glue_catalog_database.mydatabase[0].name\n  catalog_id    = data.aws_caller_identity.current.account_id\n  parameters = {\n    EXTERNAL = \"TRUE\"\n  }\n  partition_keys {\n    name = \"year\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"month\"\n    type = \"init\"\n  }\n  partition_keys {\n    name = \"day\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"hour\"\n    type = \"int\"\n  }\n  storage_descriptor {\n    location      = \"s3://${aws_s3_bucket.WafLogBucket[0].bucket}/AWSLogs/\"\n    input_format  = \"org.apache.hadoop.mapred.TextInputFormat\"\n    output_format = \"org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat\"\n\n    ser_de_info {\n      serialization_library = \"org.openx.data.jsonserde.JsonSerDe\"\n\n      parameters = {\n        \"paths\" = \"action,formatVersion,httpRequest,httpSourceId,httpSourceName,nonTerminatingMatchingRules,rateBasedRuleList,ruleGroupList,terminatingRuleId,terminatingRuleType,timestamp,webaclId\"\n      }\n    }\n    compressed                = \"true\"\n    stored_as_sub_directories = \"false\"\n    dynamic \"columns\" {\n      for_each = var.waf_access_logs_columns\n\n      content {\n        name = columns.key\n        type = columns.value\n      }\n    }\n  }\n}\n\n\nresource \"aws_glue_catalog_table\" \"ALBGlueAppAccessLogsTable\" {\n  count         = local.AthenaLogParser == \"yes\" && local.ALBScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"app_access_logs-${random_id.server.hex}\"\n  database_name = aws_glue_catalog_database.mydatabase[0].name\n  catalog_id    = data.aws_caller_identity.current.account_id\n  parameters = {\n    EXTERNAL = \"TRUE\"\n  }\n  partition_keys {\n    name = \"year\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"month\"\n    type = \"init\"\n  }\n  partition_keys {\n    name = \"day\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"hour\"\n    type = \"int\"\n  }\n  storage_descriptor {\n    location      = \"s3://${local.AppLogBucket}/AWSLogs-Partitioned/\"\n    input_format  = \"org.apache.hadoop.mapred.TextInputFormat\"\n    output_format = \"org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat\"\n\n    ser_de_info {\n      serialization_library = \"org.apache.hadoop.hive.serde2.RegexSerDe\"\n\n      parameters = {\n        \"serialization.format\" = \"1\",\n        \"input.regex\"          = \"([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \\\"([^ ]*) ([^ ]*) (- |[^ ]*)\\\" \\\"([^\\\"]*)\\\" ([A-Z0-9-]+) ([A-Za-z0-9.-]*) ([^ ]*) \\\"([^\\\"]*)\\\" \\\"([^\\\"]*)\\\" \\\"([^\\\"]*)\\\" ([-.0-9]*) ([^ ]*) \\\"([^\\\"]*)\\\" \\\"([^\\\"]*)\\\"($| \\\"[^ ]*\\\")(.*)\"\n      }\n    }\n    compressed                = \"true\"\n    stored_as_sub_directories = \"false\"\n    dynamic \"columns\" {\n      for_each = var.app_access_logs_columns\n      content {\n        name = columns.key\n        type = columns.value\n      }\n    }\n  }\n}\n\nresource \"aws_glue_catalog_table\" \"cloudfrontGlueAppAccessLogsTable\" {\n  count         = local.AthenaLogParser == \"yes\" && local.CloudFrontScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"app_access_logs-${random_id.server.hex}\"\n  database_name = aws_glue_catalog_database.mydatabase[0].name\n  catalog_id    = data.aws_caller_identity.current.account_id\n  parameters = {\n    \"skip.header.line.count\" = \"2\",\n    \"EXTERNAL\"               = \"TRUE\"\n  }\n  partition_keys {\n    name = \"year\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"month\"\n    type = \"init\"\n  }\n  partition_keys {\n    name = \"day\"\n    type = \"int\"\n  }\n  partition_keys {\n    name = \"hour\"\n    type = \"int\"\n  }\n  storage_descriptor {\n    location      = \"s3://${local.AppLogBucket}/AWSLogs-Partitioned/\"\n    input_format  = \"org.apache.hadoop.mapred.TextInputFormat\"\n    output_format = \"org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat\"\n\n    ser_de_info {\n      serialization_library = \"org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\"\n\n      parameters = {\n        \"serialization.format\" = \"\\t\",\n        \"field.delim\"          = \"\\t\"\n      }\n    }\n    compressed                = \"true\"\n    stored_as_sub_directories = \"true\"\n    dynamic \"columns\" {\n      for_each = var.cloudfront_app_access_logs_columns\n      content {\n        name = columns.key\n        type = columns.value\n      }\n    }\n  }\n}\n\n\nresource \"aws_athena_workgroup\" \"WAFAddPartitionAthenaQueryWorkGroup\" {\n  count         = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"WAFAddPartitionAthenaQueryWorkGroup-${random_id.server.hex}\"\n  description   = \"Athena WorkGroup for adding Athena partition queries used by AWS WAF Security Automations Solution\"\n  state         = \"ENABLED\"\n  force_destroy = \"true\"\n\n  configuration {\n    publish_cloudwatch_metrics_enabled = true\n    result_configuration {\n      output_location = \"s3://${local.AppLogBucket}/outputWAFAppAccessLogAthenaQueryWorkGroup/\"\n      encryption_configuration {\n        encryption_option = \"SSE_KMS\"\n        kms_key_arn       = aws_kms_key.wafkey.arn\n      }\n    }\n  }\n}\n\nresource \"aws_athena_workgroup\" \"WAFLogAthenaQueryWorkGroup\" {\n  count         = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"WAFLogAthenaQueryWorkGroup-${random_id.server.hex}\"\n  description   = \"Athena WorkGroup for adding Athena partition queries used by AWS WAF Security Automations Solution\"\n  state         = \"ENABLED\"\n  force_destroy = \"true\"\n\n  configuration {\n    publish_cloudwatch_metrics_enabled = true\n    result_configuration {\n      output_location = \"s3://${local.AppLogBucket}/outputWAFAppAccessLogAthenaQueryWorkGroup/\"\n      encryption_configuration {\n        encryption_option = \"SSE_KMS\"\n        kms_key_arn       = aws_kms_key.wafkey.arn\n      }\n    }\n  }\n}\n\nresource \"aws_athena_workgroup\" \"WAFAppAccessLogAthenaQueryWorkGroup\" {\n  count         = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name          = \"WAFAppAccessLogAthenaQueryWorkGroup-${random_id.server.hex}\"\n  description   = \"Athena WorkGroup for adding Athena partition queries used by AWS WAF Security Automations Solution\"\n  state         = \"ENABLED\"\n  force_destroy = \"true\"\n\n  configuration {\n    publish_cloudwatch_metrics_enabled = true\n    result_configuration {\n      output_location = \"s3://${local.AppLogBucket}/outputWAFAppAccessLogAthenaQueryWorkGroup/\"\n      encryption_configuration {\n        encryption_option = \"SSE_KMS\"\n        kms_key_arn       = aws_kms_key.wafkey.arn\n      }\n    }\n  }\n}\n\n\n# ----------------------------------------------------------------------------------------------------------------------\n# CREATE A EVENT RULES\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_cloudwatch_event_rule\" \"LambdaAddAthenaPartitionsEventsRule\" {\n  count               = local.AthenaLogParser == \"yes\" ? 1 : 0\n  name                = \"LambdaAddAthenaPartitionsEventsRule-${random_id.server.hex}\"\n  description         = \"Security Automations - Add partitions to Athena table\"\n  schedule_expression = \"cron(* ? * * * *)\"\n  is_enabled          = true\n}\n\n\nresource \"aws_cloudwatch_event_target\" \"LambdaAddAthenaPartitionstarget\" {\n  count     = local.AthenaLogParser == \"yes\" && local.ALBScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  target_id = \"LambdaAddAthenaPartitions\"\n  arn       = aws_lambda_function.AddAthenaPartitions[0].arn\n  rule      = aws_cloudwatch_event_rule.LambdaAddAthenaPartitionsEventsRule[0].name\n  input     = <<EOF\n                {\n                \"resourceType\": \"LambdaAddAthenaPartitionsEventsRule\",\n                \"glueAccessLogsDatabase\": \"${aws_glue_catalog_database.mydatabase[0].name}\",\n                \"accessLogBucket\": \"${local.AppLogBucket}\",\n                \"glueAppAccessLogsTable\": \"${aws_glue_catalog_table.ALBGlueAppAccessLogsTable[0].name}\",\n                \"glueWafAccessLogsTable\": \"${aws_glue_catalog_table.waf_access_logs_table[0].name}\",\n                \"wafLogBucket\": \"${aws_s3_bucket.WafLogBucket[0].bucket}\",\n                \"athenaWorkGroup\": \"${aws_athena_workgroup.WAFAddPartitionAthenaQueryWorkGroup[0].name}\"\n              }\nEOF\n  depends_on = [\n    aws_cloudwatch_event_rule.LambdaAddAthenaPartitionsEventsRule\n  ]\n}\n\nresource \"aws_cloudwatch_event_rule\" \"LambdaAthenaWAFLogParserrule\" {\n  count               = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  name                = \"LambdaAthenaWAFLogParserrule-${random_id.server.hex}\"\n  description         = \"Security Automations - WAF Logs Athena parser\"\n  schedule_expression = \"rate(5 minutes)\"\n  is_enabled          = true\n}\n\nresource \"aws_cloudwatch_event_target\" \"LogParsertarget\" {\n  count     = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  target_id = \"LogParser\"\n  arn       = aws_lambda_function.LogParser[0].arn\n  rule      = aws_cloudwatch_event_rule.LambdaAthenaWAFLogParserrule[0].name\n  input     = <<EOF\n            {\n              \"resourceType\": \"LambdaAthenaWAFLogParser\",\n              \"glueAccessLogsDatabase\": \"${aws_glue_catalog_database.mydatabase[0].name}\",\n              \"accessLogBucket\": \"${local.AppLogBucket}\",\n              \"glueWafAccessLogsTable\": \"${aws_glue_catalog_table.waf_access_logs_table[0].name}\",\n              \"athenaWorkGroup\":\"${aws_athena_workgroup.WAFAppAccessLogAthenaQueryWorkGroup[0].name}\"\n            }\nEOF\n  depends_on = [\n    aws_cloudwatch_event_rule.LambdaAthenaWAFLogParserrule\n  ]\n}\n\nresource \"aws_cloudwatch_event_rule\" \"LambdaAthenaAppLogParserrule\" {\n  count               = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  name                = \"LambdaAthenaAppLogParserrule-${random_id.server.hex}\"\n  description         = \"Security Automation - App Logs Athena parser\"\n  schedule_expression = \"rate(5 minutes)\"\n  is_enabled          = true\n}\n\nresource \"aws_cloudwatch_event_target\" \"LogParsertarget1\" {\n  count     = local.ScannersProbesAthenaLogParser == \"yes\" && local.ALBScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  target_id = \"LogParser\"\n  arn       = aws_lambda_function.LogParser[0].arn\n  rule      = aws_cloudwatch_event_rule.LambdaAthenaAppLogParserrule[0].name\n  input     = <<EOF\n            {\n              \"resourceType\": \"LambdaAthenaAppLogParser\",\n              \"glueAccessLogsDatabase\": \"${aws_glue_catalog_database.mydatabase[0].name}\",\n              \"accessLogBucket\": \"${local.AppLogBucket}\",\n              \"glueAppAccessLogsTable\": \"${local.AppAccessLogsTable}\",\n              \"athenaWorkGroup\": \"${aws_athena_workgroup.WAFAppAccessLogAthenaQueryWorkGroup[0].name}\"\n            }\nEOF\n  depends_on = [\n    aws_cloudwatch_event_rule.LambdaAthenaAppLogParserrule[0]\n  ]\n}\n\n\nresource \"aws_cloudwatch_event_rule\" \"ReputationListsParserEventsRule\" {\n  count               = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  name                = \"ReputationEventsRule-${random_id.server.hex}\"\n  description         = \"Security Automation - WAF Reputation Lists\"\n  schedule_expression = \"rate(1 hour)\"\n  is_enabled          = true\n}\n\nresource \"aws_cloudwatch_event_target\" \"ReputationListsParsertarget\" {\n  target_id = \"ReputationListsParser\"\n  arn       = aws_lambda_function.ReputationListsParser[0].arn\n  rule      = aws_cloudwatch_event_rule.ReputationListsParserEventsRule[0].name\n  input     = <<EOF\n              {\n                \"URL_LIST\": [\n                  {\"url\":\"https://www.spamhaus.org/drop/drop.txt\"},\n                  {\"url\":\"https://www.spamhaus.org/drop/edrop.txt\"},\n                  {\"url\":\"https://check.torproject.org/exit-addresses\", \"prefix\":\"ExitAddress\"},\n                  {\"url\":\"https://rules.emergingthreats.net/fwrules/emerging-Block-IPs.txt\"}\n                ],\n                \"IP_SET_ID_REPUTATIONV4\": \"${aws_wafv2_ip_set.WAFReputationListsSetV4[0].arn}\",\n                \"IP_SET_ID_REPUTATIONV6\": \"${aws_wafv2_ip_set.WAFReputationListsSetV6[0].arn}\",\n                \"IP_SET_NAME_REPUTATIONV4\": \"${aws_wafv2_ip_set.WAFReputationListsSetV4[0].name}\",\n                \"IP_SET_NAME_REPUTATIONV6\": \"${aws_wafv2_ip_set.WAFReputationListsSetV6[0].name}\",\n                \"SCOPE\": \"${local.SCOPE}\"\n              }\nEOF\n  depends_on = [\n    aws_cloudwatch_event_rule.ReputationListsParserEventsRule\n  ]\n}\n\nresource \"aws_cloudwatch_event_rule\" \"SetIPRetentionEventsRule\" {\n  count         = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  name          = \"IPRetentionPeriodsRule-${random_id.server.hex}\"\n  description   = \"AWS WAF Security Automations - Events rule for setting IP retention\"\n  is_enabled    = true\n  event_pattern = <<EOF\n{\n  \"detail-type\": [\"AWS API Call via CloudTrail\"],\n  \"source\": [\"aws.wafv2\"],\n  \"detail\": {\n    \"eventSource\": [\"wafv2.amazonaws.com\"],\n    \"eventName\": [\"UpdateIPSet\"],\n    \"requestParameters\" : [\n        \"${aws_wafv2_ip_set.WAFWhitelistSetV4.name}\",\n        \"${aws_wafv2_ip_set.WAFBlacklistSetV4.name}\",\n        \"${aws_wafv2_ip_set.WAFWhitelistSetV6.name}\",\n        \"${aws_wafv2_ip_set.WAFBlacklistSetV6.name}\"\n    ]\n\n  }\n}\n  EOF\n}\n\nresource \"aws_cloudwatch_event_target\" \"SetIPRetentionEventstarget\" {\n  count     = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  target_id = \"SetIPRetentionLambda\"\n  arn       = aws_lambda_function.SetIPRetention[0].arn\n  rule      = aws_cloudwatch_event_rule.SetIPRetentionEventsRule[0].name\n  depends_on = [\n    aws_cloudwatch_event_rule.SetIPRetentionEventsRule[0]\n  ]\n}\n\n\n# ----------------------------------------------------------------------------------------------------------------------\n# CREATE A LAMBDA PERMISSION\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionAppLogParserS3\" {\n  count          = local.LogParser == \"yes\" ? 1 : 0\n  action         = \"lambda:InvokeFunction\"\n  function_name  = aws_lambda_function.LogParser[0].function_name\n  principal      = \"s3.amazonaws.com\"\n  source_account = data.aws_caller_identity.current.account_id\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionMoveS3LogsForPartition\" {\n  count          = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  action         = \"lambda:InvokeFunction\"\n  function_name  = aws_lambda_function.MoveS3LogsForPartition[0].function_name\n  principal      = \"s3.amazonaws.com\"\n  source_account = data.aws_caller_identity.current.account_id\n}\n\nresource \"aws_lambda_permission\" \"LambdaPermissionAddAthenaPartitions\" {\n  count         = local.AthenaLogParser == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.AddAthenaPartitions[0].function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.LambdaAddAthenaPartitionsEventsRule[0].arn\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionSetIPRetention\" {\n  count         = var.IPRetentionPeriod == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.SetIPRetention[0].function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.SetIPRetentionEventsRule[0].arn\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionWafLogParserCloudWatch\" {\n  count         = local.HttpFloodAthenaLogParser == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.LogParser[0].function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.LambdaAthenaWAFLogParserrule[0].arn\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionAppLogParserCloudWatch\" {\n  count         = local.ScannersProbesAthenaLogParser == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.LogParser[0].function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.LambdaAthenaAppLogParserrule[0].arn\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionReputationListsParser\" {\n  count         = var.ReputationListsProtectionActivated == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.ReputationListsParser[0].function_name\n  principal     = \"events.amazonaws.com\"\n  source_arn    = aws_cloudwatch_event_rule.ReputationListsParserEventsRule[0].arn\n}\n\nresource \"aws_lambda_permission\" \"LambdaInvokePermissionBadBot\" {\n  count         = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  action        = \"lambda:InvokeFunction\"\n  function_name = aws_lambda_function.BadBotParser[0].function_name\n  principal     = \"apigateway.amazonaws.com\"\n  source_arn    = aws_api_gateway_rest_api.api[0].arn\n}\n\n# ----------------------------------------------------------------------------------------------------------------------\n# API gateway\n# ----------------------------------------------------------------------------------------------------------------------\n\nresource \"aws_api_gateway_rest_api\" \"api\" {\n  count       = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name        = \"WAF Bad Bot API-${random_id.server.hex}\"\n  description = \"API created by AWS WAF Security Automation CloudFormation template. This endpoint will be used to capture bad bots.\"\n  lifecycle {\n    create_before_destroy = true\n  }\n}\n\nresource \"aws_api_gateway_resource\" \"resource\" {\n  parent_id   = aws_api_gateway_rest_api.api[0].root_resource_id\n  path_part   = \"{proxy+}\"\n  rest_api_id = aws_api_gateway_rest_api.api[0].id\n  depends_on = [\n    aws_api_gateway_rest_api.api\n  ]\n}\n\nresource \"aws_api_gateway_method\" \"ApiGatewayBadBotMethodRoot\" {\n  authorization      = \"NONE\"\n  http_method        = \"ANY\"\n  api_key_required   = true\n  resource_id        = aws_api_gateway_rest_api.api[0].root_resource_id\n  rest_api_id        = aws_api_gateway_rest_api.api[0].id\n  request_parameters = { \"method.request.header.X-Forwarded-For\" = false }\n  depends_on = [\n    aws_lambda_permission.LambdaInvokePermissionBadBot,\n    aws_api_gateway_rest_api.api\n  ]\n}\n\nresource \"aws_api_gateway_integration\" \"integrationroot\" {\n  rest_api_id             = aws_api_gateway_rest_api.api[0].id\n  resource_id             = aws_api_gateway_rest_api.api[0].root_resource_id\n  http_method             = aws_api_gateway_method.ApiGatewayBadBotMethodRoot.http_method\n  integration_http_method = \"POST\"\n  type                    = \"AWS_PROXY\"\n  uri                     = \"arn:${data.aws_partition.current.partition}:apigateway:${data.aws_region.current.name}:lambda:path/2015-03-31/functions/${aws_lambda_function.BadBotParser[0].arn}/invocations\"\n  depends_on = [\n    aws_api_gateway_method.ApiGatewayBadBotMethodRoot,\n    aws_api_gateway_rest_api.api\n  ]\n}\n\n\n\nresource \"aws_api_gateway_method\" \"ApiGatewayBadBotMethod\" {\n  authorization      = \"NONE\"\n  http_method        = \"ANY\"\n  api_key_required   = true\n  resource_id        = aws_api_gateway_resource.resource.id\n  rest_api_id        = aws_api_gateway_rest_api.api[0].id\n  request_parameters = { \"method.request.header.X-Forwarded-For\" = false }\n  depends_on = [\n    aws_lambda_permission.LambdaInvokePermissionBadBot\n  ]\n}\n\nresource \"aws_api_gateway_integration\" \"integration\" {\n  rest_api_id             = aws_api_gateway_rest_api.api[0].id\n  resource_id             = aws_api_gateway_resource.resource.id\n  http_method             = aws_api_gateway_method.ApiGatewayBadBotMethod.http_method\n  integration_http_method = \"POST\"\n  type                    = \"AWS_PROXY\"\n  uri                     = \"arn:${data.aws_partition.current.partition}:apigateway:${data.aws_region.current.name}:lambda:path/2015-03-31/functions/${aws_lambda_function.BadBotParser[0].arn}/invocations\"\n  depends_on = [\n    aws_api_gateway_method.ApiGatewayBadBotMethod\n  ]\n}\n\n\nresource \"aws_api_gateway_deployment\" \"deployment\" {\n  rest_api_id = aws_api_gateway_rest_api.api[0].id\n  stage_name  = \"CFDeploymentStage-${random_id.server.hex}\"\n  lifecycle {\n    create_before_destroy = true\n  }\n  depends_on = [\n    aws_api_gateway_method.ApiGatewayBadBotMethod,\n    aws_api_gateway_integration.integration\n    \n  ]\n}\n\n\n\nresource \"aws_cloudwatch_log_group\" \"ApiGatewayBadBotStageAccessLogGroup\" {\n  count             = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name              = \"ApiGatewayBadBotStageAccessLogGroup-${random_id.server.hex}\"\n  retention_in_days = 90\n  kms_key_id        = aws_kms_key.wafkey.arn\n}\n\nresource \"aws_api_gateway_stage\" \"stage\" {\n  count = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  deployment_id         = aws_api_gateway_deployment.deployment.id\n  rest_api_id           = aws_api_gateway_rest_api.api[0].id\n  stage_name            = \"ProdStage\"\n  xray_tracing_enabled  = true\n  cache_cluster_enabled = true\n  cache_cluster_size    = 0.5\n  access_log_settings {\n    destination_arn = aws_cloudwatch_log_group.ApiGatewayBadBotStageAccessLogGroup[0].arn\n    format = jsonencode({\n      sourceIp       = \"$context.identity.sourceIp\"\n      caller         = \"$context.identity.caller\"\n      user           = \"$context.identity.user\"\n      requestTime    = \"$context.requestTime\"\n      httpMethod     = \"$context.httpMethod\"\n      resourcePath   = \"$context.resourcePath\"\n      protocol       = \"$context.protocol\"\n      status         = \"$context.status\"\n      responseLength = \"$context.responseLength\"\n      requestId      = \"$context.requestId\"\n      }\n    )\n  }\n}\n\n\nresource \"aws_api_gateway_method_settings\" \"path_specific\" {\n  count       = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  rest_api_id = aws_api_gateway_rest_api.api[0].id\n  stage_name  = aws_api_gateway_stage.stage[0].stage_name\n  method_path = \"*/*\"\n\n  settings {\n    metrics_enabled = true\n    logging_level   = \"INFO\"\n    caching_enabled = true\n  }\n}\n\n\nresource \"aws_iam_role\" \"ApiGatewayBadBotCloudWatchRole\" {\n  count = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  name  = \"BadBotRole1-${random_id.server.hex}\"\n\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"apigateway.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy\" \"ApiGatewayBadBotCloudWatchploicy\" {\n  name   = \"ApiGatewayBadBotCloudWatchpolicy\"\n  role   = aws_iam_role.ApiGatewayBadBotCloudWatchRole[0].id\n  policy = <<EOT\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"logs:CreateLogGroup\",\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\",\n                \"logs:DescribeLogGroups\",\n                \"logs:DescribeLogStreams\",\n                \"logs:GetLogEvents\",\n                \"logs:FilterLogEvents\"\n            ],\n            \"Resource\": [\n                \"arn:${data.aws_partition.current.partition}:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:*\"\n            ],\n            \"Effect\": \"Allow\"\n        }\n    ]\n}\nEOT\n  depends_on = [\n    aws_iam_role.ApiGatewayBadBotCloudWatchRole\n  ]\n}\n\nresource \"aws_api_gateway_account\" \"ApiGatewayBadBotAccount\" {\n  count               = var.BadBotProtectionActivated == \"yes\" ? 1 : 0\n  cloudwatch_role_arn = aws_iam_role.ApiGatewayBadBotCloudWatchRole[0].arn\n  depends_on = [\n    aws_api_gateway_rest_api.api\n  ]\n}\n\n\n# ----------------------------------------------------------------------------------------------------------------------\n# CloudWatch Dashboard\n# ----------------------------------------------------------------------------------------------------------------------\n\n\nresource \"aws_cloudwatch_dashboard\" \"main\" {\n  dashboard_name = \"MonitoringDashboard-${data.aws_region.current.name}\"\n\n  dashboard_body = <<EOF\n{\n  \"widgets\": [\n    {\n      \"type\": \"metric\",\n      \"x\": 0,\n      \"y\": 0,\n      \"width\": 15,\n      \"height\": 10,\n      \"properties\": {\n        \"metrics\":[\n                      [\"WAF\", \"BlockedRequests\", \"WebACL\", \"WAFWebACLMetric\", \"Rule\", \"ALL\", \"Region\", \"${data.aws_region.current.name}\" ],\n                      [\"WAF\", \"AllowedRequests\", \"WebACL\", \"WAFWebACLMetric\", \"Rule\", \"ALL\", \"Region\", \"${data.aws_region.current.name}\" ]\n            ],\n        \"view\": \"timeSeries\",\n        \"stacked\": false,\n        \"stat\": \"Sum\",\n        \"period\": 300,\n        \"region\": \"${data.aws_region.current.name}\"\n      }\n    }\n  ]\n}\nEOF\n}",
        "provider.tf": "terraform {\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \"~> 3.0\"\n    }\n  }\n}\n\n# Configure the AWS Provider\nprovider \"aws\" {\n  region = \"us-east-1\"\n}",
        "var.tf": "variable \"AppAccessLogBucket\" {\n  description = \"Application Access Log Bucket Name\"\n  type        = string\n  default     = \"myownbucket-tam\"\n}\nvariable \"SourceBucket\" {\n  description = \"Lambda source code bucket\"\n  type        = string\n  default     = \"solutions\"\n}\nvariable \"KeyPrefix\" {\n  description = \"Keyprefix values for the lambda source code\"\n  type        = string\n  default     = \"aws-waf-security-automations/v3.2.0\"\n}\nvariable \"LOG_LEVEL\" {\n  description = \"Log level\"\n  type        = string\n  default     = \"INFO\"\n}\n\nvariable \"sse_algorithm\" {\n  description = \"sse_algorithm\"\n  type        = string\n  default     = \"aws:kms\"\n}\n\n#ELigible for switch case\n\nvariable \"ENDPOINT\" {\n  description = \"cloudfront or ALB\"\n  type        = string\n  default     = \"cloudFront\"\n  validation {\n    condition     = contains([\"cloudfront\", \"ALB\"], var.ENDPOINT)\n    error_message = \"Invalid input, options: \\\"cloudfront\\\",\\\"ALB\\\".\"\n  }\n}\n\nlocals {\n  LOG_TYPE = var.ENDPOINT == \"ALB\" ? \"alb\" : \"cloudFront\"\n}\n\nlocals {\n  SCOPE = var.ENDPOINT == \"ALB\" ? \"REGIONAL\" : \"CLOUDFRONT\"\n}\n\nvariable \"USER_AGENT_EXTRA\" {\n  description = \"UserAgent\"\n  type        = string\n  default     = \"AwsSolution/SO0006/v3.2.0\"\n}\nvariable \"SEND_ANONYMOUS_USAGE_DATA\" {\n  description = \"Data collection parameter\"\n  type        = string\n  default     = \"yes\"\n}\nvariable \"MetricsURL\" {\n  description = \"Metrics URL\"\n  type        = string\n  default     = \"https://metrics.awssolutionsbuilder.com/generic\"\n}\nvariable \"SolutionID\" {\n  description = \"UserAgent id value\"\n  type        = string\n  default     = \"SO0006\"\n}\nvariable \"KEEP_ORIGINAL_DATA\" {\n  description = \"S3 original data\"\n  type        = string\n  default     = \"No\"\n}\nvariable \"SendAnonymousUsageData\" {\n  description = \"Data collection parameter\"\n  type        = string\n  default     = \"yes\"\n}\nvariable \"IPRetentionPeriodAllowedParam\" {\n  description = \"IP Retention Settings allowed value\"\n  type        = number\n  default     = -1\n}\nvariable \"IPRetentionPeriodDeniedParam\" {\n  description = \"IP Retention Settings denied value\"\n  type        = number\n  default     = -1\n}\nvariable \"RequestThreshold\" {\n  description = \"request threshold for Log Monitoring Settings\"\n  type        = number\n  default     = 100\n}\nvariable \"WAFBlockPeriod\" {\n  description = \"block period for Log Monitoring Settings\"\n  type        = number\n  default     = 240\n}\nvariable \"ErrorThreshold\" {\n  description = \"error threshold for Log Monitoring Settings\"\n  type        = number\n  default     = 50\n}\n\nvariable \"DeliveryStreamName\" {\n  description = \"Name of the Delivery stream value\"\n  type        = string\n  default     = \"terraform-kinesis-firehose-extended-s3-test-stream\"\n}\n\n\nvariable \"waf_access_logs_columns\" {\n  default = {\n    timestamp                   = \"bigint\"\n    formatversion               = \"int\"\n    webaclid                    = \"string\"\n    terminatingruleid           = \"string\"\n    terminatingruletype         = \"string\"\n    action                      = \"string\"\n    httpsourcename              = \"string\"\n    httpsourceid                = \"string\"\n    rulegrouplist               = \"array<string>\"\n    ratebasedrulelist           = \"array<string>\"\n    nonterminatingmatchingrules = \"array<string>\"\n    httprequest                 = \"struct<clientip:string,country:string,headers:array<struct<name:string,value:string>>,uri:string,args:string,httpversion:string,httpmethod:string,requestid:string>\"\n  }\n}\n\nvariable \"app_access_logs_columns\" {\n  default = {\n    type                     = \"string\"\n    time                     = \"string\"\n    elb                      = \"string\"\n    client_ip                = \"string\"\n    client_port              = \"int\"\n    target_ip                = \"string\"\n    target_port              = \"int\"\n    request_processing_time  = \"double\"\n    response_processing_time = \"double\"\n    target_processing_time   = \"double\"\n    elb_status_code          = \"string\"\n    target_status_code       = \"string\"\n    received_bytes           = \"bigint\"\n    sent_bytes               = \"bigint\"\n    request_verb             = \"string\"\n    request_url              = \"string\"\n    request_proto            = \"string\"\n    user_agent               = \"string\"\n    ssl_cipher               = \"string\"\n    ssl_protocol             = \"string\"\n    target_group_arn         = \"string\"\n    trace_id                 = \"string\"\n    domain_name              = \"string\"\n    chosen_cert_arn          = \"string\"\n    matched_rule_priority    = \"string\"\n    request_creation_time    = \"string\"\n    actions_executed         = \"string\"\n    redirect_url             = \"string\"\n    lambda_error_reason      = \"string\"\n    new_field                = \"string\"\n  }\n}\n\nvariable \"cloudfront_app_access_logs_columns\" {\n  default = {\n    date               = \"date\"\n    time               = \"string\"\n    location           = \"string\"\n    bytes              = \"bigint\"\n    requestip          = \"string\"\n    method             = \"string\"\n    host               = \"string\"\n    uri                = \"string\"\n    status             = \"int\"\n    referrer           = \"string\"\n    useragent          = \"string\"\n    querystring        = \"string\"\n    cookie             = \"string\"\n    resulttype         = \"string\"\n    requestid          = \"string\"\n    hostheader         = \"string\"\n    requestprotocol    = \"string\"\n    requestbytes       = \"bigint\"\n    timetaken          = \"float\"\n    xforwardedfor      = \"string\"\n    sslprotocol        = \"string\"\n    sslcipher          = \"string\"\n    responseresulttype = \"string\"\n    httpversion        = \"string\"\n    filestatus         = \"string\"\n    encryptedfields    = \"int\"\n  }\n}\n\n\nvariable \"SNSEmailParam\" {\n  description = \"SNS notification value\"\n  type        = string\n  default     = \"\"\n}\n\nlocals {\n  SNSEmail = var.SNSEmailParam == \"\" ? \"no\" : \"yes\"\n}\n\n\n\nvariable \"ActivateHttpFloodProtectionParam\" {\n  type    = string\n  default = \"yes - AWS WAF rate based rule\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes - AWS Lambda log parser\", \"yes - Amazon Athena log parser\", \"yes - AWS WAF rate based rule\", \"no\"], var.ActivateHttpFloodProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes - AWS Lambda log parser\\\", \\\"yes - Amazon Athena log parser\\\",\\\"yes - AWS WAF rate based rule\\\", \\\"no\\\".\"\n  }\n}\n\nlocals {\n  HttpFloodProtectionRateBasedRuleActivated = var.ActivateHttpFloodProtectionParam == \"yes - AWS WAF rate based rule\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  HttpFloodAthenaLogParser = var.ActivateHttpFloodProtectionParam == \"yes - Amazon Athena log parser\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  HttpFloodLambdaLogParser = var.ActivateHttpFloodProtectionParam == \"yes - AWS Lambda log parser\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  HttpFloodProtectionLogParserActivated = var.ActivateHttpFloodProtectionParam == \"yes - AWS Lambda log parser\" || var.ActivateHttpFloodProtectionParam == \"yes - Amazon Athena log parser\" ? \"yes\" : \"no\"\n}\n\nvariable \"ActivateAWSManagedRulesParam\" {\n  type    = string\n  default = \"no\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ActivateAWSManagedRulesParam)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ActivateSqlInjectionProtectionParam\" {\n  type    = string\n  default = \"yes\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ActivateSqlInjectionProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ActivateCrossSiteScriptingProtectionParam\" {\n  type    = string\n  default = \"yes\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ActivateCrossSiteScriptingProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ActivateReputationListsProtectionParam\" {\n  type    = string\n  default = \"yes\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ActivateReputationListsProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ActivateBadBotProtectionParam\" {\n  type    = string\n  default = \"yes\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ActivateBadBotProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ActivateScannersProbesProtectionParam\" {\n  type    = string\n  default = \"\"\n\n  # using contains()\n  validation {\n    condition     = contains([\"yes - AWS Lambda log parser\", \"yes - Amazon Athena log parser\", \"no\"], var.ActivateScannersProbesProtectionParam)\n    error_message = \"Invalid input, options: \\\"yes - AWS Lambda log parser\\\", \\\"yes - Amazon Athena log parser\\\",\\\"no\\\".\"\n  }\n}\n\nlocals {\n  ScannersProbesAthenaLogParser = var.ActivateScannersProbesProtectionParam == \"yes - Amazon Athena log parser\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  ScannersProbesLambdaLogParser = var.ActivateScannersProbesProtectionParam == \"yes - AWS Lambda log parser\" ? \"yes\" : \"no\"\n}\n\nvariable \"ScannersProbesProtectionActivated\" {\n  type        = string\n  default     = \"yes\"\n  description = \"\"\n}\n\nlocals {\n  AthenaLogParser = var.ActivateHttpFloodProtectionParam == \"yes - Amazon Athena log parser\" && var.ActivateScannersProbesProtectionParam == \"yes - Amazon Athena log parser\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  LogParser = var.ActivateHttpFloodProtectionParam != \"\" && var.ActivateScannersProbesProtectionParam != \"\" ? \"yes\" : \"no\"\n}\n\nvariable \"BadBotProtectionActivated\" {\n  type        = string\n  default     = \"yes\"\n  description = \"\"\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.BadBotProtectionActivated)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"ReputationListsProtectionActivated\" {\n  type        = string\n  default     = \"yes\"\n  description = \"\"\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.ReputationListsProtectionActivated)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nvariable \"IPRetentionPeriod\" {\n  type        = string\n  default     = \"no\"\n  description = \"\"\n  validation {\n    condition     = contains([\"yes\", \"no\"], var.IPRetentionPeriod)\n    error_message = \"Invalid input, options: \\\"yes\\\",\\\"no\\\".\"\n  }\n}\n\nlocals {\n  CustomResourceLambdaAccess = var.ReputationListsProtectionActivated == \"yes\" || local.AthenaLogParser == \"yes\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  ALBScannersProbesAthenaLogParser = var.ActivateScannersProbesProtectionParam == \"yes - Amazon Athena log parser\" && var.ENDPOINT == \"ALB\" ? \"yes\" : \"no\"\n}\n\nlocals {\n  CloudFrontScannersProbesAthenaLogParser = var.ActivateScannersProbesProtectionParam == \"yes - Amazon Athena log parser\" && var.ENDPOINT == \"cloudfront\" ? \"yes\" : \"no\"\n}\n\n"
      },
      "has_app": true
    },
    "91934f8c031ad7ae": {
      "hash": "91934f8c031ad7ae",
      "source_url": "https://github.com/aws-samples/aws-security-services-with-terraform",
      "source_type": "github",
      "discovered_at": "2026-01-11T21:33:43.524092",
      "services": [
        "sns",
        "cloudwatch",
        "opensearch",
        "kinesis",
        "firehose",
        "lambda",
        "kms",
        "config",
        "s3",
        "ec2",
        "iam"
      ],
      "resource_count": 116,
      "name": "aws-security-services-with-terraform",
      "description": "Code examples for the AWS Security Blog post: How to use CI/CD to deploy and configure AWS security services with Terraform",
      "version": null,
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "provider.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n## Specifies the Region your Terraform Provider will server\nprovider \"aws\" {\n  region = \"us-east-1\"\n}\n## Specifies the S3 Bucket and DynamoDB table used for the durable backend and state locking\n\nterraform {\n    backend \"s3\" {\n      encrypt = true\n      bucket = \"my_s3_bucket_name\"\n      dynamodb_table = \"my_dynamo_table_name\"\n      key = \"path/path/terraform.tfstate\"\n      region = \"us-east-1\"\n  }\n}",
        "variables.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n#################################\n## waf-conditions.tf Variables ##\n#################################\nvariable \"AWS_Security_Blog_Blacklist_IPSet_Name\" {\n  default = \"devsecopsblacklistipset\"\n}\nvariable \"AWS_Security_Blog_SQLI_Match_Set_Name\" {\n  default = \"devsecopssqlimatchset\"\n}\n\n############################\n## waf-rules.tf Variables ##\n############################\nvariable \"AWS_Security_Blog_IP_Blacklist_Rule_Name\" {\n  default = \"devsecopsblacklistrule\"\n}\nvariable \"AWS_Security_Blog_SQL_Injection_Rule_Name\" {\n  default = \"devsecopssqlirule\"\n}\nvariable \"AWS_Security_Blog_Blacklist_WACL_Name\" {\n  default = \"devsecopswebacl\"\n}",
        "waf-conditions.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n## Creates a WAF IP Set to be used as a Blacklist for a WAF Rule to add to the Web ACL\n## Value can be replaced with a Variable or a Static Value of an EIP within the customer VPC\n## to test functionality of the WAF blocking access via IP\nresource \"aws_waf_ipset\" \"AWS_Security_Blog_Blacklist_IPSet\" {\n  name = \"${var.AWS_Security_Blog_Blacklist_IPSet_Name}\"\n  ip_set_descriptors {\n    type  = \"IPV4\"\n    value = \"10.0.0.99/32\"\n  }\n}\n## Creates SQL Injection match condition with multiple filters based on AWS best practices\n## reccomendations from the Mitigated OWASP Top 10 with AWS WAF White Paper\nresource \"aws_waf_sql_injection_match_set\" \"AWS_Security_Blog_SQLI_Match_Set\" {\n  name = \"${var.AWS_Security_Blog_SQLI_Match_Set_Name}\"\n  sql_injection_match_tuples {\n    text_transformation = \"HTML_ENTITY_DECODE\"\n    field_to_match {\n      type = \"QUERY_STRING\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"URL_DECODE\"\n    field_to_match {\n      type = \"QUERY_STRING\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"HTML_ENTITY_DECODE\"\n    field_to_match {\n      type = \"URI\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"URL_DECODE\"\n    field_to_match {\n      type = \"URI\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"HTML_ENTITY_DECODE\"\n    field_to_match {\n      type = \"BODY\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"URL_DECODE\"\n    field_to_match {\n      type = \"BODY\"\n    }\n  }  \n  sql_injection_match_tuples {\n    text_transformation = \"HTML_ENTITY_DECODE\"\n    field_to_match {\n      type = \"HEADER\"\n      data = \"Cookie\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"URL_DECODE\"\n    field_to_match {\n      type = \"HEADER\"\n      data = \"Cookie\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"HTML_ENTITY_DECODE\"\n    field_to_match {\n      type = \"HEADER\"\n      data = \"Authorization\"\n    }\n  }\n  sql_injection_match_tuples {\n    text_transformation = \"URL_DECODE\"\n    field_to_match {\n      type = \"HEADER\"\n      data = \"Authorization\"\n    }\n  }\n}",
        "waf-rules.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n\n## Creates an AWS WAF Rule to Blacklist the IP Address specified in the IPSet Condition\nresource \"aws_waf_rule\" \"AWS_Security_Blog_IP_Blacklist_Rule\" {\n  name        = \"${var.AWS_Security_Blog_IP_Blacklist_Rule_Name}\"\n  metric_name = \"${var.AWS_Security_Blog_IP_Blacklist_Rule_Name}\"\n  predicates {\n    data_id = \"${aws_waf_ipset.AWS_Security_Blog_Blacklist_IPSet.id}\"\n    negated = false\n    type    = \"IPMatch\"\n  }\n}\n## Creates an AWS WAF Rule matched against Conditions listed in the SQL Injection Condition Match Set\nresource \"aws_waf_rule\" \"AWS_Security_Blog_SQL_Injection_Rule\" {\n  name        = \"${var.AWS_Security_Blog_SQL_Injection_Rule_Name}\"\n  metric_name = \"${var.AWS_Security_Blog_SQL_Injection_Rule_Name}\"\n  predicates{\n    data_id = \"${aws_waf_sql_injection_match_set.AWS_Security_Blog_SQLI_Match_Set.id}\"\n    negated = false\n    type = \"SqlInjectionMatch\"\n  }\n}\n## Creates an AWS WAF Web ACL that will Block traffic originiating from the Blacklist, as well as block traffic\n## that matches any SQL Injection methods. Logs are sent to a Kinesis Data Firehose for further processing and investigation\nresource \"aws_waf_web_acl\" \"AWS_Security_Blog_Blacklist_WACL\" {\n  name        = \"${var.AWS_Security_Blog_Blacklist_WACL_Name}\"\n  metric_name = \"${var.AWS_Security_Blog_Blacklist_WACL_Name}\"\n  default_action {\n    type = \"ALLOW\"\n  }\n  rules {\n    action {\n      type = \"BLOCK\"\n    }\n    priority = 1\n    rule_id  = \"${aws_waf_rule.AWS_Security_Blog_SQL_Injection_Rule.id}\"\n    type     = \"REGULAR\"\n  }\n  rules {\n    action {\n      type = \"BLOCK\"\n    }\n    priority = 2\n    rule_id  = \"${aws_waf_rule.AWS_Security_Blog_IP_Blacklist_Rule.id}\"\n    type     = \"REGULAR\"\n  }\n}",
        "aws-security-hub-boostrap-and-operationalization/cis_3-x.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# SNS topic to receive CIS 3.x alerts\n# You will need to subscribe via email manually as this is unsupported by terraform\nresource \"aws_sns_topic\" \"CIS_Alerts_SNS_Topic\" {\n  name_prefix = \"${var.CIS_SNS_Prefix}\"\n}\n## These next resources are the CloudWatch Log Metric Filter & associated Alarms to be in compliance with CIS Benchmarks\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Unauthorized_API_Calls_Metric_Filter\" {\n  name           = \"CIS-UnauthorizedAPICalls\"\n  pattern        = \"{ ($.errorCode = \\\"*UnauthorizedOperation\\\") || ($.errorCode = \\\"AccessDenied*\\\") }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-UnauthorizedAPICalls\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Unauthorized_API_Calls_CW_Alarm\" {\n  alarm_name                = \"CIS-3.1-UnauthorizedAPICalls\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Unauthorized_API_Calls_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring unauthorized API calls will help reveal application errors and may reduce time to detect malicious activity.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_No_MFA_Console_Signin_Metric_Filter\" {\n  name           = \"CIS-ConsoleSigninWithoutMFA\"\n  pattern        = \"{ ($.eventName = \\\"ConsoleLogin\\\") && ($.additionalEventData.MFAUsed != \\\"Yes\\\") }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-ConsoleSigninWithoutMFA\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_No_MFA_Console_Signin_CW_Alarm\" {\n  alarm_name                = \"CIS-3.2-ConsoleSigninWithoutMFA\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_No_MFA_Console_Signin_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring for single-factor console logins will increase visibility into accounts that are not protected by MFA.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\n\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Root_Account_Use_Metric_Filter\" {\n  name           = \"CIS-RootAccountUsage\"\n  pattern        = \"{ $.userIdentity.type = \\\"Root\\\" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != \\\"AwsServiceEvent\\\" }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-RootAccountUsage\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\n\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Root_Account_Use_CW_Alarm\" {\n  alarm_name                = \"CIS-3.3-RootAccountUsage\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Root_Account_Use_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring for root account logins will provide visibility into the use of a fully privileged account and an opportunity to reduce the use of it.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_IAM_Policy_Change_Metric_Filter\" {\n  name           = \"CIS-IAMPolicyChanges\"\n  pattern        = \"{($.eventName=DeleteGroupPolicy)||($.eventName=DeleteRolePolicy)||($.eventName=DeleteUserPolicy)||($.eventName=PutGroupPolicy)||($.eventName=PutRolePolicy)||($.eventName=PutUserPolicy)||($.eventName=CreatePolicy)||($.eventName=DeletePolicy)||($.eventName=CreatePolicyVersion)||($.eventName=DeletePolicyVersion)||($.eventName=AttachRolePolicy)||($.eventName=DetachRolePolicy)||($.eventName=AttachUserPolicy)||($.eventName=DetachUserPolicy)||($.eventName=AttachGroupPolicy)||($.eventName=DetachGroupPolicy)}\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-IAMPolicyChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_IAM_Policy_Change_CW_Alarm\" {\n  alarm_name                = \"CIS-3.4-IAMPolicyChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_IAM_Policy_Change_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to IAM policies will help ensure authentication and authorization controls remain intact.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_CloudTrail_Config_Change_Metric_Filter\" {\n  name           = \"CIS-CloudTrailChanges\"\n  pattern        = \"{ ($.eventName = CreateTrail) || ($.eventName = UpdateTrail) || ($.eventName = DeleteTrail) || ($.eventName = StartLogging) || ($.eventName = StopLogging) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-CloudTrailChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_CloudTrail_Config_Change_CW_Alarm\" {\n  alarm_name                = \"CIS-3.5-CloudTrailChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_CloudTrail_Config_Change_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to CloudTrail's configuration will help ensure sustained visibility to activities performed in the AWS account.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Console_AuthN_Failure_Metric_Filter\" {\n  name           = \"CIS-ConsoleAuthenticationFailure\"\n  pattern        = \"{ ($.eventName = ConsoleLogin) && ($.errorMessage = \\\"Failed authentication\\\") }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-ConsoleAuthenticationFailure\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Console_AuthN_Failure_CW_Alarm\" {\n  alarm_name                = \"CIS-3.6-ConsoleAuthenticationFailure\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Console_AuthN_Failure_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring failed console logins may decrease lead time to detect an attempt to brute force a credential, which may provide an indicator, such as source IP, that can be used in other event correlation.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Disable_Or_Delete_CMK_Metric_Filter\" {\n  name           = \"CIS-DisableOrDeleteCMK\"\n  pattern        = \"{ ($.eventSource = kms.amazonaws.com) && (($.eventName = DisableKey) || ($.eventName = ScheduleKeyDeletion)) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-DisableOrDeleteCMK\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Disable_Or_Delete_CMK_CW_Alarm\" {\n  alarm_name                = \"CIS-3.7-DisableOrDeleteCMK\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Disable_Or_Delete_CMK_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring failed console logins may decrease lead time to detect an attempt to brute force a credential, which may provide an indicator, such as source IP, that can be used in other event correlation.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_S3_Bucket_Policy_Change_Metric_Filter\" {\n  name           = \"CIS-S3BucketPolicyChanges\"\n  pattern        = \"{ ($.eventSource = s3.amazonaws.com) && (($.eventName = PutBucketAcl) || ($.eventName = PutBucketPolicy) || ($.eventName = PutBucketCors) || ($.eventName = PutBucketLifecycle) || ($.eventName = PutBucketReplication) || ($.eventName = DeleteBucketPolicy) || ($.eventName = DeleteBucketCors) || ($.eventName = DeleteBucketLifecycle) || ($.eventName = DeleteBucketReplication)) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-S3BucketPolicyChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_S3_Bucket_Policy_Change_CW_Alarm\" {\n  alarm_name                = \"CIS-3.8-S3BucketPolicyChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_S3_Bucket_Policy_Change_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to S3 bucket policies may reduce time to detect and correct permissive policies on sensitive S3 buckets.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_AWS_Config_Change_Metric_Filter\" {\n  name           = \"CIS-AWSConfigChanges\"\n  pattern        = \"{ ($.eventSource = config.amazonaws.com) && (($.eventName=StopConfigurationRecorder)||($.eventName=DeleteDeliveryChannel)||($.eventName=PutDeliveryChannel)||($.eventName=PutConfigurationRecorder)) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-AWSConfigChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_AWS_Config_Change_CW_Alarm\" {\n  alarm_name                = \"CIS-3.9-AWSConfigChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_AWS_Config_Change_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to AWS Config configuration will help ensure sustained visibility of configuration items within the AWS account.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Security_Group_Changes_Metric_Filter\" {\n  name           = \"CIS-SecurityGroupChanges\"\n  pattern        = \"{ ($.eventName = AuthorizeSecurityGroupIngress) || ($.eventName = AuthorizeSecurityGroupEgress) || ($.eventName = RevokeSecurityGroupIngress) || ($.eventName = RevokeSecurityGroupEgress) || ($.eventName = CreateSecurityGroup) || ($.eventName = DeleteSecurityGroup)}\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-SecurityGroupChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Security_Group_Changes_CW_Alarm\" {\n  alarm_name                = \"CIS-3.10-SecurityGroupChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Security_Group_Changes_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to security group will help ensure that resources and services are not unintentionally exposed.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Network_ACL_Changes_Metric_Filter\" {\n  name           = \"CIS-NetworkACLChanges\"\n  pattern        = \"{ ($.eventName = CreateNetworkAcl) || ($.eventName = CreateNetworkAclEntry) || ($.eventName = DeleteNetworkAcl) || ($.eventName = DeleteNetworkAclEntry) || ($.eventName = ReplaceNetworkAclEntry) || ($.eventName = ReplaceNetworkAclAssociation) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-NetworkACLChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Network_ACL_Changes_CW_Alarm\" {\n  alarm_name                = \"CIS-3.11-NetworkACLChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Network_ACL_Changes_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to NACLs will help ensure that AWS resources and services are not unintentionally exposed.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Network_Gateway_Changes_Metric_Filter\" {\n  name           = \"CIS-NetworkGatewayChanges\"\n  pattern        = \"{ ($.eventName = CreateCustomerGateway) || ($.eventName = DeleteCustomerGateway) || ($.eventName = AttachInternetGateway) || ($.eventName = CreateInternetGateway) || ($.eventName = DeleteInternetGateway) || ($.eventName = DetachInternetGateway) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-NetworkGatewayChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Network_Gateway_Changes_CW_Alarm\" {\n  alarm_name                = \"CIS-3.12-NetworkGatewayChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Network_Gateway_Changes_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to network gateways will help ensure that all ingress/egress traffic traverses the VPC border via a controlled path.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_Route_Table_Changes_Metric_Filter\" {\n  name           = \"CIS-RouteTableChanges\"\n  pattern        = \"{ ($.eventName = CreateRoute) || ($.eventName = CreateRouteTable) || ($.eventName = ReplaceRoute) || ($.eventName = ReplaceRouteTableAssociation) || ($.eventName = DeleteRouteTable) || ($.eventName = DeleteRoute) || ($.eventName = DisassociateRouteTable) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-RouteTableChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_Route_Table_Changes_CW_Alarm\" {\n  alarm_name                = \"CIS-3.13-RouteTableChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_Route_Table_Changes_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to route tables will help ensure that all VPC traffic flows through an expected path.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\nresource \"aws_cloudwatch_log_metric_filter\" \"CIS_VPC_Changes_Metric_Filter\" {\n  name           = \"CIS-VPCChanges\"\n  pattern        = \"{ ($.eventName = CreateVpc) || ($.eventName = DeleteVpc) || ($.eventName = ModifyVpcAttribute) || ($.eventName = AcceptVpcPeeringConnection) || ($.eventName = CreateVpcPeeringConnection) || ($.eventName = DeleteVpcPeeringConnection) || ($.eventName = RejectVpcPeeringConnection) || ($.eventName = AttachClassicLinkVpc) || ($.eventName = DetachClassicLinkVpc) || ($.eventName = DisableVpcClassicLink) || ($.eventName = EnableVpcClassicLink) }\"\n  log_group_name = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n\n  metric_transformation {\n    name      = \"CIS-VPCChanges\"\n    namespace = \"${var.CIS_Metric_Alarm_Namespace}\"\n    value     = \"1\"\n  }\n}\nresource \"aws_cloudwatch_metric_alarm\" \"CIS_VPC_Changes_CW_Alarm\" {\n  alarm_name                = \"CIS-3.14-VPCChanges\"\n  comparison_operator       = \"GreaterThanOrEqualToThreshold\"\n  evaluation_periods        = \"1\"\n  metric_name               = \"${aws_cloudwatch_log_metric_filter.CIS_VPC_Changes_Metric_Filter.id}\"\n  namespace                 = \"${var.CIS_Metric_Alarm_Namespace}\"\n  period                    = \"300\"\n  statistic                 = \"Sum\"\n  threshold                 = \"1\"\n  alarm_description         = \"Monitoring changes to VPC will help ensure that all VPC traffic flows through an expected path.\"\n  alarm_actions             = [\"${aws_sns_topic.CIS_Alerts_SNS_Topic.arn}\"]\n  insufficient_data_actions = []\n}\n",
        "aws-security-hub-boostrap-and-operationalization/cis_baseline_infrastructure.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# create KMS key with default cloudtrail policy\nresource \"aws_kms_key\" \"Cloudtrail_KMS_CMK\" {\n  description             = \"For CloudTrail - Managed by Terraform\"\n  deletion_window_in_days = 7\n  is_enabled              = true\n  enable_key_rotation     = true\n  policy                  = <<POLICY\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"Key policy created by CloudTrail\",\n    \"Statement\": [\n        {\n            \"Sid\": \"Enable IAM User Permissions\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": [\n                \"arn:aws:iam::${data.aws_caller_identity.current.account_id}:root\"\n            ]},\n            \"Action\": \"kms:*\",\n            \"Resource\": \"*\"\n        },\n        {\n            \"Sid\": \"Allow CloudTrail to encrypt logs\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"Service\": [\"cloudtrail.amazonaws.com\"]},\n            \"Action\": \"kms:GenerateDataKey*\",\n            \"Resource\": \"*\",\n            \"Condition\": {\"StringLike\": {\"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:${data.aws_caller_identity.current.account_id}:trail/*\"}}\n        },\n        {\n            \"Sid\": \"Allow CloudTrail to describe key\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"Service\": [\"cloudtrail.amazonaws.com\"]},\n            \"Action\": \"kms:DescribeKey\",\n            \"Resource\": \"*\"\n        },\n        {\n            \"Sid\": \"Allow principals in the account to decrypt log files\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": \"*\"},\n            \"Action\": [\n                \"kms:Decrypt\",\n                \"kms:ReEncryptFrom\"\n            ],\n            \"Resource\": \"*\",\n            \"Condition\": {\n                \"StringEquals\": {\"kms:CallerAccount\": \"${data.aws_caller_identity.current.account_id}\"},\n                \"StringLike\": {\"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:${data.aws_caller_identity.current.account_id}:trail/*\"}\n            }\n        },\n        {\n            \"Sid\": \"Allow alias creation during setup\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": \"*\"},\n            \"Action\": \"kms:CreateAlias\",\n            \"Resource\": \"*\",\n            \"Condition\": {\"StringEquals\": {\n                \"kms:ViaService\": \"ec2.${var.AWS_REGION}.amazonaws.com\",\n                \"kms:CallerAccount\": \"${data.aws_caller_identity.current.account_id}\"\n            }}\n        },\n        {\n            \"Sid\": \"Enable cross account log decryption\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": \"*\"},\n            \"Action\": [\n                \"kms:Decrypt\",\n                \"kms:ReEncryptFrom\"\n            ],\n            \"Resource\": \"*\",\n            \"Condition\": {\n                \"StringEquals\": {\"kms:CallerAccount\": \"${data.aws_caller_identity.current.account_id}\"},\n                \"StringLike\": {\"kms:EncryptionContext:aws:cloudtrail:arn\": \"arn:aws:cloudtrail:*:${data.aws_caller_identity.current.account_id}:trail/*\"}\n            }\n        }\n    ]\n}\nPOLICY\n}\n# Create IAM Password Policy in accordance with CIS 1.5 - 1.11 controls\nresource \"aws_iam_account_password_policy\" \"CIS_Password_Policy\" {\n  minimum_password_length        = 15\n  require_lowercase_characters   = true\n  require_numbers                = true\n  require_uppercase_characters   = true\n  require_symbols                = true\n  allow_users_to_change_password = true\n  max_password_age               = 90\n  password_reuse_prevention      = 24\n}\n# Create S3 Bucket for Access logging\nresource \"aws_s3_bucket\" \"Server_Access_Log_S3_Bucket\" {\n  bucket_prefix = \"${var.AccessLog_Bucket_Prefix}\"\n  acl    = \"log-delivery-write\"\n  versioning {\n      enabled = true\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm     = \"AES256\"\n      }\n    }\n  }\n}\n# create cloudwatch log group for cloudtrail to write to, will be used by 3.x cloudwatch metrics & filters\nresource \"aws_cloudwatch_log_group\" \"CIS_CloudWatch_LogsGroup\" {\n  name = \"${var.CIS_CloudTrail_Trail_Name}-log-group\"\n}\n# create IAM role and policy to allow cloudtrail to write logs to cloudwatch\nresource \"aws_iam_role\" \"CloudWatch_LogsGroup_IAM_Role\" {\n  name = \"${var.CIS_CloudTrail_Trail_Name}-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"cloudtrail.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"CIS_CloudWatch_LogsGroup_Policy\" {\n  name   = \"${var.CIS_CloudTrail_Trail_Name}-policy\"\n  role   = \"${aws_iam_role.CloudWatch_LogsGroup_IAM_Role.id}\"\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"logs:CreateLogGroup\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\",\n        \"logs:DescribeLogGroups\",\n        \"logs:DescribeLogStreams\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.arn}*\"\n    }\n  ]\n}\nEOF\n}\n# create a CloudTrail trail that is compliant with CIS controls (2.1, 2.2, 2.4)\nresource \"aws_cloudtrail\" \"CIS_CloudTrail_Trail\" { \n  name                          = \"${var.CIS_CloudTrail_Trail_Name}\" \n  s3_bucket_name                = \"${aws_s3_bucket.CIS_CloudTrail_Logs_S3_Bucket.id}\"\n  include_global_service_events = true\n  is_multi_region_trail         = true\n  enable_log_file_validation    = true\n  kms_key_id                    = \"${aws_kms_key.Cloudtrail_KMS_CMK.arn}\"\n  cloud_watch_logs_group_arn    = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.arn}\"\n  cloud_watch_logs_role_arn     = \"${aws_iam_role.CloudWatch_LogsGroup_IAM_Role.arn}\"\n  depends_on                    = [\"aws_s3_bucket_policy.CloudTrail_Bucket_Policy\"]\n  event_selector {\n    read_write_type           = \"All\"\n    include_management_events = true\n  }\n}\n# create bucket and bucket policy for CloudTrail logs, compliant with CIS controls (2.3, 2.6)\nresource \"aws_s3_bucket\" \"CIS_CloudTrail_Logs_S3_Bucket\" {  \n  bucket_prefix = \"${var.CloudTrail_Bucket_Prefix}\" \n  acl           = \"private\"\n  versioning {\n      enabled = true\n  }\n  logging {\n    target_bucket = \"${aws_s3_bucket.Server_Access_Log_S3_Bucket.id}\"\n    target_prefix = \"cloudtrailaccess/\"\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm     = \"AES256\"\n      }\n    }\n  }\n}\nresource \"aws_s3_bucket_policy\" \"CloudTrail_Bucket_Policy\" {\n  bucket = \"${aws_s3_bucket.CIS_CloudTrail_Logs_S3_Bucket.id}\"\n  policy = <<POLICY\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"AWSCloudTrailAclCheck20150319\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"Service\": \"cloudtrail.amazonaws.com\"},\n            \"Action\": \"s3:GetBucketAcl\",\n            \"Resource\": \"${aws_s3_bucket.CIS_CloudTrail_Logs_S3_Bucket.arn}\"\n        },\n        {\n            \"Sid\": \"AWSCloudTrailWrite20150319\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"Service\": \"cloudtrail.amazonaws.com\"},\n            \"Action\": \"s3:PutObject\",\n            \"Resource\": \"${aws_s3_bucket.CIS_CloudTrail_Logs_S3_Bucket.arn}/*\",\n            \"Condition\": {\"StringEquals\": {\"s3:x-amz-acl\": \"bucket-owner-full-control\"}}\n        }\n    ]\n}\nPOLICY\n}\n# Creates a reference VPC with private and public subnets\nresource \"aws_vpc\" \"CIS_VPC\" {\n  cidr_block           = \"${var.CIS_VPC_CIDR}\"\n  enable_dns_support   = true\n  enable_dns_hostnames = true\n  tags {\n      Name = \"${var.CIS_VPC_Name_Tag}\"\n  }\n}\n# create subnets\nresource \"aws_subnet\" \"CIS_Public_Subnets\" {\n  count                   = \"${var.Network_Resource_Count}\"\n  vpc_id                  = \"${aws_vpc.CIS_VPC.id}\"\n  cidr_block              = \"${cidrsubnet(aws_vpc.CIS_VPC.cidr_block, 8, var.Network_Resource_Count + count.index)}\"\n  availability_zone       = \"${data.aws_availability_zones.Available_AZ.names[count.index]}\"\n  map_public_ip_on_launch = true\n  tags {\n    Name = \"${var.CIS_VPC_Name_Tag}-PUB-Subnet-${element(data.aws_availability_zones.Available_AZ.names, count.index)}\"\n  }\n}\nresource \"aws_subnet\" \"CIS_Private_Subnets\" {\n  count             = \"${var.Network_Resource_Count}\"\n  vpc_id            = \"${aws_vpc.CIS_VPC.id}\"\n  cidr_block        = \"${cidrsubnet(aws_vpc.CIS_VPC.cidr_block, 8, count.index)}\"\n  availability_zone = \"${data.aws_availability_zones.Available_AZ.names[count.index]}\"\n  tags {\n    Name = \"${var.CIS_VPC_Name_Tag}-PRIV-Subnet-${element(data.aws_availability_zones.Available_AZ.names, count.index)}\"\n  }\n}\n# attach IGW\nresource \"aws_internet_gateway\" \"CIS_IGW\" {\n  vpc_id = \"${aws_vpc.CIS_VPC.id}\"\n  tags {\n      Name = \"${var.CIS_VPC_Name_Tag}-IGW\"\n  }\n}\n# create route tables, route table associations and nat gateway\nresource \"aws_route_table\" \"CIS_Public_RTB\" {\n  count  = \"${var.Network_Resource_Count}\"\n  vpc_id = \"${aws_vpc.CIS_VPC.id}\"\n  route {\n      cidr_block = \"0.0.0.0/0\"\n      gateway_id = \"${aws_internet_gateway.CIS_IGW.id}\"\n  }\n  tags {\n    Name = \"PUB-RTB-${element(aws_subnet.CIS_Public_Subnets.*.id, count.index)}\"\n  }\n}\nresource \"aws_eip\" \"NATGW_Elastic_IPs\" {\n  count      = \"${var.Network_Resource_Count}\"\n  vpc        = true\n  depends_on = [\"aws_internet_gateway.CIS_IGW\"]\n  tags {\n    Name = \"NAT-Gateway-EIP-${element(aws_subnet.CIS_Public_Subnets.*.id, count.index)}\"\n  }\n}\nresource \"aws_nat_gateway\" \"CIS_NAT_Gateway\" {\n  count         = \"${var.Network_Resource_Count}\"\n  subnet_id     = \"${element(aws_subnet.CIS_Public_Subnets.*.id, count.index)}\"\n  allocation_id = \"${element(aws_eip.NATGW_Elastic_IPs.*.id, count.index)}\"\n  tags {\n    Name = \"NAT-Gateway-${element(aws_subnet.CIS_Public_Subnets.*.id, count.index)}\"\n  }\n}\nresource \"aws_route_table\" \"CIS_Private_RTB\" {\n  count  = \"${var.Network_Resource_Count}\"\n  vpc_id = \"${aws_vpc.CIS_VPC.id}\"\n  route {\n    cidr_block = \"0.0.0.0/0\"\n    nat_gateway_id = \"${element(aws_nat_gateway.CIS_NAT_Gateway.*.id, count.index)}\"\n  }\n  tags {\n    Name = \"PRIV-RTB-${element(aws_subnet.CIS_Private_Subnets.*.id, count.index)}\"\n  }\n}\nresource \"aws_route_table_association\" \"Public_Subnet_Association\" {\n  count          = \"${var.Network_Resource_Count}\"\n  subnet_id      = \"${element(aws_subnet.CIS_Public_Subnets.*.id, count.index)}\"\n  route_table_id = \"${element(aws_route_table.CIS_Public_RTB.*.id, count.index)}\"\n}\nresource \"aws_route_table_association\" \"Private_Subnet_Association\" {\n  count          = \"${var.Network_Resource_Count}\"\n  subnet_id      = \"${element(aws_subnet.CIS_Private_Subnets.*.id, count.index)}\"\n  route_table_id = \"${element(aws_route_table.CIS_Private_RTB.*.id, count.index)}\"\n}\n# enable flow logging for the vpc\nresource \"aws_flow_log\" \"CIS_VPC_Flow_Log\" {\n  iam_role_arn    = \"${aws_iam_role.CIS_FlowLogs_to_CWL_Role.arn}\"\n  log_destination = \"${aws_cloudwatch_log_group.CIS_FlowLogs_CWL_Group.arn}\"\n  traffic_type    = \"ALL\"\n  vpc_id          = \"${aws_vpc.CIS_VPC.id}\"\n}\nresource \"aws_cloudwatch_log_group\" \"CIS_FlowLogs_CWL_Group\" {\n  name = \"${var.CIS_VPC_Name_Tag}-flowlog-group\"\n}\n# create role & policy to allow VPC to send flow logs to cloudwatch\nresource \"aws_iam_role\" \"CIS_FlowLogs_to_CWL_Role\" {\n  name = \"${var.CIS_VPC_Name_Tag}-flowlog-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"vpc-flow-logs.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"CIS_FlowLogs_to_CWL_Role_Policy\" {\n  name = \"${var.CIS_VPC_Name_Tag}-flowlog-policy\"\n  role = \"${aws_iam_role.CIS_FlowLogs_to_CWL_Role.id}\"\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"logs:CreateLogGroup\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\",\n        \"logs:DescribeLogGroups\",\n        \"logs:DescribeLogStreams\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": \"${aws_cloudwatch_log_group.CIS_FlowLogs_CWL_Group.arn}*\"\n    }\n  ]\n}\nEOF\n}\n# remove rules from default SG\nresource \"aws_default_security_group\" \"Default_Security_Group\" {\n  vpc_id = \"${aws_vpc.CIS_VPC.id}\"\n  tags {\n    Name = \"DEFAULT_DO_NOT_USE\"\n  }\n}\nresource \"aws_security_group\" \"CIS_Linux_SG\" {\n  name        = \"cis-linux-sg\"\n  description = \"Allows 443 in and 22 from trusted IP ranges - Managed by Terraform\"\n  vpc_id      = \"${aws_vpc.CIS_VPC.id}\"\n  ingress {\n    from_port   = 22\n    to_port     = 22\n    protocol    = \"tcp\"\n    cidr_blocks = [\"${var.TRUSTED_IP}\"]\n  }\n  ingress {\n    from_port   = 443\n    to_port     = 443\n    protocol    = \"tcp\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n  egress {\n    from_port       = 0\n    to_port         = 0\n    protocol        = \"-1\"\n    cidr_blocks     = [\"0.0.0.0/0\"]\n  }\n  tags {\n      Name = \"${var.CIS_VPC_Name_Tag}-Linux-SG\"\n  }\n}",
        "aws-security-hub-boostrap-and-operationalization/config.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# Create Config Role\nresource \"aws_iam_role\" \"Config_IAM_Role\" {\n  name = \"Terraform-ConfigRole\"\n\n  assume_role_policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"config.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nPOLICY\n}\nresource \"aws_iam_role_policy_attachment\" \"Config_Role_Attach_Policy\" {\n  role       = \"${aws_iam_role.Config_IAM_Role.name}\"\n  policy_arn = \"arn:aws:iam::aws:policy/service-role/AWSConfigRole\"\n}\n# Create Config Recorder Bucket\nresource \"aws_s3_bucket\" \"Config_Recorder_Bucket\" {\n  bucket_prefix = \"${var.Config_Bucket_Prefix}\"\n  acl           = \"private\"\n  versioning {\n    enabled = true\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm     = \"AES256\"\n      }\n    }\n  }\n  lifecycle_rule {\n    enabled = true\n    expiration {\n      days = 365\n    }\n    noncurrent_version_expiration {\n      days = 365\n    }\n  }\n}\n# Default Config bucket access policy\nresource \"aws_s3_bucket_policy\" \"Config_Recorder_Bucket_Policy\" {\n  bucket = \"${aws_s3_bucket.Config_Recorder_Bucket.id}\"\n  policy = <<POLICY\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"Allow bucket ACL check\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": [\n         \"config.amazonaws.com\"\n        ]\n      },\n      \"Action\": \"s3:GetBucketAcl\",\n      \"Resource\": \"${aws_s3_bucket.Config_Recorder_Bucket.arn}\",\n      \"Condition\": {\n        \"Bool\": {\n          \"aws:SecureTransport\": \"true\"\n        }\n      }\n    },\n    {\n      \"Sid\": \"Allow bucket write\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": [\n         \"config.amazonaws.com\"\n        ]\n      },\n      \"Action\": \"s3:PutObject\",\n      \"Resource\": \"${aws_s3_bucket.Config_Recorder_Bucket.arn}/AWSLogs/${data.aws_caller_identity.current.account_id}/Config/*\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"s3:x-amz-acl\": \"bucket-owner-full-control\"\n        },\n        \"Bool\": {\n          \"aws:SecureTransport\": \"true\"\n        }\n      }\n    },\n    {\n      \"Sid\": \"Require SSL\",\n      \"Effect\": \"Deny\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"s3:*\",\n      \"Resource\": \"${aws_s3_bucket.Config_Recorder_Bucket.arn}/*\",\n      \"Condition\": {\n        \"Bool\": {\n          \"aws:SecureTransport\": \"false\"\n        }\n      }\n    }\n  ]\n}\nPOLICY\n}\n# Create & Enable Config Recorder\nresource \"aws_config_configuration_recorder\" \"Config_Recorder\" {\n  role_arn = \"${aws_iam_role.Config_IAM_Role.arn}\"\n  recording_group {\n    all_supported                 = true\n    include_global_resource_types = true\n  }\n}\nresource \"aws_config_delivery_channel\" \"Config_Delivery_Channel\" {\n  name           = \"config-example\"\n  s3_bucket_name = \"${aws_s3_bucket.Config_Recorder_Bucket.bucket}\"\n  snapshot_delivery_properties {\n    delivery_frequency = \"${var.Config_Delivery_Frequency}\"\n  }\n  depends_on = [\"aws_config_configuration_recorder.Config_Recorder\"]\n}\nresource \"aws_config_configuration_recorder_status\" \"Config_Recorder_Enabled\" {\n  name       = \"${aws_config_configuration_recorder.Config_Recorder.name}\"\n  is_enabled = true\n  depends_on = [\"aws_config_delivery_channel.Config_Delivery_Channel\"]\n}",
        "aws-security-hub-boostrap-and-operationalization/data.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# Account ID var\ndata \"aws_caller_identity\" \"current\" {}\n# Availability Zones var\ndata \"aws_availability_zones\" \"Available_AZ\" {\n  state = \"available\"\n}",
        "aws-security-hub-boostrap-and-operationalization/elasticsearch_siem_extension.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n###################\n# CLOUDTRAIL LOGS #\n###################\n# create an IAM role and policy that allows kinesis data firehose to interact with\n# elasticsearch and kinesis data streams\nresource \"aws_iam_role\" \"Cloudtrail_Firehose_Delivery_Role\" {\n  name = \"cloudtrail-firehose-siem-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"sts:ExternalId\":\"${data.aws_caller_identity.current.account_id}\"\n        }\n      }\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"Cloudtrail_Firehose_Delivery_Policy\" {\n  name   = \"cloudtrail-firehose-siem-policy\"\n  role   = \"${aws_iam_role.Cloudtrail_Firehose_Delivery_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",  \n    \"Statement\": [    \n        {      \n            \"Effect\": \"Allow\",      \n            \"Action\": [        \n                \"s3:AbortMultipartUpload\",        \n                \"s3:GetBucketLocation\",        \n                \"s3:GetObject\",        \n                \"s3:ListBucket\",        \n                \"s3:ListBucketMultipartUploads\",\n                \"s3:HeadBucket\",       \n                \"s3:PutObject\"\n            ],      \n            \"Resource\": [        \n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\",\n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}/*\"\t\t    \n            ]    \n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"kms:Decrypt\",\n               \"kms:GenerateDataKey\"\n           ],\n           \"Resource\": [\n               \"*\"           \n           ]\n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"es:DescribeElasticsearchDomain\",\n               \"es:DescribeElasticsearchDomains\",\n               \"es:DescribeElasticsearchDomainConfig\",\n               \"es:ESHttpPost\",\n               \"es:ESHttpPut\"\n           ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/*\"\n          ]\n       },\n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"es:ESHttpGet\"\n          ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_all/_settings\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_cluster/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_mapping/type-name\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/*/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_stats\"\n          ]\n       },        \n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"logs:PutLogEvents\",\n              \"logs:CreateLogStream\"\n          ],\n          \"Resource\": [\n              \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.arn}\"\n          ]\n       }\n    ]\n}\nEOF\n}\n# create kiensis data firehose delivery stream that will read from data stream and send findings to elasticsearch\nresource \"aws_kinesis_firehose_delivery_stream\" \"Cloudtrail_Logs_Firehose\" {\n  name        = \"${var.CloudTrail_To_Elastic_Name_Schema}-deliverystream\"\n  destination = \"elasticsearch\"\n  s3_configuration {\n    role_arn           = \"${aws_iam_role.Cloudtrail_Firehose_Delivery_Role.arn}\"\n    bucket_arn         = \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\"\n    prefix             = \"cloudtrail-fails\"\n    buffer_size        = 5\n    buffer_interval    = 60\n    compression_format = \"GZIP\"\n  }\n  elasticsearch_configuration {\n    domain_arn = \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\"\n    role_arn   = \"${aws_iam_role.Cloudtrail_Firehose_Delivery_Role.arn}\"\n    index_rotation_period = \"${var.ElasticSearch_Rotation_Period}\"\n    index_name = \"cloudtrail\"\n    type_name  = \"cloudtrail\" ## if you use 7.x elasticsearch version, do not specify this variable\n    cloudwatch_logging_options {\n        enabled         = true\n        log_group_name  = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n        log_stream_name = \"cloudtrail-fails\"\n    }\n  }\n}\n# create a cloudwatch log stream for KDF to log errors to\nresource \"aws_cloudwatch_log_stream\" \"Cloudtrail_Firehose_Errors_LogStream\" {\n  name           = \"cloudtrail-fails\"\n  log_group_name = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n  depends_on     = [\"aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup\"]\n}\n# create a cloudwatch subscription to send cloudtrail logs to lambda\nresource \"aws_cloudwatch_log_subscription_filter\" \"Cloudtrail_Logs_Lambda_Subscription\" {\n  name            = \"${var.CloudTrail_To_Elastic_Name_Schema}-subscription\"\n  log_group_name  = \"${aws_cloudwatch_log_group.CIS_CloudWatch_LogsGroup.name}\"\n  filter_pattern  = \"\" # leave blank for CT\n  destination_arn = \"${aws_lambda_function.Cloudtrail_Lambda_To_Firehose_Function.arn}\"\n}\n# create lambda function & execution role to send cloudtrail logs to kinesis data firehose\nresource \"aws_iam_role\" \"Cloudtrail_Lambda_To_Firehose_Role\" {\n  name = \"${var.CloudTrail_To_Elastic_Name_Schema}-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_policy\" \"Cloudtrail_Lambda_To_Firehose_Policy\" {\n  name = \"${var.CloudTrail_To_Elastic_Name_Schema}-policy\"\n  path = \"/\"\n  description = \"For ${var.CloudTrail_To_Elastic_Name_Schema} gives permission to cloudwatch and kinesis firehose - Managed by Terraform\"\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"logs:CreateLogGroup\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ],\n      \"Resource\": \"arn:aws:logs:*:*:*\",\n      \"Effect\": \"Allow\"\n    },\n    {\n      \"Action\": [\n        \"firehose:PutRecord\"\n      ],\n      \"Resource\": \"${aws_kinesis_firehose_delivery_stream.Cloudtrail_Logs_Firehose.arn}\",\n      \"Effect\": \"Allow\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy_attachment\" \"Cloudtrail_Lambda_To_Firehose_Policy_Attachment\" {\n  role = \"${aws_iam_role.Cloudtrail_Lambda_To_Firehose_Role.name}\"\n  policy_arn = \"${aws_iam_policy.Cloudtrail_Lambda_To_Firehose_Policy.arn}\"\n}\nresource \"aws_lambda_function\" \"Cloudtrail_Lambda_To_Firehose_Function\" {\n  filename      = \"./cloudwatch-to-firehose.zip\"\n  description   = \"Parses CloudTrail logs from CloudWatch Log Streams and send them to Kinesis Firehose en route to Elasticsearch Service - Managed by Terraform\"\n  function_name = \"${var.CloudTrail_To_Elastic_Name_Schema}-lambda-function\"\n  role          = \"${aws_iam_role.Cloudtrail_Lambda_To_Firehose_Role.arn}\"\n  handler       = \"lambda_function.lambda_handler\"\n  runtime       = \"python3.8\"\n  timeout       = 30\n  memory_size   = 384\n  environment {\n    variables = {\n      FIREHOSE_TARGET = \"${aws_kinesis_firehose_delivery_stream.Cloudtrail_Logs_Firehose.name}\"\n    }\n  }\n  depends_on   = [\"aws_iam_role_policy_attachment.Cloudtrail_Lambda_To_Firehose_Policy_Attachment\",\"aws_kinesis_firehose_delivery_stream.Cloudtrail_Logs_Firehose\"]\n}\n# give permissions for cloudwatch logs to invoke lambda\nresource \"aws_lambda_permission\" \"Cloudtrail_Logs_Lambda_Permission\" {\n  statement_id  = \"AllowExecutionFromCloudWatchLogs\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = \"${aws_lambda_function.Cloudtrail_Lambda_To_Firehose_Function.function_name}\"\n  principal     = \"logs.amazonaws.com\"\n}\n#################\n# VPC FLOW LOGS #\n#################\nresource \"aws_iam_role\" \"VPCFlowLogs_Firehose_Delivery_Role\" {\n  name = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-firehose-siem-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"sts:ExternalId\":\"${data.aws_caller_identity.current.account_id}\"\n        }\n      }\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"VPCFlowLogs_Firehose_Delivery_Policy\" {\n  name   = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-firehose-siem-policy\"\n  role   = \"${aws_iam_role.VPCFlowLogs_Firehose_Delivery_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",  \n    \"Statement\": [    \n        {      \n            \"Effect\": \"Allow\",      \n            \"Action\": [        \n                \"s3:AbortMultipartUpload\",        \n                \"s3:GetBucketLocation\",        \n                \"s3:GetObject\",        \n                \"s3:ListBucket\",        \n                \"s3:ListBucketMultipartUploads\",\n                \"s3:HeadBucket\",       \n                \"s3:PutObject\"\n            ],      \n            \"Resource\": [        \n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\",\n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}/*\"\t\t    \n            ]    \n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"kms:Decrypt\",\n               \"kms:GenerateDataKey\"\n           ],\n           \"Resource\": [\n               \"*\"           \n           ]\n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"es:DescribeElasticsearchDomain\",\n               \"es:DescribeElasticsearchDomains\",\n               \"es:DescribeElasticsearchDomainConfig\",\n               \"es:ESHttpPost\",\n               \"es:ESHttpPut\"\n           ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/*\"\n          ]\n       },\n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"es:ESHttpGet\"\n          ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_all/_settings\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_cluster/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_mapping/type-name\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/*/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_stats\"\n          ]\n       },        \n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"logs:PutLogEvents\",\n              \"logs:CreateLogStream\"\n          ],\n          \"Resource\": [\n              \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.arn}\"\n          ]\n       }\n    ]\n}\nEOF\n}\n# create kiensis data firehose delivery stream that will read from data stream and send findings to elasticsearch\nresource \"aws_kinesis_firehose_delivery_stream\" \"VPCFlowLogs_Logs_Firehose\" {\n  name        = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-deliverystream\"\n  destination = \"elasticsearch\"\n  s3_configuration {\n    role_arn           = \"${aws_iam_role.VPCFlowLogs_Firehose_Delivery_Role.arn}\"\n    bucket_arn         = \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\"\n    prefix             = \"vpcflowlogs-fails\"\n    buffer_size        = 5\n    buffer_interval    = 60\n    compression_format = \"GZIP\"\n  }\n  elasticsearch_configuration {\n    domain_arn = \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\"\n    role_arn   = \"${aws_iam_role.VPCFlowLogs_Firehose_Delivery_Role.arn}\"\n    index_rotation_period = \"${var.ElasticSearch_Rotation_Period}\"\n    index_name = \"vpcflowlogs\"\n    type_name  = \"vpcflowlogs\" ## if you use 7.x elasticsearch version, do not specify this variable\n    cloudwatch_logging_options {\n        enabled         = true\n        log_group_name  = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n        log_stream_name = \"vpcflowlogs-fails\"\n    }\n  }\n}\n# create a cloudwatch log stream for KDF to log errors to\nresource \"aws_cloudwatch_log_stream\" \"VPCFlowLogs_Firehose_Errors_LogStream\" {\n  name           = \"vpcflowlogs-fails\"\n  log_group_name = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n  depends_on     = [\"aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup\"]\n}\n# create a cloudwatch subscription to send cloudtrail logs to lambda\nresource \"aws_cloudwatch_log_subscription_filter\" \"VPCFlowLogs_Logs_Lambda_Subscription\" {\n  name            = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-subscription\"\n  log_group_name  = \"${aws_cloudwatch_log_group.CIS_FlowLogs_CWL_Group.name}\"\n  filter_pattern  = \"[version, account_id, interface_id, srcaddr != \\\"-\\\", dstaddr != \\\"-\\\", srcport != \\\"-\\\", dstport != \\\"-\\\", protocol, packets, bytes, start, end, action, log_status]\" # leave blank for CT\n  destination_arn = \"${aws_lambda_function.VPCFlowLogs_Lambda_To_Firehose_Function.arn}\"\n}\n# create lambda function & execution role to send cloudtrail logs to kinesis data firehose\nresource \"aws_iam_role\" \"VPCFlowLogs_Lambda_To_Firehose_Role\" {\n  name = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_policy\" \"VPCFlowLogs_Lambda_To_Firehose_Policy\" {\n  name = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-policy\"\n  path = \"/\"\n  description = \"For ${var.VPCFlowLogs_To_Elastic_Name_Schema} gives permission to cloudwatch and kinesis firehose - Managed by Terraform\"\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"logs:CreateLogGroup\",\n        \"logs:CreateLogStream\",\n        \"logs:PutLogEvents\"\n      ],\n      \"Resource\": \"arn:aws:logs:*:*:*\",\n      \"Effect\": \"Allow\"\n    },\n    {\n      \"Action\": [\n        \"firehose:PutRecord\"\n      ],\n      \"Resource\": \"${aws_kinesis_firehose_delivery_stream.VPCFlowLogs_Logs_Firehose.arn}\",\n      \"Effect\": \"Allow\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role_policy_attachment\" \"VPCFlowLogs_Lambda_To_Firehose_Policy_Attachment\" {\n  role = \"${aws_iam_role.VPCFlowLogs_Lambda_To_Firehose_Role.name}\"\n  policy_arn = \"${aws_iam_policy.VPCFlowLogs_Lambda_To_Firehose_Policy.arn}\"\n}\nresource \"aws_lambda_function\" \"VPCFlowLogs_Lambda_To_Firehose_Function\" {\n  filename      = \"./cloudwatch-to-firehose.zip\"\n  description   = \"Parses VPC Flow logs from CloudWatch Log Streams and send them to Kinesis Firehose en route to Elasticsearch Service - Managed by Terraform\"\n  function_name = \"${var.VPCFlowLogs_To_Elastic_Name_Schema}-lambda-function\"\n  role          = \"${aws_iam_role.VPCFlowLogs_Lambda_To_Firehose_Role.arn}\"\n  handler       = \"lambda_function.lambda_handler\"\n  runtime       = \"python3.8\"\n  timeout       = 30\n  memory_size   = 384\n  environment {\n    variables = {\n      FIREHOSE_TARGET = \"${aws_kinesis_firehose_delivery_stream.VPCFlowLogs_Logs_Firehose.name}\"\n    }\n  }\n  depends_on   = [\"aws_iam_role_policy_attachment.VPCFlowLogs_Lambda_To_Firehose_Policy_Attachment\",\"aws_kinesis_firehose_delivery_stream.VPCFlowLogs_Logs_Firehose\"]\n}\n# give permissions for cloudwatch logs to invoke lambda\nresource \"aws_lambda_permission\" \"VPCFlowLogs_Logs_Lambda_Permission\" {\n  statement_id  = \"AllowExecutionFromCloudWatchLogs\"\n  action        = \"lambda:InvokeFunction\"\n  function_name = \"${aws_lambda_function.VPCFlowLogs_Lambda_To_Firehose_Function.function_name}\"\n  principal     = \"logs.amazonaws.com\"\n}\n",
        "aws-security-hub-boostrap-and-operationalization/provider.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nprovider \"aws\" {\n  region     = \"${var.AWS_REGION}\"\n}",
        "aws-security-hub-boostrap-and-operationalization/security_hub_siem.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# Create ES Domain with Cognito user pool\n# Not all instances support encryption at rest & node-to-node encryption\nresource \"aws_elasticsearch_domain\" \"Security_Hub_Elasticsearch_Service\" {\n  domain_name           = \"${var.ElasticSearch_Domain_Name}\"\n  elasticsearch_version = \"${var.ElasticSearch_Domain_ES_Version}\"\n  cluster_config {\n    instance_type       = \"${var.ElasticSearch_Domain_Instance_Type}\"\n    instance_count      = \"${var.ElasticSearch_Domain_Instance_Count}\"    \n  }\n  ebs_options {\n      ebs_enabled  = true\n      volume_type  = \"gp2\"\n      volume_size  = \"15\"\n  }\n  encrypt_at_rest {\n      enabled = true\n  }\n  node_to_node_encryption {\n      enabled = true\n  }\n  snapshot_options {\n    automated_snapshot_start_hour = 23\n  }\n  cognito_options {\n      enabled          = true\n      user_pool_id     = \"${aws_cognito_user_pool.ES_Cognito_User_Pool.id}\"\n      identity_pool_id = \"${aws_cognito_identity_pool.ES_Cognito_Identity_Pool.id}\"\n      role_arn         = \"${aws_iam_role.ES_Cognito_Role.arn}\"\n  }\n  depends_on           = [\"aws_securityhub_account.Security_Hub_Enabled\"]\n}\n# this elasticsearch access policy will only allow your account and the IP your specify to access it\nresource \"aws_elasticsearch_domain_policy\" \"Security_Hub_Elasticsearch_Service_Policy\" {\n  domain_name = \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.domain_name}\"\n  access_policies = <<POLICIES\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"es:*\",\n      \"Resource\": \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/*\",\n      \"Condition\": {\n        \"IpAddress\": {\n          \"aws:SourceIp\": \"${var.TRUSTED_IP}\"\n        }\n      }\n    }\n  ]\n}\nPOLICIES\n}\n# Create cognito user pool with schema and password policy\nresource \"aws_cognito_user_pool\" \"ES_Cognito_User_Pool\" {\n  name                       = \"${var.ES_Cognito_User_Pool_Name}\"\n  email_verification_subject = \"${var.ElasticSearch_Domain_Name} Kibana Device Verification Code\"\n  email_verification_message = \"Please use the following code {####}\"\n  alias_attributes           = [\"email\", \"preferred_username\"]\n  auto_verified_attributes   = [\"email\"]\n  admin_create_user_config {\n    allow_admin_create_user_only = false\n  }\n  password_policy {\n      minimum_length    = 14\n      require_lowercase = true\n      require_numbers   = true\n      require_symbols   = true\n      require_uppercase = true\n  }\n  schema {\n    attribute_data_type      = \"String\"\n    developer_only_attribute = false\n    mutable                  = false\n    name                     = \"email\"\n    required                 = true\n    string_attribute_constraints {\n      min_length = 7\n      max_length = 64\n    }\n  }\n}\n# create user pool domain\nresource \"aws_cognito_user_pool_domain\" \"ES_Cognito_User_Pool_Domain\" {\n  domain       = \"${var.ES_Cognito_User_Pool_Domain_Name}\"\n  user_pool_id = \"${aws_cognito_user_pool.ES_Cognito_User_Pool.id}\"\n}\n# create identity pool for Cognito\nresource \"aws_cognito_identity_pool\" \"ES_Cognito_Identity_Pool\" {\n  identity_pool_name               = \"${var.ES_Cognito_Identity_Pool_Name}\"\n  allow_unauthenticated_identities = true # MUST BE TRUE FOR KIBANA TO USE THIS\n  lifecycle {\n    ignore_changes                 = [\"*\"]\n  }\n}\n# create unauth & auth IAM roles for Cognito\nresource \"aws_iam_role\" \"ES_Identity_Pool_Authenticated_Role\" {\n  name = \"${var.ES_Cognito_Identity_Pool_Name}-authenticated-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"cognito-identity.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"cognito-identity.amazonaws.com:aud\": \"${aws_cognito_identity_pool.ES_Cognito_Identity_Pool.id}\"\n        },\n        \"ForAnyValue:StringLike\": {\n          \"cognito-identity.amazonaws.com:amr\": \"authenticated\"\n        }\n      }\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"ES_Identity_Pool_Authenticated_Policy\" {\n  name = \"${var.ES_Cognito_Identity_Pool_Name}-authenticated-policy\"\n  role = \"${aws_iam_role.ES_Identity_Pool_Authenticated_Role.id}\"\n  policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"es:ESHttp*\",\n        \"mobileanalytics:PutEvents\",\n        \"cognito-sync:*\",\n        \"cognito-identity:*\"\n      ],\n      \"Resource\": [\n        \"*\"\n      ]\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role\" \"ES_Identity_Pool_Unauthenticated_Role\" {\n  name               = \"${var.ES_Cognito_Identity_Pool_Name}-unauthenticated-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"cognito-identity.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"cognito-identity.amazonaws.com:aud\": \"${aws_cognito_identity_pool.ES_Cognito_Identity_Pool.id}\"\n        },\n        \"ForAnyValue:StringLike\": {\n          \"cognito-identity.amazonaws.com:amr\": \"unauthenticated\"\n        }\n      }\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"ES_Identity_Pool_Unauthenticated_Policy\" {\n  name   = \"${var.ES_Cognito_Identity_Pool_Name}-unauthenticated-policy\"\n  role   = \"${aws_iam_role.ES_Identity_Pool_Unauthenticated_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"mobileanalytics:PutEvents\",\n                \"cognito-sync:*\"\n            ],\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\nEOF\n}\nresource \"aws_cognito_identity_pool_roles_attachment\" \"ES_ID_Pool_Role_Attachment\" {\n  identity_pool_id    = \"${aws_cognito_identity_pool.ES_Cognito_Identity_Pool.id}\"\n  roles = {\n    \"authenticated\"   = \"${aws_iam_role.ES_Identity_Pool_Authenticated_Role.arn}\"\n    \"unauthenticated\" = \"${aws_iam_role.ES_Identity_Pool_Unauthenticated_Role.arn}\"\n  }\n}\nresource \"aws_iam_role\" \"ES_Cognito_Role\" {\n  name               = \"${var.ElasticSearch_Domain_Name}-cognito-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"es.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"ES_Cognito_Policy\" {\n  name   = \"${var.ElasticSearch_Domain_Name}-cognito-policy\"\n  role   = \"${aws_iam_role.ES_Cognito_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"cognito-idp:DescribeUserPool\",\n                \"cognito-idp:CreateUserPoolClient\",\n                \"cognito-idp:DeleteUserPoolClient\",\n                \"cognito-idp:DescribeUserPoolClient\",\n                \"cognito-idp:AdminInitiateAuth\",\n                \"cognito-idp:AdminUserGlobalSignOut\",\n                \"cognito-idp:ListUserPoolClients\",\n                \"cognito-identity:DescribeIdentityPool\",\n                \"cognito-identity:UpdateIdentityPool\",\n                \"cognito-identity:SetIdentityPoolRoles\",\n                \"cognito-identity:GetIdentityPoolRoles\"\n            ],\n            \"Resource\": \"*\"\n        },\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": \"iam:PassRole\",\n            \"Resource\": \"*\",\n            \"Condition\": {\n                \"StringEqualsIfExists\": {\n                    \"iam:PassedToService\": \"cognito-identity.amazonaws.com\"\n                }\n            }\n        }\n    ]\n}\nEOF\n}\n# create cloudwatch event iam role to invoke kinesis data streams\nresource \"aws_iam_role\" \"CWE_Kinesis_Role\" {\n  name               = \"security-hub-to-elasticsearch-event-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"events.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"CWE_Kinesis_Policy\" {\n  name   = \"security-hub-to-elasticsearch-event-policy\"\n  role   = \"${aws_iam_role.CWE_Kinesis_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"kinesis:PutRecord\",\n                \"kinesis:PutRecords\"\n            ],\n            \"Resource\": [\n                \"${aws_kinesis_stream.Security_Hub_Kinesis_Stream.arn}\"\n            ]\n        }\n    ]\n}\nEOF\n}\n# create cloudwatch event that will export all findings from security hub\nresource \"aws_cloudwatch_event_rule\" \"Security_Hub_To_Elastic\" {\n  name          = \"security-hub-to-elasticsearch\"\n  description   = \"Sends all Security Hub findings to Elasticsearch Service\"\n  role_arn      = \"${aws_iam_role.CWE_Kinesis_Role.arn}\"\n  event_pattern = <<PATTERN\n{\n  \"source\": [\n    \"aws.securityhub\"\n  ],\n  \"detail-type\": [\n    \"Security Hub Findings - Imported\"\n  ]\n}\nPATTERN\n}\n# create a cloudwatch event target that will send all security hub findings to a kinesis data stream\nresource \"aws_cloudwatch_event_target\" \"CWE_KinesisDataStream_Target\" {\n  rule      = \"${aws_cloudwatch_event_rule.Security_Hub_To_Elastic.name}\"\n  target_id = \"SendToKDS\"\n  arn       = \"${aws_kinesis_stream.Security_Hub_Kinesis_Stream.arn}\"\n}\n# create kinesis data stream to write security hub findings to firehose delivery stream\nresource \"aws_kinesis_stream\" \"Security_Hub_Kinesis_Stream\" {\n  name                      = \"securityhub-kinesis-stream\"\n  shard_count               = 5\n  retention_period          = 24\n  enforce_consumer_deletion = true\n  encryption_type           = \"KMS\"\n  kms_key_id                = \"alias/aws/kinesis\"\n}\n# create an s3 bucket to receive failed records from kinesis data firehose\nresource \"aws_s3_bucket\" \"Kinesis_Failed_Logs_Bucket\" {\n  bucket_prefix = \"${var.KDF_Bucket_Prefix}\"\n  acl           = \"private\"\n  versioning {\n    enabled = true\n  }\n  server_side_encryption_configuration {\n    rule {\n      apply_server_side_encryption_by_default {\n        sse_algorithm     = \"AES256\"\n      }\n    }\n  }\n  lifecycle_rule {\n    enabled = true\n    expiration {\n      days = 365\n    }\n    noncurrent_version_expiration {\n      days = 365\n    }\n  }\n}\n# create an IAM role and policy that allows kinesis data firehose to interact with\n# elasticsearch and kinesis data streams\nresource \"aws_iam_role\" \"Firehose_Delivery_Role\" {\n  name = \"securityhub-firehose-siem-role\"\n  assume_role_policy = <<EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"firehose.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"sts:ExternalId\":\"${data.aws_caller_identity.current.account_id}\"\n        }\n      }\n    }\n  ]\n}\nEOF\n}\nresource \"aws_iam_role_policy\" \"Firehose_Delivery_Policy\" {\n  name   = \"securityhub-firehose-siem-policy\"\n  role   = \"${aws_iam_role.Firehose_Delivery_Role.id}\"\n  policy = <<EOF\n{\n    \"Version\": \"2012-10-17\",  \n    \"Statement\": [    \n        {      \n            \"Effect\": \"Allow\",      \n            \"Action\": [        \n                \"s3:AbortMultipartUpload\",        \n                \"s3:GetBucketLocation\",        \n                \"s3:GetObject\",\n                \"s3:HeadBucket\",        \n                \"s3:ListBucket\",        \n                \"s3:ListBucketMultipartUploads\",        \n                \"s3:PutObject\"\n            ],      \n            \"Resource\": [        \n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\",\n                \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}/*\"\t\t    \n            ]    \n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"kms:Decrypt\",\n               \"kms:GenerateDataKey\"\n           ],\n           \"Resource\": [\n               \"*\"           \n           ]\n        },\n        {\n           \"Effect\": \"Allow\",\n           \"Action\": [\n               \"es:DescribeElasticsearchDomain\",\n               \"es:DescribeElasticsearchDomains\",\n               \"es:DescribeElasticsearchDomainConfig\",\n               \"es:ESHttpPost\",\n               \"es:ESHttpPut\"\n           ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/*\"\n          ]\n       },\n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"es:ESHttpGet\"\n          ],\n          \"Resource\": [\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_all/_settings\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_cluster/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_mapping/type-name\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_nodes/*/stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/_stats\",\n              \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}/index-name*/_stats\"\n          ]\n       },        \n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"kinesis:DescribeStream\",\n              \"kinesis:GetShardIterator\",\n              \"kinesis:GetRecords\"\n          ],\n          \"Resource\": \"${aws_kinesis_stream.Security_Hub_Kinesis_Stream.arn}\"\n       },\n       {\n          \"Effect\": \"Allow\",\n          \"Action\": [\n              \"logs:PutLogEvents\",\n              \"logs:CreateLogGroup\",\n              \"logs:CreateLogStream\"\n          ],\n          \"Resource\": [\n              \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.arn}*\"\n          ]\n       }\n    ]\n}\nEOF\n}\n# create kiensis data firehose delivery stream that will read from data stream and send findings to elasticsearch\n# will also create an additional cloudwatch log group and log stream for firehose to write error logs to\nresource \"aws_kinesis_firehose_delivery_stream\" \"Security_Hub_SIEM_KDF\" {\n  name        = \"securityhub-siem-deliverystream\"\n  destination = \"elasticsearch\"\n  kinesis_source_configuration {\n      kinesis_stream_arn = \"${aws_kinesis_stream.Security_Hub_Kinesis_Stream.arn}\"\n      role_arn           = \"${aws_iam_role.Firehose_Delivery_Role.arn}\"\n    }\n  s3_configuration {\n    role_arn           = \"${aws_iam_role.Firehose_Delivery_Role.arn}\"\n    bucket_arn         = \"${aws_s3_bucket.Kinesis_Failed_Logs_Bucket.arn}\"\n    buffer_size        = 5\n    buffer_interval    = 60\n    compression_format = \"GZIP\"\n  }\n  elasticsearch_configuration {\n    domain_arn            = \"${aws_elasticsearch_domain.Security_Hub_Elasticsearch_Service.arn}\"\n    role_arn              = \"${aws_iam_role.Firehose_Delivery_Role.arn}\"\n    index_rotation_period = \"${var.ElasticSearch_Rotation_Period}\"\n    index_name            = \"securityhub-findings\"\n    type_name             = \"ASFF\" ## if you use 7.x elasticsearch version, do not specify this variable\n    cloudwatch_logging_options {\n        enabled         = true\n        log_group_name  = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n        log_stream_name = \"sechub-log-fails\"\n    }\n  }\n  depends_on = [\"aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup\"]\n}\nresource \"aws_cloudwatch_log_group\" \"Kinesis_Firehose_Errors_LogsGroup\" {\n  name = \"Firehose/errors\"\n}\nresource \"aws_cloudwatch_log_stream\" \"Kinesis_Firehose_Errors_LogStream\" {\n  name           = \"sechub-log-fails\"\n  log_group_name = \"${aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup.name}\"\n  depends_on     = [\"aws_cloudwatch_log_group.Kinesis_Firehose_Errors_LogsGroup\"]\n}",
        "aws-security-hub-boostrap-and-operationalization/security_services.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n# Enable GuardDuty\nresource \"aws_guardduty_detector\" \"GuardDuty_Detector\" {\n  enable                       = true\n  finding_publishing_frequency = \"${var.GuardDuty_Finding_Publishing_Frequency}\"\n  depends_on                   = [\"aws_securityhub_account.Security_Hub_Enabled\"]\n}\n# Enable Security Hub\nresource \"aws_securityhub_account\" \"Security_Hub_Enabled\" {\n  depends_on = [\"aws_config_configuration_recorder_status.Config_Recorder_Enabled\"]\n}\n# Enable CIS standard\nresource \"aws_securityhub_standards_subscription\" \"Security_Hub_CIS_Standard_Subscription\" {\n  depends_on    = [\"aws_securityhub_account.Security_Hub_Enabled\"]\n  standards_arn = \"arn:aws:securityhub:::ruleset/cis-aws-foundations-benchmark/v/1.2.0\"\n}\n# Enable PCI-DSS standard\nresource \"aws_securityhub_standards_subscription\" \"Security_Hub_PCIDSS_Standard_Subscription\" {\n  depends_on    = [\"aws_securityhub_account.Security_Hub_Enabled\"]\n  standards_arn = \"arn:aws:securityhub:${var.AWS_REGION}::standards/pci-dss/v/3.2.1\"\n}\n# create IAM access analyzer\nresource \"aws_accessanalyzer_analyzer\" \"IAA\" {\n  analyzer_name = \"terraformanalyzer\"\n  depends_on    = [\"aws_securityhub_account.Security_Hub_Enabled\"]\n}\n# Create Inspector assessment that targets all Instances \nresource \"aws_inspector_assessment_target\" \"Inspector_Assessment_Target_All\" {\n  name = \"target-all-instances\"\n}\n# Change rule package Variables dependent on location\nresource \"aws_inspector_assessment_template\" \"Inspector_Assessment_Template\" {\n  name               = \"all-assessments-template\"\n  duration           = 3600\n  target_arn         = \"${aws_inspector_assessment_target.Inspector_Assessment_Target_All.arn}\"\n  rules_package_arns = \"${var.Inspector_Assessment_Rules_Packages_APSoutheast2}\"\n}",
        "aws-security-hub-boostrap-and-operationalization/variables.tf": " # Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n # SPDX-License-Identifier: MIT-0\n #\n # Permission is hereby granted, free of charge, to any person obtaining a copy of this\n # software and associated documentation files (the \"Software\"), to deal in the Software\n # without restriction, including without limitation the rights to use, copy, modify,\n # merge, publish, distribute, sublicense, and/or sell copies of the Software, and to\n # permit persons to whom the Software is furnished to do so.\n #\n # THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\n # INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\n # PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n # HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\n # OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n # SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n######################\n# GLOBAL variables\n######################\nvariable \"AWS_REGION\" {\n  default = \"us-east-1\"\n}\nvariable \"TRUSTED_IP\" {\n  description = \"Used to populate Elasticsearch SourceIP condition and VPC SSH security group\"\n  default     = \"/32\"\n}\n######################\n# config.tf variables\n######################\nvariable \"Config_Bucket_Prefix\" {\n  default = \"config-bucket\"\n}\nvariable \"Config_Delivery_Frequency\" {\n  default = \"One_Hour\"\n}\n#################################\n# security_services.tf variables\n#################################\nvariable \"GuardDuty_Finding_Publishing_Frequency\" {\n  default = \"FIFTEEN_MINUTES\"\n}\n# US East (N. Virginia)\nvariable \"Inspector_Assessment_Rules_Packages_USEast1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:us-east-1:316112463485:rulespackage/0-gEjTy7T7\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:us-east-1:316112463485:rulespackage/0-rExsr2X8\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:us-east-1:316112463485:rulespackage/0-R01qwB5Q\", // AWS Security Best Practices\n   \"arn:aws:inspector:us-east-1:316112463485:rulespackage/0-PmNV0Tcd\", // Network Reachability\n   ]\n}\n# US East (Ohio)\nvariable \"Inspector_Assessment_Rules_Packages_USEast2\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:us-east-2:646659390643:rulespackage/0-JnA8Zp85\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:us-east-2:646659390643:rulespackage/0-m8r61nnh\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:us-east-2:646659390643:rulespackage/0-AxKmMHPX\", // AWS Security Best Practices\n   \"arn:aws:inspector:us-east-2:646659390643:rulespackage/0-cE4kTR30\", // Network Reachability\n   ]\n}\n# US West (N. California)\nvariable \"Inspector_Assessment_Rules_Packages_USWest1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:us-west-1:166987590008:rulespackage/0-TKgzoVOa\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:us-west-1:166987590008:rulespackage/0-xUY8iRqX\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:us-west-1:166987590008:rulespackage/0-TxmXimXF\", // AWS Security Best Practices\n   \"arn:aws:inspector:us-west-1:166987590008:rulespackage/0-byoQRFYm\", // Network Reachability\n  ]\n}\n# US West (Oregon)\nvariable \"Inspector_Assessment_Rules_Packages_USWest2\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:us-west-2:758058086616:rulespackage/0-9hgA516p\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:us-west-2:758058086616:rulespackage/0-H5hpSawc\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:us-west-2:758058086616:rulespackage/0-JJOtZiqQ\", // AWS Security Best Practices\n   \"arn:aws:inspector:us-west-2:758058086616:rulespackage/0-rD1z6dpl\", // Network Reachability\n   ]\n}\n# Asia Pacific (Mumbai)\nvariable \"Inspector_Assessment_Rules_Packages_APSouth1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:ap-south-1:162588757376:rulespackage/0-LqnJE9dO\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:ap-south-1:162588757376:rulespackage/0-PSUlX14m\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:ap-south-1:162588757376:rulespackage/0-fs0IZZBj\", // AWS Security Best Practices\n   \"arn:aws:inspector:ap-south-1:162588757376:rulespackage/0-YxKfjFu1\", // Network Reachability\n  ]\n}\n# Asia Pacific (Seoul)\nvariable \"Inspector_Assessment_Rules_Packages_APNortheast2\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:ap-northeast-2:526946625049:rulespackage/0-PoGHMznc\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:ap-northeast-2:526946625049:rulespackage/0-T9srhg1z\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:ap-northeast-2:526946625049:rulespackage/0-2WRpmi4n\", // AWS Security Best Practices\n   \"arn:aws:inspector:ap-northeast-2:526946625049:rulespackage/0-s3OmLzhL\", // Network Reachability\n  ]\n}\n# Asia Pacific (Sydney)\n\nvariable \"Inspector_Assessment_Rules_Packages_APSoutheast2\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:ap-southeast-2:454640832652:rulespackage/0-D5TGAxiR\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:ap-southeast-2:454640832652:rulespackage/0-Vkd2Vxjq\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:ap-southeast-2:454640832652:rulespackage/0-asL6HRgN\", // AWS Security Best Practices\n   \"arn:aws:inspector:ap-southeast-2:454640832652:rulespackage/0-FLcuV4Gz\", // Network Reachability\n  ]\n}\n# Asia Pacific (Tokyo)\nvariable \"Inspector_Assessment_Rules_Packages_APNortheast1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:ap-northeast-1:406045910587:rulespackage/0-gHP9oWNT\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:ap-northeast-1:406045910587:rulespackage/0-7WNjqgGu\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:ap-northeast-1:406045910587:rulespackage/0-bBUQnxMq\", // AWS Security Best Practices\n   \"arn:aws:inspector:ap-northeast-1:406045910587:rulespackage/0-YI95DVd7\", // Network Reachability\n  ]\n}\n# Europe (Frankfurt)\nvariable \"Inspector_Assessment_Rules_Packages_EUCentral1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:eu-central-1:537503971621:rulespackage/0-wNqHa8M9\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:eu-central-1:537503971621:rulespackage/0-nZrAVuv8\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:eu-central-1:537503971621:rulespackage/0-ZujVHEPB\", // AWS Security Best Practices\n   \"arn:aws:inspector:eu-central-1:537503971621:rulespackage/0-6yunpJ91\", // Network Reachability\n  ]\n}\n# Europe (Ireland)\nvariable \"Inspector_Assessment_Rules_Packages_EUWest1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:eu-west-1:357557129151:rulespackage/0-ubA5XvBh\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:eu-west-1:357557129151:rulespackage/0-sJBhCr0F\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:eu-west-1:357557129151:rulespackage/0-SnojL3Z6\", // AWS Security Best Practices\n   \"arn:aws:inspector:eu-west-1:357557129151:rulespackage/0-SPzU33xe\", // Network Reachability\n  ]\n}\n# Europe (London)\nvariable \"Inspector_Assessment_Rules_Packages_EUWest2\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:eu-west-2:146838936955:rulespackage/0-kZGCqcE1\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:eu-west-2:146838936955:rulespackage/0-IeCjwf1W\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:eu-west-2:146838936955:rulespackage/0-XApUiSaP\", // AWS Security Best Practices\n   \"arn:aws:inspector:eu-west-2:146838936955:rulespackage/0-AizSYyNq\", // Network Reachability\n  ]\n}\n# Europe (Stockholm)\nvariable \"Inspector_Assessment_Rules_Packages_EUNorth1\" {\n  type        = \"list\"\n  description = \"All Inspector Assessment Rules for Target All Group\"\n  default = [\n   \"arn:aws:inspector:eu-north-1:453420244670:rulespackage/0-IgdgIewd\", // NIST Common Vulnerability & Exposures (CVEs)\n   \"arn:aws:inspector:eu-north-1:453420244670:rulespackage/0-Yn8jlX7f\", // CIS OS Security Configuration Benchmark\n   \"arn:aws:inspector:eu-north-1:453420244670:rulespackage/0-HfBQSbSf\", // AWS Security Best Practices\n   \"arn:aws:inspector:eu-north-1:453420244670:rulespackage/0-52Sn74uu\", // Network Reachability\n  ]\n}\n#################################\n# security_hub_siem.tf variables\n#################################\nvariable \"ES_Cognito_User_Pool_Name\" {\n  default = \"elastic-kibanausers\"\n}\nvariable \"ES_Cognito_User_Pool_Domain_Name\" {\n  default = \"\"\n}\nvariable \"ES_Cognito_Identity_Pool_Name\" {\n  default = \"elastickibanaidp\"\n}\nvariable \"ElasticSearch_Domain_Name\" {\n  default = \"securityhub-siem\"\n}\nvariable \"ElasticSearch_Domain_ES_Version\" {\n  default = \"6.8\"\n}\nvariable \"ElasticSearch_Domain_Instance_Type\" {\n  default = \"c4.large.elasticsearch\"\n}\nvariable \"ElasticSearch_Domain_Instance_Count\" {\n  default = \"1\"\n}\nvariable \"KDF_Bucket_Prefix\" {\n  default = \"elastic-kdf-logs-bucket\"\n}\nvariable \"ElasticSearch_Rotation_Period\" {\n  default = \"OneMonth\"\n}\n###########################################\n# cis_baseline_infrastructure.tf variables\n###########################################\nvariable \"AccessLog_Bucket_Prefix\" {\n  default = \"cis-accesslogs-bucket\"\n}\nvariable \"CIS_CloudTrail_Trail_Name\" {\n  default = \"cis-cloudtrail\"\n}\nvariable \"CloudTrail_Bucket_Prefix\" {\n  default = \"cis-cloudtrail-logs-bucket\"\n}\nvariable \"Network_Resource_Count\" {\n  default     = 1\n  description = \"Amount of Network Resources Provisioned e.g. Subnets and Route Tables - Adjust for Regional AZ Count\"\n}\nvariable \"CIS_VPC_CIDR\" {\n  default = \"10.100.0.0/16\"\n}\nvariable \"CIS_VPC_Name_Tag\" {\n  default = \"CIS_VPC\"\n}\n#######################\n# cis_3-x.tf variables\n#######################\nvariable \"CIS_SNS_Prefix\" {\n  default = \"cis-3x-alarms\"\n}\nvariable \"CIS_Metric_Alarm_Namespace\" {\n  default = \"LogMetrics\"\n}\n############################################\n# elasticsearch_siem_extension.tf variables \n############################################\nvariable \"CloudTrail_To_Elastic_Name_Schema\" {\n  default = \"cloudtrail-to-elastic\"\n}\nvariable \"VPCFlowLogs_To_Elastic_Name_Schema\" {\n  default = \"vpc-flowlogs-to-elastic\"\n}"
      }
    },
    "1ddad38ace9fbee0": {
      "hash": "1ddad38ace9fbee0",
      "source_url": "https://github.com/aws-samples/deepseek-using-vllm-on-eks",
      "source_type": "github",
      "discovered_at": "2026-01-15T15:02:36.675144",
      "services": [
        "ecr"
      ],
      "resource_count": 2,
      "name": "deepseek-using-vllm-on-eks",
      "description": "",
      "version": null,
      "skipped": false,
      "skip_reason": null,
      "original_format": null,
      "terraform_files": {
        "helm.tf": "resource \"helm_release\" \"deepseek_gpu\" {\n  count            = var.enable_deep_seek_gpu ? 1 : 0\n  name             = \"deepseek-gpu\"\n  chart            = \"./vllm-chart\"\n  create_namespace = true\n  wait             = false\n  replace          = true\n  namespace        = \"deepseek\"\n\n  values = [\n    <<-EOT\n    nodeSelector:\n      owner: \"data-engineer\"\n      instanceType: \"gpu\"\n    tolerations:\n      - key: \"nvidia.com/gpu\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n    resources:\n      limits:\n        cpu: \"32\"\n        memory: 100G\n        nvidia.com/gpu: \"1\"\n      requests:\n        cpu: \"16\"\n        memory: 30G\n        nvidia.com/gpu: \"1\"\n    command: \"vllm serve deepseek-ai/DeepSeek-R1-Distill-Llama-8B --max_model 2048\"\n\n    livenessProbe:\n      httpGet:\n        path: /health\n        port: 8000\n      initialDelaySeconds: 1800\n      periodSeconds: 10\n\n    readinessProbe:\n      httpGet:\n        path: /health\n        port: 8000\n      initialDelaySeconds: 1800\n      periodSeconds: 5\n\n    EOT\n  ]\n  depends_on = [module.eks, kubernetes_manifest.gpu_nodepool]\n}\n\nresource \"helm_release\" \"deepseek_neuron\" {\n  count            = var.enable_deep_seek_neuron ? 1 : 0\n  name             = \"deepseek-neuron\"\n  chart            = \"./vllm-chart\"\n  create_namespace = true\n  wait             = false\n  replace          = true\n  namespace        = \"deepseek\"\n\n  values = [\n    <<-EOT\n    image:\n      repository: ${aws_ecr_repository.neuron-ecr.repository_url}\n      tag: 0.1\n      pullPolicy: IfNotPresent\n\n    nodeSelector:\n      owner: \"data-engineer\"\n      instanceType: \"neuron\"\n    tolerations:\n      - key: \"aws.amazon.com/neuron\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n\n    command: \"vllm serve deepseek-ai/DeepSeek-R1-Distill-Llama-8B --device neuron --tensor-parallel-size 2 --max-num-seqs 4 --block-size 8 --use-v2-block-manager --max-model-len 2048\"\n\n    env:\n      - name: NEURON_RT_NUM_CORES\n        value: \"2\"\n      - name: NEURON_RT_VISIBLE_CORES\n        value: \"0,1\"\n      - name: VLLM_LOGGING_LEVEL\n        value: \"INFO\"\n\n    resources:\n      limits:\n        cpu: \"30\"\n        memory: 64G\n        aws.amazon.com/neuron: \"1\"\n      requests:\n        cpu: \"30\"\n        memory: 64G\n        aws.amazon.com/neuron: \"1\"\n\n    livenessProbe:\n      httpGet:\n        path: /health\n        port: 8000\n      initialDelaySeconds: 1800\n      periodSeconds: 10\n\n    readinessProbe:\n      httpGet:\n        path: /health\n        port: 8000\n      initialDelaySeconds: 1800\n      periodSeconds: 5\n    EOT\n  ]\n  depends_on = [module.eks, kubernetes_manifest.neuron_nodepool]\n}\n",
        "main.tf": "variable \"enable_deep_seek_gpu\" {\n  description = \"Enable DeepSeek using GPUs\"\n  type        = bool\n  default     = false\n}\n\nvariable \"enable_deep_seek_neuron\" {\n  description = \"Enable DeepSeek using Neuron\"\n  type        = bool\n  default     = false\n}\n\nvariable \"enable_auto_mode_node_pool\" {\n  description = \"Enable EKS AutoMode NodePool\"\n  type        = bool\n  default     = false\n}\n\nlocals {\n  region   = \"us-east-1\"\n  vpc_cidr = \"10.0.0.0/16\"\n  name     = \"eks-automode\"\n  azs      = slice(data.aws_availability_zones.available.names, 0, 3)\n\n  tags = {\n    Blueprint = local.name\n  }\n}\n\n\n# Define the required providers\nprovider \"aws\" {\n  region = local.region # Change to your desired region\n}\n\nprovider \"kubernetes\" {\n  host                   = module.eks.cluster_endpoint\n  cluster_ca_certificate = base64decode(module.eks.cluster_certificate_authority_data)\n\n  exec {\n    api_version = \"client.authentication.k8s.io/v1beta1\"\n    command     = \"aws\"\n    # This requires the awscli to be installed locally where Terraform is executed\n    args = [\"eks\", \"get-token\", \"--cluster-name\", module.eks.cluster_name]\n  }\n}\n\nprovider \"helm\" {\n  kubernetes {\n    host                   = module.eks.cluster_endpoint\n    cluster_ca_certificate = base64decode(module.eks.cluster_certificate_authority_data)\n\n    exec {\n      api_version = \"client.authentication.k8s.io/v1beta1\"\n      command     = \"aws\"\n      # This requires the awscli to be installed locally where Terraform is executed\n      args = [\"eks\", \"get-token\", \"--cluster-name\", module.eks.cluster_name]\n    }\n  }\n}\n\ndata \"aws_availability_zones\" \"available\" {\n  # Do not include local zones\n  filter {\n    name   = \"opt-in-status\"\n    values = [\"opt-in-not-required\"]\n  }\n}\n\n# Use the Terraform VPC module to create a VPC\nmodule \"vpc\" {\n  source  = \"terraform-aws-modules/vpc/aws\"\n  version = \"5.17.0\" # Use the latest version available\n\n  name = \"${local.name}-vpc\"\n  cidr = local.vpc_cidr\n\n  azs             = local.azs\n  private_subnets = [for k, v in local.azs : cidrsubnet(local.vpc_cidr, 4, k)]\n  public_subnets  = [for k, v in local.azs : cidrsubnet(local.vpc_cidr, 8, k + 48)]\n\n  enable_nat_gateway = true\n  single_nat_gateway = true\n\n  public_subnet_tags = {\n    \"kubernetes.io/role/elb\" = 1\n  }\n\n  private_subnet_tags = {\n    \"kubernetes.io/role/internal-elb\" = 1\n  }\n\n  tags = local.tags\n}\n\n# Use the Terraform EKS module to create an EKS cluster\nmodule \"eks\" {\n  source  = \"terraform-aws-modules/eks/aws\"\n  version = \"20.33.1\" # Use the latest version available\n\n  cluster_name    = local.name\n  cluster_version = \"1.31\" # Specify the EKS version you want to use\n\n  cluster_endpoint_public_access           = true\n  enable_irsa                              = true\n  enable_cluster_creator_admin_permissions = true\n\n  cluster_compute_config = {\n    enabled    = true\n    node_pools = [\"general-purpose\"]\n  }\n\n\n  vpc_id     = module.vpc.vpc_id\n  subnet_ids = module.vpc.private_subnets\n\n  tags = local.tags\n}\n\n\nresource \"aws_ecr_repository\" \"chatbot-ecr\" {\n  name                 = \"${local.name}-chatbot\"\n  image_tag_mutability = \"MUTABLE\"\n}\n\nresource \"aws_ecr_repository\" \"neuron-ecr\" {\n  name                 = \"${local.name}-neuron-base\"\n  image_tag_mutability = \"MUTABLE\"\n}\n\n# Outputs\noutput \"configure_kubectl\" {\n  description = \"Configure kubectl: make sure you're logged in with the correct AWS profile and run the following command to update your kubeconfig\"\n  value       = \"aws eks --region ${local.region} update-kubeconfig --name ${module.eks.cluster_name}\"\n}\n\noutput \"ecr_repository_uri\" {\n  value = aws_ecr_repository.chatbot-ecr.repository_url\n}\n\noutput \"ecr_repository_uri_neuron\" {\n  value = aws_ecr_repository.neuron-ecr.repository_url\n}",
        "nodepool_automode.tf": "resource \"kubernetes_manifest\" \"gpu_nodepool\" {\n  count = var.enable_auto_mode_node_pool && var.enable_deep_seek_gpu ? 1 : 0\n  manifest = {\n    apiVersion = \"karpenter.sh/v1\"\n    kind       = \"NodePool\"\n    metadata = {\n      name = \"gpu-nodepool\"\n    }\n    spec = {\n      template = {\n        metadata = {\n          labels = {\n            owner = \"data-engineer\"\n            instanceType = \"gpu\"\n          }\n        }\n        spec = {\n          nodeClassRef = {\n            group = \"eks.amazonaws.com\"\n            kind  = \"NodeClass\"\n            name  = \"default\"\n          }\n          taints = [\n            {\n              key    = \"nvidia.com/gpu\"\n              value  = \"Exists\"\n              effect = \"NoSchedule\"\n            }\n          ]\n          requirements = [\n            {\n              key      = \"eks.amazonaws.com/instance-family\"\n              operator = \"In\"\n              values   = [\"g5\", \"g6\", \"g6e\", \"p5\", \"p4\"]\n            },\n            {\n              key      = \"kubernetes.io/arch\"\n              operator = \"In\"\n              values   = [\"amd64\"]\n            },\n            {\n              key      = \"karpenter.sh/capacity-type\"\n              operator = \"In\"\n              values   = [\"spot\", \"on-demand\"]\n            }\n          ]\n        }\n      }\n      limits = {\n        cpu    = \"1000\"\n        memory = \"1000Gi\"\n      }\n    }\n  }\n\n  depends_on = [module.eks]\n}\n\nresource \"kubernetes_manifest\" \"neuron_nodepool\" {\n  count = var.enable_auto_mode_node_pool && var.enable_deep_seek_neuron ? 1 : 0\n  manifest = {\n    apiVersion = \"karpenter.sh/v1\"\n    kind       = \"NodePool\"\n    metadata = {\n      name = \"neuron-nodepool\"\n    }\n    spec = {\n      template = {\n        metadata = {\n          labels = {\n            owner = \"data-engineer\"\n            instanceType = \"neuron\"\n          }\n        }\n        spec = {\n          nodeClassRef = {\n            group = \"eks.amazonaws.com\"\n            kind  = \"NodeClass\"\n            name  = \"default\"\n          }\n          taints = [\n            {\n              key    = \"aws.amazon.com/neuron\"\n              value  = \"Exists\"\n              effect = \"NoSchedule\"\n            }\n          ]\n          requirements = [\n            {\n              key      = \"eks.amazonaws.com/instance-family\"\n              operator = \"In\"\n              values   = [\"inf2\"]\n            },\n            {\n              key      = \"karpenter.sh/capacity-type\"\n              operator = \"In\"\n              values   = [\"spot\", \"on-demand\"]\n            }\n          ]\n        }\n      }\n      limits = {\n        cpu    = \"1000\"\n        memory = \"1000Gi\"\n      }\n    }\n  }\n\n  depends_on = [module.eks]\n}"
      }
    }
  }
}